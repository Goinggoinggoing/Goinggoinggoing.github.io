

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/logo.png">
  <link rel="icon" href="/img/logo.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#B1A58E">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="æœ‰ä»€ä¹ˆä¸æ‡‚çš„ç›´æ¥é—®gpt ä»€ä¹ˆæ˜¯ç¨‹åº  00 01 10 00 01 10 æºä»£ç è§’åº¦åŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨Cè¯­è¨€å®ç°  çŠ¶æ€ï¼šå†…å­˜ä¸­çš„æ‰€æœ‰ä¸œè¥¿ï¼Œå…¨éƒ¨æ ˆå¸§ ä½¿ç”¨æ ˆæ¨¡æ‹Ÿé€’å½’     äºŒè¿›åˆ¶è§’åº¦ çŠ¶æ€ï¼šå†…å­˜ + å¯„å­˜å™¨ åˆå§‹çŠ¶æ€ï¼š è¿ç§»ï¼šä¸€æ¡01æŒ‡ä»¤  ä»»ä½•çš„ç¨‹åºéƒ½éœ€è¦é€€å‡ºï¼Œä¹Ÿå°±æ˜¯ç»“æŸã€‚å› æ­¤éœ€è¦ç‰¹åˆ«çš„æŒ‡ä»¤ syscall æŠŠç°åœ¨çš„çŠ¶æ€äº¤ç»™æ“ä½œç³»ç»Ÿ ç¨‹åº &#x3D;  æ™®é€šè®¡ç®— + syscall å®ç°ä¸æ“">
<meta property="og:type" content="article">
<meta property="og:title" content="æ“ä½œç³»ç»Ÿ - jyy">
<meta property="og:url" content="http://example.com/2023/05/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%20-%20jyy/index.html">
<meta property="og:site_name" content="Xun&#39;s Blog">
<meta property="og:description" content="æœ‰ä»€ä¹ˆä¸æ‡‚çš„ç›´æ¥é—®gpt ä»€ä¹ˆæ˜¯ç¨‹åº  00 01 10 00 01 10 æºä»£ç è§’åº¦åŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨Cè¯­è¨€å®ç°  çŠ¶æ€ï¼šå†…å­˜ä¸­çš„æ‰€æœ‰ä¸œè¥¿ï¼Œå…¨éƒ¨æ ˆå¸§ ä½¿ç”¨æ ˆæ¨¡æ‹Ÿé€’å½’     äºŒè¿›åˆ¶è§’åº¦ çŠ¶æ€ï¼šå†…å­˜ + å¯„å­˜å™¨ åˆå§‹çŠ¶æ€ï¼š è¿ç§»ï¼šä¸€æ¡01æŒ‡ä»¤  ä»»ä½•çš„ç¨‹åºéƒ½éœ€è¦é€€å‡ºï¼Œä¹Ÿå°±æ˜¯ç»“æŸã€‚å› æ­¤éœ€è¦ç‰¹åˆ«çš„æŒ‡ä»¤ syscall æŠŠç°åœ¨çš„çŠ¶æ€äº¤ç»™æ“ä½œç³»ç»Ÿ ç¨‹åº &#x3D;  æ™®é€šè®¡ç®— + syscall å®ç°ä¸æ“">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404494.png">
<meta property="og:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404496.png">
<meta property="og:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404497.png">
<meta property="og:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404498.png">
<meta property="og:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404499.png">
<meta property="og:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404500.png">
<meta property="og:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404501.png">
<meta property="og:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404502.png">
<meta property="og:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404503.png">
<meta property="og:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404504.png">
<meta property="og:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404505.png">
<meta property="og:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404506.png">
<meta property="og:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404507.png">
<meta property="og:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404509.png">
<meta property="og:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404510.png">
<meta property="og:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404511.png">
<meta property="og:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404512.png">
<meta property="og:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404513.png">
<meta property="og:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404514.png">
<meta property="og:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404515.png">
<meta property="og:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404516.png">
<meta property="og:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404517.png">
<meta property="og:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404518.png">
<meta property="og:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404519.png">
<meta property="article:published_time" content="2023-05-14T12:00:00.000Z">
<meta property="article:modified_time" content="2025-03-10T14:00:27.000Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="è®¡ç®—æœºåŸºç¡€">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404494.png">
  
  
  
  <title>æ“ä½œç³»ç»Ÿ - jyy - Xun&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":false},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"left","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"GEluhFhlvVVyi1wC9RzB0vSk-MdYXbMMI","app_key":"9ng4wvU8n0568liU440awYcT","server_url":"https://proxy.bytewaver.top/proxy/geluhfhl.api.lncldglobal.com","path":"window.location.pathname","ignore_local":true}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 50vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong> </strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>é¦–é¡µ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>å½’æ¡£</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>åˆ†ç±»</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>æ ‡ç­¾</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>å…³äº</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/bg/pink-small.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">æ“ä½œç³»ç»Ÿ - jyy</span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-05-14 20:00" pubdate>
          2023å¹´5æœˆ14æ—¥ æ™šä¸Š
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          9.8k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          82 åˆ†é’Ÿ
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> æ¬¡
        </span>
        
      
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="padding-left: 2rem; margin-right: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>ç›®å½•</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">æ“ä½œç³»ç»Ÿ - jyy</h1>
            
            
              <div class="markdown-body">
                
                <p>æœ‰ä»€ä¹ˆä¸æ‡‚çš„ç›´æ¥é—®gpt</p>
<h3 id="ä»€ä¹ˆæ˜¯ç¨‹åº"><a href="#ä»€ä¹ˆæ˜¯ç¨‹åº" class="headerlink" title="ä»€ä¹ˆæ˜¯ç¨‹åº"></a>ä»€ä¹ˆæ˜¯ç¨‹åº</h3><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404494.png" srcset="/img/loading.gif" lazyload alt="image-20230512154440672" style="zoom: 67%;" />

<p>00 01 10 00 01 10</p>
<h4 id="æºä»£ç è§’åº¦"><a href="#æºä»£ç è§’åº¦" class="headerlink" title="æºä»£ç è§’åº¦"></a>æºä»£ç è§’åº¦</h4><p>åŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨Cè¯­è¨€å®ç°</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404496.png" srcset="/img/loading.gif" lazyload alt="image-20230512155633763"></p>
<p>çŠ¶æ€ï¼šå†…å­˜ä¸­çš„æ‰€æœ‰ä¸œè¥¿ï¼Œå…¨éƒ¨æ ˆå¸§</p>
<p>ä½¿ç”¨æ ˆæ¨¡æ‹Ÿé€’å½’</p>
<img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404497.png" srcset="/img/loading.gif" lazyload alt="image-20230512161116475" style="zoom: 67%;" />



<h4 id="äºŒè¿›åˆ¶è§’åº¦"><a href="#äºŒè¿›åˆ¶è§’åº¦" class="headerlink" title="äºŒè¿›åˆ¶è§’åº¦"></a>äºŒè¿›åˆ¶è§’åº¦</h4><ul>
<li>çŠ¶æ€ï¼šå†…å­˜ + å¯„å­˜å™¨</li>
<li>åˆå§‹çŠ¶æ€ï¼š</li>
<li>è¿ç§»ï¼šä¸€æ¡01æŒ‡ä»¤</li>
</ul>
<p>ä»»ä½•çš„ç¨‹åºéƒ½éœ€è¦é€€å‡ºï¼Œä¹Ÿå°±æ˜¯ç»“æŸã€‚å› æ­¤éœ€è¦ç‰¹åˆ«çš„æŒ‡ä»¤ <code>syscall</code> æŠŠç°åœ¨çš„çŠ¶æ€äº¤ç»™æ“ä½œç³»ç»Ÿ</p>
<p>ç¨‹åº &#x3D;  æ™®é€šè®¡ç®— + <code>syscall</code></p>
<p>å®ç°ä¸æ“ä½œç³»ç»Ÿä¸­åˆ«çš„å¯¹è±¡äº¤äº’</p>
<ul>
<li>è¯»å†™æ–‡ä»¶  å¦‚æœæœ‰æƒé™ï¼Œæ“ä½œç³»ç»ŸæŠŠçŠ¶æ€å†™å…¥ç¨‹åºçš„M, R</li>
<li>æ”¹å˜è¿›ç¨‹ æ€æ­»ç¨‹åº</li>
</ul>
<p>å¦‚ä½•æ„é€ ä¸€ä¸ª<code>printf(&quot;hello world&quot;)</code></p>
<img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404498.png" srcset="/img/loading.gif" lazyload alt="image-20230512171448873" style="zoom:67%;" />



<h4 id="æ“ä½œç³»ç»Ÿ"><a href="#æ“ä½œç³»ç»Ÿ" class="headerlink" title="æ“ä½œç³»ç»Ÿ"></a>æ“ä½œç³»ç»Ÿ</h4><ul>
<li>æ”¶ç¼–äº†æ‰€æœ‰å¯¹è±¡ï¼ˆåŒ…å«ç¨‹åºçŠ¶æ€æœºå’Œæ–‡ä»¶ï¼‰ï¼Œå®ç°éœ¸ä¸»åœ°ä½</li>
<li>ç®¡ç†å¤šä¸ªçŠ¶æ€æœºï¼Œæ ¹æ®æƒé™è®¿é—®ã€‚æ‰“å¼€æ–‡ä»¶ï¼Œå±å¹•æ˜¾ç¤º</li>
</ul>
<p>åœ¨ç¨‹åºçœ¼é‡Œï¼Œæ“ä½œç³»ç»Ÿå°±æ˜¯<code>syscall</code>ï¼Œç¨‹åº &#x3D; (æ™®é€šè®¡ç®— + <code>syscall</code>)  å¦‚ä½•åªå±•ç¤º<code>syscall</code></p>
<ul>
<li><code>strace a.out</code>  å»æ‰è®¡ç®—ï¼Œåªå±•ç¤ºç”¨åˆ°çš„æ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨</li>
</ul>
<p>cè¯­è¨€çš„ç¬¬ä¸€æ¡ç¨‹åºæ˜¯ä»€ä¹ˆï¼Œè°å®šä¹‰çš„ï¼Œèƒ½ä¸èƒ½ä¿®æ”¹</p>
<p>è®¡ç®—æœºæ²¡æœ‰ç„å­¦ï¼Œä¸€åˆ‡éƒ½å»ºç«‹åœ¨ç¡®å®šçš„æœºåˆ¶ä¸Šã€‚bugåªè¦èƒ½å¤ç°ï¼Œå°±èƒ½è§£å†³</p>
<h4 id="Pythonæ“ä½œç³»ç»Ÿ"><a href="#Pythonæ“ä½œç³»ç»Ÿ" class="headerlink" title="Pythonæ“ä½œç³»ç»Ÿ"></a>Pythonæ“ä½œç³»ç»Ÿ</h4><p><strong>æ€è·¯</strong></p>
<ul>
<li>åº”ç”¨ç¨‹åº &#x3D; çº¯ç²¹è®¡ç®—ï¼ˆPython ä»£ç ï¼‰ + <code>syscall</code>ï¼›  			çŠ¶æ€æœº</li>
<li>æ“ä½œç³»ç»Ÿ &#x3D; Python <code>syscall</code>å®ç°ï¼Œæœ‰ â€œå‡æƒ³â€ çš„ I&#x2F;O è®¾å¤‡ï¼›   ç®¡ç†çŠ¶æ€æœº</li>
</ul>
<p>â€‹    æ“ä½œç³»ç»Ÿä¸ºæ–¹æ¡†ï¼Œç¨‹åºä¸ºåœ†åœˆï¼Œæ“ä½œç³»ç»Ÿç®¡ç†å…¨éƒ¨ç¨‹åºï¼Œå¹¶ä¸”ä¼šæä¾›çº¢è‰²çš„<code>syscall</code>æŒ‡ä»¤ã€‚è“è‰²ä¸ºå½“å‰è¿è¡Œç¨‹åº<br>å½“<code>spawn</code>åˆ›å»ºç¨‹åºåï¼Œæ“ä½œç³»ç»Ÿæœ‰äº†é€‰æ‹©ï¼Œåˆ°åº•æ‰§è¡Œå“ªä¸€ä¸ªç¨‹åºå‘¢ï¼Ÿ</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404499.png" srcset="/img/loading.gif" lazyload alt="image-20230527124547932"></p>
<p><strong>å››ä¸ª â€œç³»ç»Ÿè°ƒç”¨â€ API</strong></p>
<ul>
<li><code>choose(xs)</code>: è¿”å› <code>xs</code> ä¸­çš„ä¸€ä¸ªéšæœºé€‰é¡¹ï¼Œçº¯ç²¹çš„è®¡ç®—ä¸èƒ½å®ç°éšæœº</li>
<li><code>write(s)</code>: è¾“å‡ºå­—ç¬¦ä¸² <code>s</code></li>
<li><code>spawn(fn)</code>: åˆ›å»ºä¸€ä¸ªå¯è¿è¡Œçš„çŠ¶æ€æœº <code>fn</code></li>
<li><code>sched()</code>: éšæœºåˆ‡æ¢åˆ°ä»»æ„çŠ¶æ€æœºæ‰§è¡Œï¼ˆè¿™é‡Œæ˜¯ä¸»åŠ¨åˆ‡æ¢ï¼Œå®é™…ä¹Ÿå­˜åœ¨è¢«OSå¼ºåˆ¶åˆ‡æ¢ï¼‰</li>
</ul>
<h5 id="demo-code"><a href="#demo-code" class="headerlink" title="demo-code"></a>demo-code</h5><p>æˆ‘è¿›è¡ŒçŠ¶æ€æœºåˆ‡æ¢ï¼Œè‚¯å®šéœ€è¦ä¿å­˜çŠ¶æ€ï¼ˆå˜é‡å€¼æ˜¯å¤šå°‘ã€pcåœ¨å“ªï¼‰ ï¼š <code>yield</code>  ï¼ˆå®é™…OSç”±ä¸€æ®µæ±‡ç¼–ä»£ç å°†å½“å‰çŠ¶æ€æœº (æ‰§è¡Œæµ) çš„å¯„å­˜å™¨ä¿å­˜åˆ°å†…å­˜ä¸­ï¼‰<br>æ¯ä¸€ä¸ªè¿›ç¨‹åœ¨æ“ä½œç³»ç»Ÿé‡Œè¢«è§†ä¸ºä¸€ä¸ªç”Ÿæˆå™¨</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">OperatingSystem</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;A minimal executable operating system model.&quot;&quot;&quot;</span><br><br>    SYSCALLS = [<span class="hljs-string">&#x27;choose&#x27;</span>, <span class="hljs-string">&#x27;write&#x27;</span>, <span class="hljs-string">&#x27;spawn&#x27;</span>, <span class="hljs-string">&#x27;sched&#x27;</span>]<br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Thread</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;A &quot;freezed&quot; thread state.&quot;&quot;&quot;</span><br><br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, func, *args</span>):<br>            <span class="hljs-variable language_">self</span>._func = func(*args)<br>            <span class="hljs-variable language_">self</span>.retval = <span class="hljs-literal">None</span><br><br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">step</span>(<span class="hljs-params">self</span>):<br>            <span class="hljs-string">&quot;&quot;&quot;Proceed with the thread until its next trap.&quot;&quot;&quot;</span><br>            syscall, args, *_ = <span class="hljs-variable language_">self</span>._func.send(<span class="hljs-variable language_">self</span>.retval)<br>            <span class="hljs-variable language_">self</span>.retval = <span class="hljs-literal">None</span><br>            <span class="hljs-keyword">return</span> syscall, args<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, src</span>):<br>        variables = &#123;&#125;<br>        <span class="hljs-built_in">exec</span>(src, variables)<br>        <span class="hljs-variable language_">self</span>._main = variables[<span class="hljs-string">&#x27;main&#x27;</span>]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>):<br>        threads = [OperatingSystem.Thread(<span class="hljs-variable language_">self</span>._main)]<br>        <span class="hljs-keyword">while</span> threads:  <span class="hljs-comment"># Any thread lives</span><br>            <span class="hljs-keyword">try</span>:<br>                <span class="hljs-keyword">match</span> (t := threads[<span class="hljs-number">0</span>]).step():<br>                    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;choose&#x27;</span>, xs:  <span class="hljs-comment"># Return a random choice</span><br>                        t.retval = random.choice(xs)<br>                    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;write&#x27;</span>, xs:  <span class="hljs-comment"># Write to debug console</span><br>                        <span class="hljs-built_in">print</span>(xs, end=<span class="hljs-string">&#x27;&#x27;</span>)<br>                    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;spawn&#x27;</span>, (fn, args):  <span class="hljs-comment"># Spawn a new thread</span><br>                        threads += [OperatingSystem.Thread(fn, *args)]<br>                    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;sched&#x27;</span>, _:  <span class="hljs-comment"># Non-deterministic schedule</span><br>                        random.shuffle(threads)<br>            <span class="hljs-keyword">except</span> StopIteration:  <span class="hljs-comment"># A thread terminates</span><br>                threads.remove(t)<br>                random.shuffle(threads)  <span class="hljs-comment"># sys_sched()</span><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &lt; <span class="hljs-number">2</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;Usage: <span class="hljs-subst">&#123;sys.argv[<span class="hljs-number">0</span>]&#125;</span> file&#x27;</span>)<br>        exit(<span class="hljs-number">1</span>)<br><br>    src = Path(sys.argv[<span class="hljs-number">1</span>]).read_text()<br>    <span class="hljs-keyword">for</span> syscall <span class="hljs-keyword">in</span> OperatingSystem.SYSCALLS:<br>        src = src.replace(<span class="hljs-string">f&#x27;sys_<span class="hljs-subst">&#123;syscall&#125;</span>&#x27;</span>,        <span class="hljs-comment"># sys_write(...)</span><br>                          <span class="hljs-string">f&#x27;yield &quot;<span class="hljs-subst">&#123;syscall&#125;</span>&quot;, &#x27;</span>)  <span class="hljs-comment">#  -&gt; yield &#x27;write&#x27;, (...)</span><br><br>    OperatingSystem(src).run()<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python">count = <span class="hljs-number">0</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Tprint</span>(<span class="hljs-params">name</span>):<br>    <span class="hljs-keyword">global</span> count<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>        count += <span class="hljs-number">1</span><br>        sys_write(<span class="hljs-string">f&#x27;#<span class="hljs-subst">&#123;count:02&#125;</span> Hello from <span class="hljs-subst">&#123;name&#125;</span><span class="hljs-subst">&#123;i+<span class="hljs-number">1</span>&#125;</span>\n&#x27;</span>)<br>        sys_sched()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    n = sys_choose([<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>])<br>    sys_write(<span class="hljs-string">f&#x27;#Thread = <span class="hljs-subst">&#123;n&#125;</span>\n&#x27;</span>)<br>    <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;ABCDE&#x27;</span>[:n]:<br>        sys_spawn(Tprint, name)<br>    sys_sched()<br></code></pre></td></tr></table></figure>



<h5 id="more"><a href="#more" class="headerlink" title="more"></a>more</h5><p>è¿›ç¨‹ + çº¿ç¨‹ + ç»ˆç«¯ + å­˜å‚¨ (å´©æºƒä¸€è‡´æ€§)</p>
<table>
<thead>
<tr>
<th align="left">ç³»ç»Ÿè°ƒç”¨&#x2F;Linux å¯¹åº”</th>
<th align="left">è¡Œä¸º</th>
</tr>
</thead>
<tbody><tr>
<td align="left">sys_spawn(fn)&#x2F;pthread_create</td>
<td align="left">åˆ›å»ºä» fn å¼€å§‹æ‰§è¡Œçš„çº¿ç¨‹</td>
</tr>
<tr>
<td align="left">sys_fork()&#x2F;fork</td>
<td align="left">åˆ›å»ºå½“å‰çŠ¶æ€æœºçš„å®Œæ•´å¤åˆ¶</td>
</tr>
<tr>
<td align="left">sys_sched()&#x2F;å®šæ—¶è¢«åŠ¨è°ƒç”¨</td>
<td align="left">åˆ‡æ¢åˆ°éšæœºçš„çº¿ç¨‹&#x2F;è¿›ç¨‹æ‰§è¡Œ</td>
</tr>
<tr>
<td align="left">sys_choose(xs)&#x2F;rand</td>
<td align="left">è¿”å›ä¸€ä¸ª xs ä¸­çš„éšæœºçš„é€‰æ‹©</td>
</tr>
<tr>
<td align="left">sys_write(s)&#x2F;printf</td>
<td align="left">å‘è°ƒè¯•ç»ˆç«¯è¾“å‡ºå­—ç¬¦ä¸² s</td>
</tr>
<tr>
<td align="left">sys_bread(k)&#x2F;read</td>
<td align="left">è¯»å–è™šæ‹Ÿè®¾ç£ç›˜å— ï¿½<em>k</em> çš„æ•°æ®</td>
</tr>
<tr>
<td align="left">sys_bwrite(k, v)&#x2F;write</td>
<td align="left">å‘è™šæ‹Ÿç£ç›˜å— ï¿½<em>k</em> å†™å…¥æ•°æ® ï¿½<em>v</em></td>
</tr>
<tr>
<td align="left">sys_sync()&#x2F;sync</td>
<td align="left">å°†æ‰€æœ‰å‘è™šæ‹Ÿç£ç›˜çš„æ•°æ®å†™å…¥è½ç›˜</td>
</tr>
<tr>
<td align="left">sys_crash()&#x2F;é•¿æŒ‰ç”µæºæŒ‰é”®</td>
<td align="left">æ¨¡æ‹Ÿç³»ç»Ÿå´©æºƒ</td>
</tr>
</tbody></table>
<p><code>mosaic.py</code>ï¼š500è¡Œæ“ä½œç³»ç»Ÿã€‚è¿˜å®ç°äº†æ‰“å°æ¯ä¸€æ­¥çš„çŠ¶æ€</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python">T = <span class="hljs-number">3</span><br>n = <span class="hljs-number">3</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Tsum</span>( ):<br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):<br>        tmp = heap.x<br>        tmp += <span class="hljs-number">1</span><br>        sys_sched()<br>        heap.x = tmp<br>        sys_sched()  <span class="hljs-comment"># æ²¡æœ‰è¿™ä¸€æ­¥, æœ€å°ä¸º n=3  æ·»åŠ åä¸º2</span><br>    heap.done += <span class="hljs-number">1</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    heap.x = <span class="hljs-number">0</span><br>    heap.done = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(T):<br>    	sys_spawn(Tsum)<br>    <span class="hljs-keyword">while</span> heap.done != T:<br>    	sys_sched()<br>    sys_write(<span class="hljs-string">f&#x27;SUM = <span class="hljs-subst">&#123;heap.x&#125;</span>&#x27;</span>)<br></code></pre></td></tr></table></figure>

<p>ä¸ç¡®å®šæ€§å‘ç”Ÿåœ¨<code>sys_sched()</code>ï¼Œ <code>--check</code> éå†æ‰€æœ‰ç­”æ¡ˆ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">Tsum</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++) &#123;<br>    <span class="hljs-type">int</span> tmp = sum;<br>    tmp++;<br>    <span class="hljs-comment">// å‡è®¾æ­¤æ—¶å¯èƒ½å‘ç”Ÿè¿›ç¨‹/çº¿ç¨‹åˆ‡æ¢</span><br>    sum = tmp;<br>    <span class="hljs-comment">// å‡è®¾æ­¤æ—¶å¯èƒ½å‘ç”Ÿè¿›ç¨‹/çº¿ç¨‹åˆ‡æ¢  æ²¡æœ‰è¿™ä¸ªæœ€å°å€¼ä¸ºn</span><br>  &#125;<br>&#125;<br>Tä¸ªç¨‹åºæ‰§è¡Œnæ¬¡ï¼Œ[<span class="hljs-number">2</span>~n*T]<br></code></pre></td></tr></table></figure>



<h2 id="å¹¶å‘"><a href="#å¹¶å‘" class="headerlink" title="å¹¶å‘"></a>å¹¶å‘</h2><h3 id="å¤šå¤„ç†å™¨ç¼–ç¨‹"><a href="#å¤šå¤„ç†å™¨ç¼–ç¨‹" class="headerlink" title="å¤šå¤„ç†å™¨ç¼–ç¨‹"></a><a target="_blank" rel="noopener" href="http://jyywiki.cn/OS/2022/slides/3.slides">å¤šå¤„ç†å™¨ç¼–ç¨‹</a></h3><p><strong>1.æ”¾å¼ƒåŸå­æ€§</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> balance = <span class="hljs-number">100</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">Alipay_withdraw</span><span class="hljs-params">(<span class="hljs-type">int</span> amt)</span> &#123;<br>  <span class="hljs-keyword">if</span> (balance &gt;= amt) &#123;<br>    balance -= amt;<br>    <span class="hljs-keyword">return</span> SUCCESS;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">return</span> FAIL;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; N; i++) sum++;<br></code></pre></td></tr></table></figure>

<p><code>printf(&quot;a&quot;) </code>ä¸ºä»€ä¹ˆä¸ä¼šæŠ¥é”™ï¼Ÿå¸¦äº†é”</p>
<p>äº’æ–¥å’ŒåŸå­æ€§æ˜¯æœ¬å­¦æœŸçš„é‡è¦ä¸»é¢˜</p>
<p> <strong>2.é¡ºåºä¸§å¤±</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">-O1: R[eax] = sum; R[eax] += N; sum = R[eax]<br>    O1ä¿è¯æœ€ç»ˆä¸€è‡´ï¼Œå¦‚æœè¦å†™å…¥å¤šæ¬¡ï¼Œç›´æ¥ä¸€æ¬¡æ€§å†™å…¥<br>    æœ€ç»ˆè¯»å‡º<span class="hljs-number">100000000</span><br>    <br>-O2: sum += N;  <span class="hljs-number">200000000</span><br>    <br>å¦ä¸€ä¸ªä¾‹å­ï¼š ç³»ç»Ÿé»˜è®¤doneä¸ä¼šæ”¹å˜äº†<br>    <span class="hljs-keyword">while</span> (!done);<br>    <span class="hljs-comment">// would be optimized to</span><br>    <span class="hljs-keyword">if</span> (!done) <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure>



<p><strong>3.ä¸§å¤±å¯è§æ€§</strong></p>
<p>ç†è®ºä¸Šè¾“å‡º 01 10 11, ä½†å…¶å®00ä¹Ÿæœ‰è¾“å‡º</p>
<p>å¤„ç†å™¨ä¹Ÿæ˜¯ä¸€ä¸ªç¼–è¯‘å™¨ï¼Œä¸€æ¡æŒ‡ä»¤æ‹†åˆ†å¤šä¸ªuops</p>
<p>å¦‚æœæƒ³å†™å…¥xæ—¶æœªå‘½ä¸­ï¼Œprintå°±å¯ä»¥å…ˆæ‰§è¡Œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> x = <span class="hljs-number">0</span>, y = <span class="hljs-number">0</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">T1</span><span class="hljs-params">()</span> &#123;<br>  x = <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span><span class="hljs-params">(<span class="hljs-string">&quot;&quot;</span> : : <span class="hljs-string">&quot;memory&quot;</span>)</span>; <span class="hljs-comment">// compiler barrier</span><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;y = %d\n&quot;</span>, y);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">T2</span><span class="hljs-params">()</span> &#123;<br>  y = <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span><span class="hljs-params">(<span class="hljs-string">&quot;&quot;</span> : : <span class="hljs-string">&quot;memory&quot;</span>)</span>; <span class="hljs-comment">// compiler barrier</span><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;x = %d\n&quot;</span>, x);<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="ç†è§£å¹¶å‘ç¨‹åºæ‰§è¡Œ"><a href="#ç†è§£å¹¶å‘ç¨‹åºæ‰§è¡Œ" class="headerlink" title="ç†è§£å¹¶å‘ç¨‹åºæ‰§è¡Œ"></a><a target="_blank" rel="noopener" href="http://jyywiki.cn/OS/2022/slides/4.slides">ç†è§£å¹¶å‘ç¨‹åºæ‰§è¡Œ</a></h3><p>åœ¨<strong>å…±äº«å†…å­˜</strong>å®ç°å¹¶å‘æ—¶ï¼Œä¸€ä¸ªåä¾‹   <code>get set</code>ä¸æ˜¯åŸå­æ“ä½œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> locked = UNLOCK;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">critical_section</span><span class="hljs-params">()</span> &#123;<br>retry:<br>  <span class="hljs-keyword">if</span> (locked != UNLOCK) &#123;<br>    <span class="hljs-keyword">goto</span> retry;<br>  &#125;<br>  locked = LOCK;<br><br>  <span class="hljs-comment">// critical section</span><br><br>  locked = UNLOCK;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="Peterson"><a href="#Peterson" class="headerlink" title="Peterson"></a>Peterson</h4><p>æ£‹å­ä»£è¡¨ï¼šæˆ‘æƒ³ä¸Šå•æ‰€ï¼›é—¨ä¸Šè´´çš„äººä»£è¡¨ç€ï¼šè°èƒ½ä¸Šå•æ‰€</p>
<img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404500.png" srcset="/img/loading.gif" lazyload alt="image-20230514163743735" style="zoom:67%;" />

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">int</span> x = <span class="hljs-number">0</span>, y = <span class="hljs-number">0</span>, turn = A;<br>void TA() &#123;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>/* PC=<span class="hljs-number">1</span> */  x = <span class="hljs-number">1</span>;<br>/* PC=<span class="hljs-number">2</span> */  turn = B;<br>/* PC=<span class="hljs-number">3</span> */  <span class="hljs-keyword">while</span> (y &amp;&amp; turn == B) ;<br>            critical_section();<br>/* PC=<span class="hljs-number">4</span> */  x = <span class="hljs-number">0</span>; &#125; &#125;<br>void TB() &#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>/* PC=<span class="hljs-number">1</span> */  y = <span class="hljs-number">1</span>;<br>/* PC=<span class="hljs-number">2</span> */  turn = A;<br>/* PC=<span class="hljs-number">3</span> */  <span class="hljs-keyword">while</span> (x &amp;&amp; turn == A) ;<br>            critical_section();<br>/* PC=<span class="hljs-number">4</span> */  y = <span class="hljs-number">0</span>; &#125; &#125;<br></code></pre></td></tr></table></figure>

<p>è¯æ˜æ­£ç¡®æ€§ï¼šç›´æ¥ç”»å‡ºçŠ¶æ€æœºè¡¨è¾¾å‡ºå…¨éƒ¨çŠ¶æ€ã€‚</p>
<h4 id="Model-Checker"><a href="#Model-Checker" class="headerlink" title="Model Checker"></a>Model Checker</h4><p>å¹¶å‘ç¨‹åº &#x3D; çŠ¶æ€æœºï¼Œç”»å‡ºçŠ¶æ€æœºå°±å¯ä»¥çŸ¥é“å¹¶å‘ç¨‹åºæœ‰æ²¡æœ‰é”™</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Mutex</span>:<br>    locked = <span class="hljs-string">&#x27;&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">T1</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">yield</span> checkpoint()<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            <span class="hljs-keyword">yield</span> checkpoint()<br>            <span class="hljs-keyword">while</span> <span class="hljs-variable language_">self</span>.locked == <span class="hljs-string">&#x27;ğŸ”’&#x27;</span>:<br>                <span class="hljs-keyword">yield</span> checkpoint()<br>                <span class="hljs-keyword">pass</span><br>            <span class="hljs-keyword">yield</span> checkpoint()<br>            <span class="hljs-variable language_">self</span>.locked = <span class="hljs-string">&#x27;ğŸ”’&#x27;</span><br>            ...<br></code></pre></td></tr></table></figure>

<p>ä½¿ç”¨ç¨‹åºå»éå†å‡ºå…¨éƒ¨çš„çŠ¶æ€  Model Checker</p>
<p>æ²¡æœ‰å·¥å…·ï¼ˆç¼–ç¨‹ã€æµ‹è¯•ã€è°ƒè¯•ï¼‰ï¼Œä¸åšç³»ç»Ÿ</p>
<h3 id="äº’æ–¥"><a href="#äº’æ–¥" class="headerlink" title="äº’æ–¥"></a><a target="_blank" rel="noopener" href="http://jyywiki.cn/OS/2022/slides/5.slides">äº’æ–¥</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>  ...<br>&#125; <span class="hljs-type">lock_t</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">(<span class="hljs-type">lock_t</span> *lk)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">(<span class="hljs-type">lock_t</span> *lk)</span>;<br></code></pre></td></tr></table></figure>

<p>è¿˜æ˜¯åŸæ¥éš¾ç‚¹ï¼š<strong>get set éåŸå­</strong></p>
<h4 id="è‡ªæ—‹é”-spin-lock"><a href="#è‡ªæ—‹é”-spin-lock" class="headerlink" title="è‡ªæ—‹é” spin lock"></a>è‡ªæ—‹é” spin lock</h4><p><strong>ç¡¬ä»¶</strong>èƒ½ä¸ºæˆ‘ä»¬æä¾›ä¸€æ¡ â€œç¬é—´å®Œæˆâ€ çš„è¯» + å†™æŒ‡ä»¤</p>
<p> <code>xchg dest, src</code>  åŸå­çš„å®ç°äº¤æ¢æ•°æ®ï¼Œå¹¶è¿”å›åŸæ¥çš„å€¼ã€‚ è¿™æ ·å°±å¯ä»¥å®ç°ä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´çš„é”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">xchg</span><span class="hljs-params">(<span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> *addr, <span class="hljs-type">int</span> newval)</span> &#123;<br>  <span class="hljs-type">int</span> result;<br>  <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span> <span class="hljs-params">(<span class="hljs-string">&quot;lock xchg %0, %1&quot;</span></span><br><span class="hljs-params">    : <span class="hljs-string">&quot;+m&quot;</span>(*addr), <span class="hljs-string">&quot;=a&quot;</span>(result) : <span class="hljs-string">&quot;1&quot;</span>(newval))</span>;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br><br><span class="hljs-type">int</span> locked = <span class="hljs-number">0</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> &#123; <span class="hljs-keyword">while</span> (xchg(&amp;locked, <span class="hljs-number">1</span>)) ; &#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> &#123; xchg(&amp;locked, <span class="hljs-number">0</span>); &#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>å¤„ç†å™¨ä¿è¯ï¼Œå¸¦lockçš„æŒ‡ä»¤å¯ä»¥é”å®šæ€»çº¿ï¼Œxchgé»˜è®¤å¸¦lock</li>
<li>ä¸¤ä¸ªcpuå…±äº«å†…å­˜æ—¶ï¼Œå¸¦lockæŒ‡ä»¤ä¼šé”ä½memory ï¼Œç¡¬ä»¶å®ç°ï¼Œä¸€ä¸ªbitå®ç°bus lock</li>
<li>cpuæœ‰ç¼“å­˜L1ï¼Œå¦‚ä½•ä¿è¯ç¼“å­˜ä¸€è‡´ã€‚å½“ä¸€ä¸ªcpué”å®šmemoryæ—¶ï¼Œéœ€è¦æŠŠåˆ«çš„cpuçš„ç¼“å­˜éƒ½å‰”é™¤</li>
</ul>
<p><code>Load-Reserved/Store-Conditional</code>ï¼Œç¡¬ä»¶é‡Œä¼šå®ç°</p>
<p>Compare-and-Swapï¼šä¹è§‚é”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">cas</span><span class="hljs-params">(<span class="hljs-type">int</span> *addr, <span class="hljs-type">int</span> cmp_val, <span class="hljs-type">int</span> new_val)</span> &#123;   <br>  <span class="hljs-type">int</span> old_val = *addr;<br>  <span class="hljs-keyword">if</span> (old_val == cmp_val) &#123;<br>    *addr = new_val; <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>; &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>ç¼ºé™·</strong>ï¼šæœªè·å¾—é”çš„çº¿ç¨‹åœ¨ç©ºè½¬ï¼Œç”šè‡³è·å–é”çš„çº¿ç¨‹è¢«OSåˆ‡æ¢äº†ï¼Œæ‰€ä»¥éœ€è¦<strong>ä¸æ‹¥å µæ—¶</strong>ä½¿ç”¨</p>
<p>æ“ä½œç³»ç»Ÿå†…éƒ¨è‡ªå·±ä½¿ç”¨ï¼šæ“ä½œç³»ç»Ÿå†…æ ¸çš„å¹¶å‘æ•°æ®ç»“æ„ (çŸ­ä¸´ç•ŒåŒº)ï¼›å…³ä¸­æ–­</p>
<h4 id="äº’æ–¥é”-Mutex-Lock"><a href="#äº’æ–¥é”-Mutex-Lock" class="headerlink" title="äº’æ–¥é”  Mutex Lock"></a>äº’æ–¥é”  Mutex Lock</h4><p>ä¸å…¶å¹²ç­‰ï¼Œä¸å¦‚æŠŠcpuè®©ç»™åˆ«çš„çº¿ç¨‹æ‰§è¡Œï¼Œ<strong>é˜»å¡</strong></p>
<p>æŠŠé”çš„å®ç°æ”¾åˆ°<strong>æ“ä½œç³»ç»Ÿ</strong>é‡Œå°±å¥½ï¼</p>
<ul>
<li><pre><code class="c">syscall(SYSCALL_lock, &amp;lk); // è¯•å›¾è·å¾— `lk`ï¼Œä½†å¦‚æœå¤±è´¥ï¼Œå°±åˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs scss"><br>- ```c<br>  <span class="hljs-built_in">syscall</span>(SYSCALL_unlock, &amp;lk); <span class="hljs-comment">// é‡Šæ”¾ `lk`ï¼Œå¦‚æœæœ‰ç­‰å¾…é”çš„çº¿ç¨‹å°±å”¤é†’</span><br></code></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<p>æœªå¾—åˆ°é”ä¼šè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œé‡Šæ”¾é”æ—¶OSä¼šå–å‡ºç­‰å¾…é˜Ÿåˆ—ä¸­ä¸€ä¸ªçº¿ç¨‹ï¼Œ<strong>OSä½¿ç”¨è‡ªæ—‹é”</strong>ç¡®ä¿è‡ªå·±å¤„ç†è¿‡ç¨‹æ˜¯åŸå­çš„</p>
<p>ä¸Šé”å¤±è´¥ä¼šç¡çœ ï¼Œä¸å ç”¨CPUï¼Œä½†ä¸ç®¡æœ‰æ²¡æœ‰ç«äº‰éƒ½éœ€è¦è¿›å‡ºå†…æ ¸ç³»ç»Ÿè°ƒç”¨ï¼Œå¸¦æ¥ä¸€å®šçš„å¼€é”€</p>
<h4 id="Futex-Spin-Mutex"><a href="#Futex-Spin-Mutex" class="headerlink" title="Futex &#x3D; Spin + Mutex"></a>Futex &#x3D; Spin + Mutex</h4><p><code>Fast Userspace muTexes</code>ï¼Œæ— ç«äº‰æƒ…å†µä¸‹ï¼Œèƒ½å¤Ÿé¿å…ç³»ç»Ÿè°ƒç”¨çš„å¼€é”€</p>
<p><strong>1.è‡ªæ—‹é”</strong> (çº¿ç¨‹ç›´æ¥å…±äº« locked)</p>
<ul>
<li>æ›´å¿«çš„ fast path<ul>
<li>xchg æˆåŠŸ â†’ ç«‹å³è¿›å…¥ä¸´ç•ŒåŒºï¼Œå¼€é”€å¾ˆå°</li>
</ul>
</li>
<li>æ›´æ…¢çš„ slow path<ul>
<li>xchg å¤±è´¥ â†’ æµªè´¹ CPU è‡ªæ—‹ç­‰å¾…</li>
</ul>
</li>
</ul>
<p><strong>2.ç¡çœ é”</strong> (é€šè¿‡ç³»ç»Ÿè°ƒç”¨è®¿é—® locked)</p>
<ul>
<li>æ›´å¿«çš„ slow path<ul>
<li>ä¸Šé”å¤±è´¥çº¿ç¨‹ä¸å†å ç”¨ CPU</li>
</ul>
</li>
<li>æ›´æ…¢çš„ fast path<ul>
<li>å³ä¾¿ä¸Šé”æˆåŠŸä¹Ÿéœ€è¦è¿›å‡ºå†…æ ¸ (syscall)</li>
</ul>
</li>
</ul>
<p><strong>3.èåˆ</strong>ï¼šå…ˆåŸå­æŒ‡ä»¤ä¸Šé”ï¼Œå¤±è´¥åç³»ç»Ÿè°ƒç”¨ç¡çœ </p>
<p>çº¿ç¨‹åº“çš„é”å°±æ˜¯è¿™æ ·çš„é”ï¼Œä½†è¿˜æœ‰å¾ˆå¤šçš„<strong>ä¼˜åŒ–</strong>ä»¥å‡å°‘ç³»ç»Ÿè°ƒç”¨</p>
<p>codeï¼šKernelä¸ºæ“ä½œç³»ç»Ÿéœ€è¦åšçš„ï¼Œè¿™é‡Œä½¿ç”¨whileæ¨¡æ‹Ÿ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Futex</span>:<br>    locked, waits = <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span><br>	<span class="hljs-comment"># Model Checkerä¼šæŒ‰è¡Œæ‰§è¡Œï¼Œæ‰€ä»¥è¿™ä¼šè¢«è§†ä¸ºä¸€ä¸ªåŸå­æ“ä½œ</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">tryacquire</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.locked:<br>            <span class="hljs-comment"># Test-and-set (cmpxchg)</span><br>            <span class="hljs-comment"># Same effect, but more efficient than xchg</span><br>            <span class="hljs-variable language_">self</span>.locked = <span class="hljs-string">&#x27;ğŸ”’&#x27;</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;ğŸ”’&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">release</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.waits:<br>            <span class="hljs-variable language_">self</span>.waits = <span class="hljs-variable language_">self</span>.waits[<span class="hljs-number">1</span>:]<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-variable language_">self</span>.locked = <span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-meta">    @thread</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">t1</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.tryacquire() == <span class="hljs-string">&#x27;ğŸ”’&#x27;</span>:     <span class="hljs-comment"># User</span><br>                <span class="hljs-variable language_">self</span>.waits = <span class="hljs-variable language_">self</span>.waits + <span class="hljs-string">&#x27;1&#x27;</span> <span class="hljs-comment"># Kernel</span><br>                <span class="hljs-keyword">while</span> <span class="hljs-string">&#x27;1&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.waits:      <span class="hljs-comment"># Kernel å®é™…ä¸Šè¿™é‡Œå·²ç»è¢«oså‰¥å¤ºäº†</span><br>                    <span class="hljs-keyword">pass</span><br>            cs = <span class="hljs-literal">True</span>                         <span class="hljs-comment"># User</span><br>            <span class="hljs-keyword">del</span> cs                            <span class="hljs-comment"># User</span><br>            <span class="hljs-variable language_">self</span>.release()                    <span class="hljs-comment"># Kernel</span><br><br><span class="hljs-meta">    @thread</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">t2</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.tryacquire() == <span class="hljs-string">&#x27;ğŸ”’&#x27;</span>:<br>                <span class="hljs-variable language_">self</span>.waits = <span class="hljs-variable language_">self</span>.waits + <span class="hljs-string">&#x27;2&#x27;</span><br>                <span class="hljs-keyword">while</span> <span class="hljs-string">&#x27;2&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.waits:<br>                    <span class="hljs-keyword">pass</span><br>            cs = <span class="hljs-literal">True</span><br>            <span class="hljs-keyword">del</span> cs<br>            <span class="hljs-variable language_">self</span>.release()<br></code></pre></td></tr></table></figure>

<p>Fast&#x2F;slow paths:æ€§èƒ½ä¼˜åŒ–çš„é€”å¾„</p>
<h3 id="åŒæ­¥"><a href="#åŒæ­¥" class="headerlink" title="åŒæ­¥"></a><a target="_blank" rel="noopener" href="http://jyywiki.cn/OS/2022/slides/6.slides">åŒæ­¥</a></h3><p>æœ‰äº†åŸºæœ¬çš„äº’æ–¥é”ï¼Œç°åœ¨éœ€è¦é€šè¿‡ä»–å®ç°ä¸€äº›çº¿ç¨‹é—´çš„åŒæ­¥æœºåˆ¶ã€‚æœ‰é”æ—¶é»˜è®¤ä½¿ç”¨<code>Futex</code></p>
<p>çº¿ç¨‹åŒæ­¥ï¼šå…±åŒè¾¾åˆ°äº’ç›¸å·²çŸ¥çš„çŠ¶æ€</p>
<p>ç”Ÿäº§è€…æ¶ˆè´¹è€…(è§£å†³å¹¶å‘çš„ä¸‡èƒ½é’¥åŒ™)ï¼šç­‰ä»·äºæ‰“å°å·¦å³æ‹¬å·ï¼Œå·¦æ‹¬å·å¾€é˜Ÿåˆ—åŠ èµ„æºï¼Œå³æ‹¬å·æ¶ˆè´¹èµ„æº</p>
<p><strong>è‡ªæ—‹é”ã€äº’æ–¥é”ã€æ¡ä»¶å˜é‡ã€ä¿¡å·é‡ã€ç®¡é“(é€šä¿¡)</strong></p>
<h4 id="äº’æ–¥é”"><a href="#äº’æ–¥é”" class="headerlink" title="äº’æ–¥é”"></a>äº’æ–¥é”</h4><p>countè®¡æ•°å·¦æ‹¬å·ï¼Œæ˜¯å…±äº«èµ„æºéœ€è¦äº’æ–¥ï¼Œä½¿ç”¨<code>spin lock</code>å®ç°äº’æ–¥è®¿é—®countï¼Œå¹¶ä¸”å¦‚æœä¸ç¬¦åˆæ¡ä»¶å°±åå¤è¯¢é—®<br>ä½¿ç”¨ç®¡é“è¾“å…¥åˆ°pythonç¨‹åºè¿›è¡Œæ£€æŸ¥</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">int</span> n, count = <span class="hljs-number">0</span>;<br>mutex_t lk = MUTEX_INIT();<br><br>void Tproduce() &#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>retry:<br>    mutex_lock(&amp;lk);<br>    <span class="hljs-keyword">if</span> (count == n) &#123;<br>      mutex_unlock(&amp;lk);<br>      goto retry;<br>    &#125;<br>    count++;<br>    printf(<span class="hljs-string">&quot;(&quot;</span>);<br>    mutex_unlock(&amp;lk);<br>  &#125;<br>&#125;<br><br>void Tconsume() &#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>retry:<br>    mutex_lock(&amp;lk);<br>    <span class="hljs-keyword">if</span> (count == <span class="hljs-number">0</span>) &#123;<br>      mutex_unlock(&amp;lk);<br>      goto retry;<br>    &#125;<br>    count--;<br>    printf(<span class="hljs-string">&quot;)&quot;</span>);<br>    mutex_unlock(&amp;lk);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="ä¸‡èƒ½çš„æ¡ä»¶å˜é‡"><a href="#ä¸‡èƒ½çš„æ¡ä»¶å˜é‡" class="headerlink" title="ä¸‡èƒ½çš„æ¡ä»¶å˜é‡"></a>ä¸‡èƒ½çš„æ¡ä»¶å˜é‡</h4><p>æˆ‘å¸Œæœ›ä¸è¦å¾ªç¯ï¼Œåœ¨ä¸æ»¡è¶³æ—¶è¿›è¡Œsleep</p>
<p>æ¡ä»¶å˜é‡ APIï¼š<strong>åœ¨ä¸ç¬¦åˆæŸæ¡ä»¶æ—¶ï¼Œç­‰å¾…åˆ«äººé€šè¿‡cvå”¤é†’æˆ‘</strong>  cvæ˜¯ç¨‹åºé—´çš„æš—å·  éœ€è¦è®¿é—®å…±äº«æ¡ä»¶å½“ç„¶è¦åŠ é”</p>
<ul>
<li>wait(cv, mutex) ğŸ’¤  <code>release(mutex)ã€sleep</code><ul>
<li>è°ƒç”¨æ—¶å¿…é¡»ä¿è¯å·²ç»è·å¾— mutex</li>
<li>é†’æ¥æ—¶éœ€è¦è·å–mutex</li>
</ul>
</li>
<li>signal&#x2F;notify(cv) ğŸ’¬ ç§ä¿¡ï¼šèµ°èµ·<ul>
<li>å¦‚æœæœ‰çº¿ç¨‹æ­£åœ¨ç­‰å¾… cvï¼Œåˆ™å”¤é†’å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹</li>
</ul>
</li>
<li>broadcast&#x2F;notifyAll(cv) ğŸ“£ æ‰€æœ‰äººï¼šèµ°èµ·<ul>
<li>å”¤é†’å…¨éƒ¨æ­£åœ¨ç­‰å¾… cv çš„çº¿ç¨‹</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">Tproduce</span><span class="hljs-params">()</span> &#123;<br>  mutex_lock(&amp;lk);<br>  <span class="hljs-keyword">if</span> (count == n) cond_wait(&amp;cv, &amp;lk); <span class="hljs-comment">// ç¡çœ å‰é‡Šæ”¾é”ï¼›åœ¨å”¤é†’åï¼Œä¼šé‡æ–°è·å–é”</span><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;(&quot;</span>); count++; cond_signal(&amp;cv);<br>  mutex_unlock(&amp;lk);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Tconsume</span><span class="hljs-params">()</span> &#123;<br>  mutex_lock(&amp;lk);<br>  <span class="hljs-keyword">if</span> (count == <span class="hljs-number">0</span>) cond_wait(&amp;cv, &amp;lk);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;)&quot;</span>); count--; cond_signal(&amp;cv);<br>  mutex_unlock(&amp;lk);<br>&#125;<br><br>ä»£ç æœ‰é—®é¢˜ï¼Œå› ä¸ºæ¶ˆè´¹è€…cond_signal(&amp;cv)æ—¶ä¼šå”¤é†’æ¶ˆè´¹è€…ï¼Œå› æ­¤éœ€è¦ä¸¤ä¸ªæ¡ä»¶å˜é‡åˆ†åˆ«ç”¨æ¥å”¤é†’Pã€C<br>æˆ–è€…æˆ‘ç›´æ¥boradcastå”¤é†’å…¨éƒ¨ï¼Œä½†<span class="hljs-keyword">if</span>æ£€æµ‹æ”¹æˆ<span class="hljs-keyword">while</span>å¾ªç¯<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ProducerConsumer</span>:<br>    locked, count, log, waits = <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">tryacquire</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.locked, seen = <span class="hljs-string">&#x27;ğŸ”’&#x27;</span>, <span class="hljs-variable language_">self</span>.locked<br>        <span class="hljs-keyword">return</span> seen == <span class="hljs-string">&#x27;&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">release</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.locked = <span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-meta">    @thread</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">tp</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>):<br>            <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.tryacquire(): <span class="hljs-keyword">pass</span> <span class="hljs-comment"># mutex_lock()</span><br><br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.count == <span class="hljs-number">1</span>:<br>                <span class="hljs-comment"># cond_wait</span><br>                _, <span class="hljs-variable language_">self</span>.waits = <span class="hljs-variable language_">self</span>.release(), <span class="hljs-variable language_">self</span>.waits + <span class="hljs-string">&#x27;1&#x27;</span><br>                <span class="hljs-keyword">while</span> <span class="hljs-string">&#x27;1&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.waits: <span class="hljs-keyword">pass</span><br>                <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.tryacquire(): <span class="hljs-keyword">pass</span><br><br>            <span class="hljs-variable language_">self</span>.log, <span class="hljs-variable language_">self</span>.count = <span class="hljs-variable language_">self</span>.log + <span class="hljs-string">&#x27;(&#x27;</span>, <span class="hljs-variable language_">self</span>.count + <span class="hljs-number">1</span><br>            <span class="hljs-variable language_">self</span>.waits = <span class="hljs-variable language_">self</span>.waits[<span class="hljs-number">1</span>:] <span class="hljs-comment"># cond_signal</span><br>            <span class="hljs-variable language_">self</span>.release() <span class="hljs-comment"># mutex_unlock()</span><br><br><span class="hljs-meta">    @thread</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">tc1</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.tryacquire(): <span class="hljs-keyword">pass</span><br><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.count == <span class="hljs-number">0</span>:<br>            _, <span class="hljs-variable language_">self</span>.waits = <span class="hljs-variable language_">self</span>.release(), <span class="hljs-variable language_">self</span>.waits + <span class="hljs-string">&#x27;2&#x27;</span><br>            <span class="hljs-keyword">while</span> <span class="hljs-string">&#x27;2&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.waits: <span class="hljs-keyword">pass</span><br>            <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.tryacquire(): <span class="hljs-keyword">pass</span><br><br>        <span class="hljs-variable language_">self</span>.log, <span class="hljs-variable language_">self</span>.count = <span class="hljs-variable language_">self</span>.log + <span class="hljs-string">&#x27;)&#x27;</span>, <span class="hljs-variable language_">self</span>.count - <span class="hljs-number">1</span><br><br>        <span class="hljs-variable language_">self</span>.waits = <span class="hljs-variable language_">self</span>.waits[<span class="hljs-number">1</span>:]<br>        <span class="hljs-variable language_">self</span>.release()<br><br><span class="hljs-meta">    @thread</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">tc2</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.tryacquire(): <span class="hljs-keyword">pass</span><br><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.count == <span class="hljs-number">0</span>:<br>            _, <span class="hljs-variable language_">self</span>.waits = <span class="hljs-variable language_">self</span>.release(), <span class="hljs-variable language_">self</span>.waits + <span class="hljs-string">&#x27;3&#x27;</span><br>            <span class="hljs-keyword">while</span> <span class="hljs-string">&#x27;3&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.waits: <span class="hljs-keyword">pass</span><br>            <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.tryacquire(): <span class="hljs-keyword">pass</span><br><br>        <span class="hljs-variable language_">self</span>.log, <span class="hljs-variable language_">self</span>.count = <span class="hljs-variable language_">self</span>.log + <span class="hljs-string">&#x27;)&#x27;</span>, <span class="hljs-variable language_">self</span>.count - <span class="hljs-number">1</span><br><br>        <span class="hljs-variable language_">self</span>.waits = <span class="hljs-variable language_">self</span>.waits[<span class="hljs-number">1</span>:]<br>        <span class="hljs-variable language_">self</span>.release()<br></code></pre></td></tr></table></figure>
<p>ä¸¤ä¸ªæ¡ä»¶å˜é‡å®ç°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">Tproduce</span><span class="hljs-params">()</span> &#123;<br>  mutex_lock(&amp;lk);<br>  <span class="hljs-keyword">if</span> (count == n) cond_wait(&amp;c, &amp;lk); <br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;(&quot;</span>); count++; cond_signal(&amp;p);<br>  mutex_unlock(&amp;lk);<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">Tconsume</span><span class="hljs-params">()</span> &#123;<br>  mutex_lock(&amp;lk);<br>  <span class="hljs-keyword">if</span> (count == <span class="hljs-number">0</span>) cond_wait(&amp;p, &amp;lk);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;)&quot;</span>); count--; cond_signal(&amp;c);<br>  mutex_unlock(&amp;lk);<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="whileå¾ªç¯-broadcast"><a href="#whileå¾ªç¯-broadcast" class="headerlink" title="whileå¾ªç¯+broadcast"></a>whileå¾ªç¯+broadcast</h5><p>é€šç”¨æ¨¡æ¿</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">mutex_lock(&amp;mutex);<br><span class="hljs-keyword">while</span> (!cond) &#123;      condå¯ä»¥å¤šä¸ªæ¡ä»¶<br>  wait(&amp;cv, &amp;mutex);<br>&#125;<br>assert(cond);  <span class="hljs-comment">// äº’æ–¥é”ä¿è¯äº†åœ¨æ­¤æœŸé—´æ¡ä»¶ cond æ€»æ˜¯æˆç«‹</span><br><br>å…¶ä»–çº¿ç¨‹æ¡ä»¶å¯èƒ½è¢«æ»¡è¶³æ—¶ï¼Œå°±ç®—ä¸æ»¡è¶³è¿›å…¥<span class="hljs-keyword">while</span>è¿˜æ˜¯ä¼šç¡çœ <br>broadcast(&amp;cv);<br><br>mutex_unlock(&amp;mutex);<br><br><br><span class="hljs-comment">/// ...è®¡ç®—ä»»åŠ¡ï¼Œå¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´   ä¹Ÿå°±æ˜¯T(job) &gt;&gt;  T(åŒæ­¥äº’æ–¥)</span><br></code></pre></td></tr></table></figure>

<p>ä½œä¸šï¼šæ‰“å°æŒ‡å®šçš„å½¢çŠ¶ <code>&lt;&gt;&lt;_</code> å’Œ <code>&gt;&lt;&gt;_ </code> <a target="_blank" rel="noopener" href="http://jyywiki.cn/pages/OS/2022/demos/fish.c">http://jyywiki.cn/pages/OS/2022/demos/fish.c</a></p>
<p>å¤„ç†å™¨å¯ä»¥ä¹±åºæ‰§è¡Œï¼Œå…ˆæ‰§è¡Œç¬¬äºŒæ¡ï¼Œä½†13éœ€è¦é¡ºåºæ‰§è¡Œï¼Œç¡¬ä»¶å®ç°é¡ºåºæ‰§è¡Œ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">x = <span class="hljs-number">0</span>   write<br>t = y  <span class="hljs-comment"># å¯ä»¥å…ˆæ‰§è¡Œ</span><br>z = x   read<br></code></pre></td></tr></table></figure>



<h4 id="ä¿¡å·é‡PV"><a href="#ä¿¡å·é‡PV" class="headerlink" title="ä¿¡å·é‡PV"></a>ä¿¡å·é‡PV</h4><p>åœ¨æ‰§è¡Œå‰éœ€è¦æŸäº›ä¸œè¥¿ï¼Œæ²¡æœ‰å°±ç¡çœ ç­‰åˆ°æœ‰ã€‚<code>happens before</code>ã€‚<strong>ä¼˜é›…ä½†ä¸å…¨</strong></p>
<p>æœ€å¥½è§£å†³<strong>å•ä¸€èµ„æº</strong>é—®é¢˜ï¼Œä½†ä¸Šé¢çš„æ‰“å°ğŸŸéš¾ä»¥å®ç°</p>
<p>tokenä¸ºèµ„æºæ•°é‡ï¼Œå½“token&#x3D;1ã€0æ—¶å°±ä»£è¡¨äº’æ–¥é”Mutexï¼Œæ²¡å¾—åˆ°å°±ç¡çœ ï¼ˆä½†ç›¸å½“äºæœ‰å¤šæŠŠé’¥åŒ™ï¼‰</p>
<p>Pï¼š tokenâ€“ if token &lt; 0ï¼Œçº¿ç¨‹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—</p>
<p>Vï¼štoken++ if token&lt;&#x3D;0, å”¤é†’ç­‰å¾…é˜Ÿåˆ—</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Semaphore</span>:<br>    token, waits = <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">P</span>(<span class="hljs-params">self, tid</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.token &gt; <span class="hljs-number">0</span>:<br>            <span class="hljs-variable language_">self</span>.token -= <span class="hljs-number">1</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-variable language_">self</span>.waits = <span class="hljs-variable language_">self</span>.waits + tid<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">V</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.waits:<br>            <span class="hljs-variable language_">self</span>.waits = <span class="hljs-variable language_">self</span>.waits[<span class="hljs-number">1</span>:]<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-variable language_">self</span>.token += <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">producer</span><span class="hljs-params">()</span> &#123;<br>  P(&amp;empty);   <span class="hljs-comment">// P()è¿”å› -&gt; å¾—åˆ°æ‰‹ç¯</span><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;(&quot;</span>); <span class="hljs-comment">// å‡è®¾çº¿ç¨‹å®‰å…¨</span><br>  V(&amp;fill);<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">consumer</span><span class="hljs-params">()</span> &#123;<br>  P(&amp;fill);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;)&quot;</span>);<br>  V(&amp;empty);<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="çº¿ç¨‹åŒæ­¥"><a href="#çº¿ç¨‹åŒæ­¥" class="headerlink" title="çº¿ç¨‹åŒæ­¥"></a>çº¿ç¨‹åŒæ­¥</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">A -&gt; B      å¦‚æœä½¿ç”¨æ¡ä»¶å˜é‡ï¼Œå¯èƒ½å‡ºç°Aå·²ç»æ‰§è¡Œï¼Œä½†Bè¿˜æ²¡è¿›å…¥<br>    s = <span class="hljs-number">0</span><br>    A: V(s)<br>    B: P(S)<br>    <br>joinï¼š<br>    s = <span class="hljs-number">0</span><br>    Aã€Bã€C: V(s) <br>    main: P(S) * |T|<br></code></pre></td></tr></table></figure>

<h5 id="è®¡ç®—å›¾"><a href="#è®¡ç®—å›¾" class="headerlink" title="è®¡ç®—å›¾"></a>è®¡ç®—å›¾</h5><p>å¦‚æœæƒ³è¦å¹¶è¡Œï¼Œå°±éœ€è¦ç”»å‡ºè®¡ç®—å›¾ï¼Œå¹¶è®©ç¨‹åºæŒ‰è®¡ç®—å›¾æ‰§è¡Œï¼šPVå¾ˆæ–¹ä¾¿</p>
<p>æ¯æ¡è¾¹PVå„ä¸€æ¬¡</p>
<img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404501.png" srcset="/img/loading.gif" lazyload alt="image-20230526171022426" style="zoom:67%;" />

<h5 id="æ‰“å°ğŸŸ"><a href="#æ‰“å°ğŸŸ" class="headerlink" title="æ‰“å°ğŸŸ"></a>æ‰“å°ğŸŸ</h5><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs isbl">å½“å‰çº¿ç¨‹æƒ³æ‰“ç¬¦å·<span class="hljs-string">&#x27;&lt;&#x27;</span> é‚£å°±<span class="hljs-function"><span class="hljs-title">P</span>(<span class="hljs-string">&#x27;&lt;&#x27;</span>)</span><br><br>å½“å‰çº¿ç¨‹ç»“æŸåï¼Œæ ¹æ®è§„åˆ™å†³å®šè°å¯ä»¥æ‰§è¡Œ <span class="hljs-function"><span class="hljs-title">V</span>(<span class="hljs-string">&#x27;&gt;&#x27;</span>)   å¤šä¸ªå°±éšæœº</span><br></code></pre></td></tr></table></figure>



<h5 id="ä¿¡å·é‡å®ç°æ¡ä»¶å˜é‡"><a href="#ä¿¡å·é‡å®ç°æ¡ä»¶å˜é‡" class="headerlink" title="ä¿¡å·é‡å®ç°æ¡ä»¶å˜é‡"></a>ä¿¡å·é‡å®ç°æ¡ä»¶å˜é‡</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">å¤±è´¥ï¼šæˆ‘ä¸èƒ½å¸¦è€…é”ç¡çœ ï¼Œå¿…é¡»è¦å…ˆé‡Šæ”¾é”ï¼Œä½†é‡Šæ”¾ä¹‹åä¸èƒ½ä¿è¯åŸå­æ€§äº†<br>wait(mutex)&#123;<br>	release(mutex)<br>	<span class="hljs-comment">// å¯èƒ½è¢«broadcast</span><br>	sleep<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="ç®¡é“"><a href="#ç®¡é“" class="headerlink" title="ç®¡é“"></a>ç®¡é“</h4><p>ä¹‹å‰å®ç°é€šä¿¡éœ€è¦å…±äº«å†…å­˜å¹¶ä¸”é”å®šï¼Œä¼šå¼•å‘ç«äº‰å’Œæ­»é”ï¼›å› æ­¤æˆ‘ä»¬åè¿‡æ¥ï¼Œé€šè¿‡é€šä¿¡æ¥å®ç°å…±äº«å†…å­˜</p>
<p><code>Do not communicate by sharing memory; instead, share memory by communicating. â€”â€”*Effective Go*</code></p>
<p>ç®¡é“ï¼šä¸ä½†èƒ½åŒæ­¥ï¼Œè¿˜èƒ½é€šä¿¡</p>
<p><code>cat a.txt | wc -l</code> Linuxç®¡é“å°±æ˜¯ä¸€ç§åŒæ­¥æœºåˆ¶ã€‚ åä¸€ä¸ªä¼šä¸€è¾¹æ¥æ”¶ä¸€è¾¹å¤„ç†</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-keyword">var</span> stream = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, <span class="hljs-number">10</span>)<br><span class="hljs-keyword">const</span> n = <span class="hljs-number">4</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">produce</span><span class="hljs-params">()</span></span> &#123;<br>  <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; ; i++ &#123;<br>    fmt.Println(<span class="hljs-string">&quot;produce&quot;</span>, i)<br>    stream &lt;- i<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">consume</span><span class="hljs-params">()</span></span> &#123;<br>  <span class="hljs-keyword">for</span> &#123;<br>    x := &lt;-stream<br>    fmt.Println(<span class="hljs-string">&quot;consume&quot;</span>, x)<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i++ &#123;<br>    <span class="hljs-keyword">go</span> produce()<br>  &#125;<br>  consume()<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="å“²å­¦å®¶åƒé¥­"><a href="#å“²å­¦å®¶åƒé¥­" class="headerlink" title="å“²å­¦å®¶åƒé¥­"></a>å“²å­¦å®¶åƒé¥­</h4><h5 id="æ¡ä»¶å˜é‡"><a href="#æ¡ä»¶å˜é‡" class="headerlink" title="æ¡ä»¶å˜é‡"></a>æ¡ä»¶å˜é‡</h5><p>ç›´æ¥ä¸Šåƒé¥­çš„æ¡ä»¶ï¼Œå¹¶ç”¨äº’æ–¥é”ä¿æŠ¤èµ·æ¥</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">mutex_lock(&amp;mutex);<br><span class="hljs-keyword">while</span> (!(avail[lhs] &amp;&amp; avail[rhs])) &#123;<br>  wait(&amp;cv, &amp;mutex);<br>&#125;<br>avail[lhs] = avail[rhs] = <span class="hljs-literal">false</span>;<br>mutex_unlock(&amp;mutex);<br>      <br><span class="hljs-comment">// ...</span><br><br>mutex_lock(&amp;mutex);<br>avail[lhs] = avail[rhs] = <span class="hljs-literal">true</span>;<br>broadcast(&amp;cv);<br>mutex_unlock(&amp;mutex);<br></code></pre></td></tr></table></figure>

<h5 id="ä¿¡å·é‡"><a href="#ä¿¡å·é‡" class="headerlink" title="ä¿¡å·é‡"></a>ä¿¡å·é‡</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// å¤±è´¥çš„å°è¯•ï¼Œè¿™é‡Œä¼šæ­»é”</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">Tphilosopher</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> &#123;<br>  <span class="hljs-type">int</span> lhs = (N + id - <span class="hljs-number">1</span>) % N;<br>  <span class="hljs-type">int</span> rhs = id % N;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>    P(&amp;locks[lhs]);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;T%d Got %d\n&quot;</span>, id, lhs + <span class="hljs-number">1</span>);<br>    P(&amp;locks[rhs]);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;T%d Got %d\n&quot;</span>, id, rhs + <span class="hljs-number">1</span>);<br>      <br>    <span class="hljs-comment">// ...</span><br><br>    V(&amp;locks[lhs]);<br>    V(&amp;locks[rhs]);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// 1.ç›´æ¥é”èµ·æ¥</span><br>mutex_lock(&amp;mutex);<br>P(&amp;locks[lhs]);<br>P(&amp;locks[rhs]);<br>mutex_unlock(&amp;mutex);<br><br><span class="hljs-comment">// 2. åªå…è®¸å››ä¸ªäººä¸Šåº§ numperson=4   éœ€æ±‚å˜äº†æ€ä¹ˆåŠï¼Ÿ</span><br>P(&amp;numperson);<br>P(&amp;locks[lhs]);<br>P(&amp;locks[rhs]);<br><br><br>V(&amp;numperson);<br></code></pre></td></tr></table></figure>

<p>éœ€æ±‚å˜äº†ï¼šå¦‚æœä¸€ä¸ªäººè¦å·¦è¾¹ä¸¤æŠŠå³è¾¹ä¸€æŠŠï¼Œå¦‚ä½•è®¾è®¡ï¼Ÿ   è¿˜æ˜¯æ¡ä»¶å˜é‡æ–¹ä¾¿ï¼Œç›´æ¥æ”¹<code>cond</code>å°±è¡Œ</p>
<h4 id="åˆ†å¸ƒä¸é›†ä¸­"><a href="#åˆ†å¸ƒä¸é›†ä¸­" class="headerlink" title="åˆ†å¸ƒä¸é›†ä¸­"></a>åˆ†å¸ƒä¸é›†ä¸­</h4><p>é›†ä¸­æ§åˆ¶è€Œä¸æ˜¯å„è‡ªåè°ƒ</p>
<ul>
<li>å¯ä»¥çŸ¥é“æ¯ä¸€ä¸ªçº¿ç¨‹å…·ä½“è¿è¡ŒçŠ¶å†µï¼Œé›†ä¸­ç®¡ç†</li>
<li><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.824/papers/gfs.pdf">The Google File System</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">Tphilosopher</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> &#123;<br>  send_request(id, EAT);<br>  P(allowed[id]); <span class="hljs-comment">// waiter ä¼šæŠŠå‰å­é€’ç»™å“²å­¦å®¶</span><br>  philosopher_eat();<br>  send_request(id, DONE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Twaiter</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>    (id, status) = receive_request();<br>    <span class="hljs-keyword">if</span> (status == EAT) &#123; ... &#125;<br>    <span class="hljs-keyword">if</span> (status == DONE) &#123; ... &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>é›†ä¸­çš„äººå‹åŠ›å¤ªå¤§ï¼Ÿå†åˆ†çº§</li>
</ul>
<p>ä¿¡å·é‡å¯ä»¥è¢«æ“ä½œç³»ç»Ÿé«˜æ•ˆå®ç°ï¼Œé¿å…äº†broadcastå¼€é”€</p>
<h3 id="çœŸå®ä¸–ç•Œçš„å¹¶å‘ç¼–ç¨‹"><a href="#çœŸå®ä¸–ç•Œçš„å¹¶å‘ç¼–ç¨‹" class="headerlink" title="çœŸå®ä¸–ç•Œçš„å¹¶å‘ç¼–ç¨‹"></a>çœŸå®ä¸–ç•Œçš„å¹¶å‘ç¼–ç¨‹</h3><p><strong>èƒŒæ™¯å›é¡¾</strong>ï¼šæˆ‘ä»¬å·²ç»æŒæ¡äº†å¤šç§å¹¶å‘æ§åˆ¶æŠ€æœ¯ï¼šè‡ªæ—‹é”ã€äº’æ–¥é”ã€æ¡ä»¶å˜é‡ã€ä¿¡å·é‡ã€‚æˆ‘ä»¬å·²ç»å¯ä»¥å®ç°å…±äº«å†…å­˜ç³»ç»Ÿä¸Šçš„ä»»æ„å¹¶å‘&#x2F;å¹¶è¡Œè®¡ç®—ã€‚ç„¶è€Œï¼Œå¤§å®¶ä¹Ÿåœ¨ä½¿ç”¨è¿™äº› â€œåº•å±‚â€ å¹¶å‘æ§åˆ¶æ—¶å‘ç°ä½¿ç”¨çš„å›°éš¾ã€‚é‚£ä¹ˆï¼ŒçœŸå®ä¸–ç•Œçš„ç¨‹åºå‘˜æ˜¯æ€ä¹ˆå®ç°å¹¶å‘ç¨‹åºçš„ï¼Ÿ</p>
<ul>
<li><strong>é«˜æ€§èƒ½è®¡ç®—</strong> (æ³¨é‡ä»»åŠ¡åˆ†è§£)ä¸­çš„å¹¶è¡Œç¼–ç¨‹ (embarrassingly parallel çš„æ•°å€¼è®¡ç®—)</li>
<li><strong>æ•°æ®ä¸­å¿ƒ</strong>(æ³¨é‡ç³»ç»Ÿè°ƒç”¨): (åç¨‹ã€Goroutine å’Œ channel)</li>
<li>äººå·¥æ™ºèƒ½æ—¶ä»£çš„<strong>åˆ†å¸ƒå¼æœºå™¨å­¦ä¹ </strong> (GPU å’Œ Parameter Server)</li>
<li><strong>ç”¨æˆ·èº«è¾¹</strong>çš„å¹¶å‘ç¼–ç¨‹ (Web å’Œå¼‚æ­¥ç¼–ç¨‹) (æ³¨é‡æ˜“ç”¨æ€§)</li>
</ul>
<h4 id="é«˜æ€§èƒ½è®¡ç®—"><a href="#é«˜æ€§èƒ½è®¡ç®—" class="headerlink" title="é«˜æ€§èƒ½è®¡ç®—"></a>é«˜æ€§èƒ½è®¡ç®—</h4><p>massive computation  æºè‡ªæ•°å€¼å¯†é›†å‹ç§‘å­¦è®¡ç®—ä»»åŠ¡ã€‚é€šå¸¸æœ‰å›ºå®šçš„è®¡ç®—å›¾</p>
<ul>
<li>ç‰©ç†ç³»ç»Ÿæ¨¡æ‹Ÿ<ul>
<li>å¤©æ°”é¢„æŠ¥ã€èˆªå¤©ã€åˆ¶é€ ã€èƒ½æºã€åˆ¶è¯ã€â€¦â€¦</li>
<li>å¤§åˆ°å®‡å®™å°åˆ°é‡å­ï¼Œæœ‰æ¨¡å‹å°±èƒ½æ¨¡æ‹Ÿ</li>
</ul>
</li>
<li>çŸ¿å‚ (ç°åœ¨ä¸é‚£ä¹ˆçƒ­äº†)<ul>
<li>çº¯ç²¹çš„ hash è®¡ç®—</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="http://www.hpc100.cn/top100/21/">HPC-China 100</a></li>
</ul>
<p><strong>embarrassingly parallel</strong> ï¼šè¿™ç±»é—®é¢˜å¯ä»¥è¢«åˆ†è§£æˆå¤šä¸ªç‹¬ç«‹çš„å­é—®é¢˜ï¼Œæ¯ä¸ªå­é—®é¢˜å¯ä»¥åœ¨ä¸åŒçš„å¤„ç†å™¨ä¸Šå¹¶è¡Œè®¡ç®—ï¼Œè€Œä¸éœ€è¦è¿›è¡Œä»»ä½•è¿›ä¸€æ­¥çš„åŒæ­¥æˆ–é€šä¿¡ã€‚è¿™ç§é—®é¢˜çš„å¹¶è¡ŒåŒ–éå¸¸ç®€å•ï¼Œå› ä¸ºæ¯ä¸ªå­é—®é¢˜éƒ½æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œä¸éœ€è¦è¿›è¡Œä»»ä½•åè°ƒæˆ–åŒæ­¥ã€‚</p>
<p>é€šå¸¸å‡ºç°åœ¨<strong>ç§‘å­¦è®¡ç®—ã€æ•°æ®åˆ†æã€å›¾åƒå¤„ç†</strong>ç­‰é¢†åŸŸã€‚ä¾‹å¦‚ï¼Œåœ¨å›¾åƒå¤„ç†ä¸­ï¼Œå¯ä»¥å°†ä¸€å¼ å¤§å›¾åƒåˆ†æˆå¤šä¸ªå°å—ï¼Œæ¯ä¸ªå°å—å¯ä»¥åœ¨ä¸åŒçš„å¤„ç†å™¨ä¸Šå¹¶è¡Œå¤„ç†ï¼Œæœ€åå°†ç»“æœåˆå¹¶æˆä¸€å¼ å®Œæ•´çš„å›¾åƒã€‚åœ¨ç§‘å­¦è®¡ç®—ä¸­ï¼Œå¯ä»¥å°†ä¸€ä¸ªå¤§å‹è®¡ç®—ä»»åŠ¡åˆ†æˆå¤šä¸ªå°ä»»åŠ¡ï¼Œæ¯ä¸ªå°ä»»åŠ¡å¯ä»¥åœ¨ä¸åŒçš„å¤„ç†å™¨ä¸Šå¹¶è¡Œè®¡ç®—ï¼Œæœ€åå°†ç»“æœåˆå¹¶æˆä¸€ä¸ªå®Œæ•´çš„è®¡ç®—ç»“æœã€‚</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404502.png" srcset="/img/loading.gif" lazyload style="zoom: 67%;" /><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404503.png" srcset="/img/loading.gif" lazyload alt="image-20230529102943340" style="zoom: 50%;" />ä¸¤ä¸ªçº¿ç¨‹ç”»å›¾</p>
<h4 id="æ•°æ®ä¸­å¿ƒ"><a href="#æ•°æ®ä¸­å¿ƒ" class="headerlink" title="æ•°æ®ä¸­å¿ƒ"></a>æ•°æ®ä¸­å¿ƒ</h4><p><code>â€œA network of computing and storage resources that enable the delivery of *shared* applications and data.â€ (CISCO)</code></p>
<p>ä»¥<strong>æ•°æ® (å­˜å‚¨)</strong> ä¸ºä¸­å¿ƒ</p>
<ul>
<li>äº’è”ç½‘ç´¢å¼•ä¸æœç´¢<ul>
<li>Google</li>
</ul>
</li>
<li>ç¤¾äº¤ç½‘ç»œ<ul>
<li>Facebook&#x2F;Twitter</li>
</ul>
</li>
<li>æ”¯æ’‘å„ç±»äº’è”ç½‘åº”ç”¨<ul>
<li>é€šä¿¡ (å¾®ä¿¡&#x2F;QQ ç¾¤äººæ•°ä¸ºä»€ä¹ˆæœ‰ä¸Šé™ï¼Ÿ)ã€æ”¯ä»˜ (æ”¯ä»˜å®)ã€æ¸¸æˆ&#x2F;ç½‘ç›˜&#x2F;â€¦â€¦</li>
</ul>
</li>
</ul>
<h5 id="å…³é”®é—®é¢˜"><a href="#å…³é”®é—®é¢˜" class="headerlink" title="å…³é”®é—®é¢˜"></a>å…³é”®é—®é¢˜</h5><p>æˆ‘å¸Œæœ›é«˜å¯é ã€ä½å»¶æ—¶ã€å¤šå‰¯æœ¬çš„åˆ†å¸ƒå¼ å­˜å‚¨ è®¡ç®—ç³»ç»Ÿ</p>
<img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404504.png" srcset="/img/loading.gif" lazyload alt="image-20230529103310529" style="zoom:67%;" />

<p>ä¸¾ä¸ªä¾‹å­ï¼šå¾®ä¿¡å…ˆæ‹‰é»‘ï¼Œå†å‘æœ‹å‹åœˆï¼Œå¦‚æœæ²¡æœ‰ä¸€è‡´æ€§ï¼Œé‚£ä¹ˆæœ‹å‹åœˆå¯èƒ½è¢«æ‹‰é»‘çš„äººçœ‹åˆ°ã€‚äºšé©¬é€Šæ²¡ä¸€è‡´æ€§å¯èƒ½å‘ä¸¤ä¸ªå¿«é€’</p>
<h5 id="å•æœºç¨‹åº"><a href="#å•æœºç¨‹åº" class="headerlink" title="å•æœºç¨‹åº"></a><strong>å•æœºç¨‹åº</strong></h5><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404505.png" srcset="/img/loading.gif" lazyload alt="image-20230529103721001"></p>
<p>å‡è®¾æœ‰æ•°åƒ&#x2F;æ•°ä¸‡ä¸ªè¯·æ±‚åŒæ—¶åˆ°è¾¾æœåŠ¡å™¨â€¦â€¦</p>
<ul>
<li>çº¿ç¨‹èƒ½å¤Ÿå®ç°å¹¶è¡Œå¤„ç†</li>
<li>ä½†è¿œå¤šäºå¤„ç†å™¨æ•°é‡çš„çº¿ç¨‹å¯¼è‡´æ€§èƒ½é—®é¢˜<ul>
<li>åˆ‡æ¢å¼€é”€</li>
<li>ç»´æŠ¤å¼€é”€</li>
</ul>
</li>
</ul>
<h5 id="åç¨‹-åä½œçš„çº¿ç¨‹"><a href="#åç¨‹-åä½œçš„çº¿ç¨‹" class="headerlink" title="åç¨‹(åä½œçš„çº¿ç¨‹)"></a>åç¨‹(åä½œçš„çº¿ç¨‹)</h5><p>å’Œçº¿ç¨‹æ¦‚å¿µç›¸åŒ (ç‹¬ç«‹å †æ ˆã€å…±äº«å†…å­˜) ï¼Œç”¨æˆ·æ€çš„çº¿ç¨‹ï¼Œç”±ç¨‹åºå‘˜ä¸»åŠ¨æ§åˆ¶</p>
<ul>
<li>ä½† â€œä¸€ç›´æ‰§è¡Œâ€ï¼Œç›´åˆ° <code>yield()</code>   å¯ä»¥è§†ä¸º<strong>å‡½æ•°è°ƒç”¨</strong>ï¼Œ ä¸»åŠ¨æ”¾å¼ƒå¤„ç†å™¨<ul>
<li>æœ‰ç¼–è¯‘å™¨è¾…åŠ©ï¼Œåˆ‡æ¢å¼€é”€ä½<ul>
<li>yield() æ˜¯å‡½æ•°è°ƒç”¨ï¼Œåªéœ€ä¿å­˜&#x2F;æ¢å¤ <code>â€œcallee savedâ€</code> å¯„å­˜å™¨ï¼ˆå‡½æ•°è°ƒç”¨ä¿å­˜çš„å¯„å­˜å™¨ï¼‰  <code>RBP</code></li>
<li>çº¿ç¨‹åˆ‡æ¢éœ€è¦ä¿å­˜&#x2F;æ¢å¤å…¨éƒ¨å¯„å­˜å™¨</li>
</ul>
</li>
<li>ä½†ç­‰å¾… I&#x2F;O æ—¶ï¼Œå…¶ä»–åç¨‹å°±ä¸èƒ½è¿è¡Œäº†â€¦â€¦<ul>
<li>å¤±å»äº†å¹¶è¡Œ   goä¼˜åŒ–</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// åªå¯èƒ½æ˜¯ 1122 æˆ– 2211</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">T1</span><span class="hljs-params">()</span> &#123; send(<span class="hljs-string">&quot;1&quot;</span>); send(<span class="hljs-string">&quot;1&quot;</span>); yield(); &#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">T2</span><span class="hljs-params">()</span> &#123; send(<span class="hljs-string">&quot;2&quot;</span>); send(<span class="hljs-string">&quot;2&quot;</span>); yield(); &#125;<br></code></pre></td></tr></table></figure>

<p><code>Goroutine</code>ï¼šæ¦‚å¿µä¸Šæ˜¯çº¿ç¨‹ï¼Œå®ç°ä¸Šæ˜¯åç¨‹ï¼šåœ¨é‡åˆ°IOä¸”å¯èƒ½ç­‰å¾…æ—¶ï¼Œ<code>yield</code>åˆ‡æ¢</p>
<p>å¦‚æœæ˜¯åç¨‹ï¼Œçº¿ç¨‹sleepåè®¡ç®—æœºå°±åœæ­¢äº†ï¼Œä½†goä¼˜åŒ–æˆyieldåˆ‡æ¢</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>  <span class="hljs-string">&quot;fmt&quot;</span><br>  <span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  <span class="hljs-keyword">go</span> spinner(<span class="hljs-number">100</span> * time.Millisecond)<br>  <span class="hljs-keyword">const</span> n = <span class="hljs-number">45</span><br>  fibN := fib(n) <span class="hljs-comment">// slow</span><br>  fmt.Printf(<span class="hljs-string">&quot;\rFibonacci(%d) = %d\n&quot;</span>, n, fibN)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">spinner</span><span class="hljs-params">(delay time.Duration)</span></span> &#123;<br>  <span class="hljs-keyword">for</span> &#123;<br>    <span class="hljs-keyword">for</span> _, r := <span class="hljs-keyword">range</span> <span class="hljs-string">`-\|/`</span> &#123;<br>      fmt.Printf(<span class="hljs-string">&quot;\r%c&quot;</span>, r)<br>      time.Sleep(delay)<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fib</span><span class="hljs-params">(x <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>  <span class="hljs-keyword">if</span> x &lt; <span class="hljs-number">2</span> &#123; <span class="hljs-keyword">return</span> x &#125;<br>  <span class="hljs-keyword">return</span> fib(x - <span class="hljs-number">1</span>) + fib(x - <span class="hljs-number">2</span>)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>goä¹‹å‰ï¼Œjavaå·²ç»å½¢æˆäº†å¤§æ•°æ®å¤„ç†ç³»ç»Ÿçš„ç”Ÿæ€</p>
<h4 id="äººå·¥æ™ºèƒ½æ—¶ä»£çš„åˆ†å¸ƒå¼æœºå™¨å­¦ä¹ "><a href="#äººå·¥æ™ºèƒ½æ—¶ä»£çš„åˆ†å¸ƒå¼æœºå™¨å­¦ä¹ " class="headerlink" title="äººå·¥æ™ºèƒ½æ—¶ä»£çš„åˆ†å¸ƒå¼æœºå™¨å­¦ä¹ "></a>äººå·¥æ™ºèƒ½æ—¶ä»£çš„åˆ†å¸ƒå¼æœºå™¨å­¦ä¹ </h4><h5 id="ç‰¹ç‚¹"><a href="#ç‰¹ç‚¹" class="headerlink" title="ç‰¹ç‚¹"></a>ç‰¹ç‚¹</h5><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404506.png" srcset="/img/loading.gif" lazyload alt="image-20230529110833871"></p>
<h5 id="å¹¶è¡Œ"><a href="#å¹¶è¡Œ" class="headerlink" title="å¹¶è¡Œ"></a>å¹¶è¡Œ</h5><p>æ•°æ®å¹¶è¡Œï¼šä¸€éƒ¨åˆ†æ•°æ®è¿™å°æœºå™¨ï¼Œä¸€éƒ¨åˆ†é‚£å° <code>model = nn.DataParallel(model) </code><br>æ¨¡å‹å¹¶è¡Œï¼šåˆ‡å‰²è®¡ç®—å›¾</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404507.png" srcset="/img/loading.gif" lazyload alt="image-20230529111116782"></p>
<h5 id="SIMP"><a href="#SIMP" class="headerlink" title="SIMP"></a>SIMP</h5><p><code>Single Instruction, Multiple Threads</code></p>
<p>CPUï¼šå¤šä¸ªcpuï¼Œä½†å„è‡ªè¿è¡Œå„è‡ªçš„ï¼Œéƒ½æœ‰pcæŒ‡é’ˆ</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404509.png" srcset="/img/loading.gif" lazyload alt="image-20230529112121783"></p>
<p>GPUï¼šä¸€ä¸ªpcæ§åˆ¶å¤šä¸ªæ‰§è¡Œæµï¼Œç‹¬ç«‹å¯„å­˜å™¨æ ‡è®°çº¿ç¨‹å·</p>
<img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404510.png" srcset="/img/loading.gif" lazyload alt="image-20230529112321136" style="zoom:80%;" />

<h5 id="SIMD"><a href="#SIMD" class="headerlink" title="SIMD"></a>SIMD</h5><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404511.png" srcset="/img/loading.gif" lazyload alt="image-20230529112558826"></p>
<h5 id="åˆ†å¸ƒå¼æœºå™¨å­¦ä¹ "><a href="#åˆ†å¸ƒå¼æœºå™¨å­¦ä¹ " class="headerlink" title="åˆ†å¸ƒå¼æœºå™¨å­¦ä¹ "></a>åˆ†å¸ƒå¼æœºå™¨å­¦ä¹ </h5><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404512.png" srcset="/img/loading.gif" lazyload alt="image-20230529112936378"></p>
<h4 id="ç”¨æˆ·èº«è¾¹å¹¶å‘ç¼–ç¨‹"><a href="#ç”¨æˆ·èº«è¾¹å¹¶å‘ç¼–ç¨‹" class="headerlink" title="ç”¨æˆ·èº«è¾¹å¹¶å‘ç¼–ç¨‹"></a>ç”¨æˆ·èº«è¾¹å¹¶å‘ç¼–ç¨‹</h4><p>web2.0ï¼šHTML(DOM Tree) + CSS + JS</p>
<p>ç‰¹ç‚¹ï¼šä¸å¤ªå¤æ‚</p>
<ul>
<li>æ—¢æ²¡æœ‰å¤ªå¤šè®¡ç®—<ul>
<li>DOM Tree ä¹Ÿä¸è‡³äºå¤ªå¤§ (å¤§äº†äººä¹Ÿçœ‹ä¸è¿‡æ¥)</li>
<li>DOM Tree æ€ä¹ˆç”»æµè§ˆå™¨å…¨å¸®æˆ‘ä»¬æå®šäº†</li>
</ul>
</li>
<li>ä¹Ÿæ²¡æœ‰å¤ªå¤š I&#x2F;O<ul>
<li>å°±æ˜¯ä¸€äº›ç½‘ç»œè¯·æ±‚</li>
</ul>
</li>
</ul>
<h5 id="JS"><a href="#JS" class="headerlink" title="JS"></a>JS</h5><p>å•çº¿ç¨‹ + äº‹ä»¶æ¨¡å‹</p>
<ul>
<li><p>ä¸€ä¸ªçº¿ç¨‹ã€æŒ‰åºæ‰§è¡Œ (run-to-complete)ã€‚æ— å¹¶è¡Œå‡å°‘äº†bug  <strong>ä¸»çº¿ç¨‹æ‰§è¡Œæ ˆ + å¾®ä»»åŠ¡é˜Ÿåˆ—</strong></p>
</li>
<li><p>è€—æ—¶çš„ API (Timer, Ajax, â€¦) è°ƒç”¨ä¼šç«‹å³è¿”å› + <code>Callback</code></p>
<ul>
<li>å½“Promiseè¢«åˆ›å»ºæ—¶ï¼Œå®ƒå¤„äºæœªå®Œæˆçš„çŠ¶æ€ï¼ˆpendingï¼‰ã€‚å½“å¼‚æ­¥æ“ä½œå®Œæˆå¹¶ä¸”PromiseæˆåŠŸè§£æï¼ˆresolvedï¼‰æ—¶ï¼Œæˆ–è€…å‘ç”Ÿé”™è¯¯å¯¼è‡´Promiseè¢«æ‹’ç»ï¼ˆrejectedï¼‰æ—¶ï¼Œå›è°ƒå‡½æ•°ä¼šè¢«æ·»åŠ åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚</li>
</ul>
</li>
<li><p><strong>åå¤„</strong>ï¼š<code>$.ajax</code> åµŒå¥— 5 å±‚ï¼Œå¯ç»´æŠ¤æ€§å·²ç»æ¥è¿‘äºé›¶äº†</p>
</li>
</ul>
<h5 id="Promise"><a href="#Promise" class="headerlink" title="Promise"></a>Promise</h5><p><code>Callback</code>æ²¡æœ‰å¾ˆå¥½è¡¨ç¤ºæµç¨‹å›¾ -&gt;  <code>Promise</code></p>
<p>Chaining</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title function_">loadScript</span>(<span class="hljs-string">&quot;/article/promise-chaining/one.js&quot;</span>)<br>  .<span class="hljs-title function_">then</span>( <span class="hljs-function"><span class="hljs-params">script</span> =&gt;</span> <span class="hljs-title function_">loadScript</span>(<span class="hljs-string">&quot;/article/promise-chaining/two.js&quot;</span>) )<br>  .<span class="hljs-title function_">then</span>( <span class="hljs-function"><span class="hljs-params">script</span> =&gt;</span> <span class="hljs-title function_">loadScript</span>(<span class="hljs-string">&quot;/article/promise-chaining/three.js&quot;</span>) )<br>  .<span class="hljs-title function_">then</span>( <span class="hljs-function"><span class="hljs-params">script</span> =&gt;</span> &#123;<br>    <span class="hljs-comment">// scripts are loaded, we can use functions declared there</span><br>  &#125;)<br>  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> &#123; ... &#125; );<br></code></pre></td></tr></table></figure>

<hr>
<p>Fork-join</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js">a = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>( <span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123; <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;A&#x27;</span>) &#125; )<br>b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>( <span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123; <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;B&#x27;</span>) &#125; )<br>c = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>( <span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123; <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;C&#x27;</span>) &#125; )<br><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([a, b, c]).<span class="hljs-title function_">then</span>( <span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res) &#125; )<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// å°è£…ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºåŠ è½½ä¸€å¼ å›¾ç‰‡</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">loadImage</span>(<span class="hljs-params">url</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> image = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();<br>    image.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-title function_">resolve</span>(image); <span class="hljs-comment">// å›¾ç‰‡åŠ è½½æˆåŠŸï¼Œå°† Promise æ ‡è®°ä¸ºæˆåŠŸ</span><br>    &#125;;<br>    image.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Failed to load image&#x27;</span>)); <span class="hljs-comment">// å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°† Promise æ ‡è®°ä¸ºå¤±è´¥</span><br>    &#125;;<br>    image.<span class="hljs-property">src</span> = url;<br>  &#125;);<br>&#125;<br><br><span class="hljs-comment">// å›¾ç‰‡åŠ è½½ä»»åŠ¡åˆ—è¡¨</span><br><span class="hljs-keyword">const</span> imageUrls = [<br>  <span class="hljs-string">&#x27;image1.jpg&#x27;</span>,<br>  <span class="hljs-string">&#x27;image2.jpg&#x27;</span>,<br>  <span class="hljs-string">&#x27;image3.jpg&#x27;</span><br>];<br><br><span class="hljs-comment">// ä½¿ç”¨ Promise.all() æ¥å¤„ç†å¤šä¸ªå›¾ç‰‡åŠ è½½ä»»åŠ¡</span><br><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(imageUrls.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">url</span> =&gt;</span> <span class="hljs-title function_">loadImage</span>(url)))<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">images</span> =&gt;</span> &#123;<br>    <span class="hljs-comment">// æ‰€æœ‰å›¾ç‰‡åŠ è½½å®Œæˆï¼Œå¯ä»¥è¿›è¡Œå±•ç¤º</span><br>    images.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">image</span> =&gt;</span> &#123;<br>      <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(image); <span class="hljs-comment">// å‡è®¾å°†å›¾ç‰‡æ·»åŠ åˆ°é¡µé¢ä¸­</span><br>    &#125;);<br>  &#125;)<br>  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> &#123;<br>    <span class="hljs-comment">// å›¾ç‰‡åŠ è½½è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);<br>  &#125;);<br><br></code></pre></td></tr></table></figure>

<h5 id="Async-Await"><a href="#Async-Await" class="headerlink" title="Async-Await"></a>Async-Await</h5><p> ä¸€ç§è®¡ç®—å›¾çš„æè¿°è¯­è¨€.</p>
<p>é€šè¿‡ä½¿ç”¨ <code>async</code> å…³é”®å­—å£°æ˜ä¸€ä¸ªå‡½æ•°ä¸ºå¼‚æ­¥å‡½æ•°(å‡½æ•°ä¼šè¿”å›ä¸€ä¸ª<code>Promise</code>å¯¹è±¡)ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨ <code>await</code> å…³é”®å­—æ¥ç­‰å¾…ä¸€ä¸ª Promise å¯¹è±¡çš„è§£å†³ï¼ˆresolveï¼‰</p>
<p>æ›´ç°ä»£ã€æ›´ä¼˜é›…çš„æ–¹å¼æ¥å¤„ç†å¼‚æ­¥ä»£ç ï¼Œä¸ <code>.then</code> æ–¹æ³•ç›¸æ¯”æ›´æ˜“äºç†è§£å’Œç¼–å†™(é¿å…åµŒå¥—)ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js">A = <span class="hljs-title function_">async</span> () =&gt; <span class="hljs-keyword">await</span> $.<span class="hljs-title function_">ajax</span>(<span class="hljs-string">&#x27;/hello/a&#x27;</span>)<br>B = <span class="hljs-title function_">async</span> () =&gt; <span class="hljs-keyword">await</span> $.<span class="hljs-title function_">ajax</span>(<span class="hljs-string">&#x27;/hello/b&#x27;</span>)<br>C = <span class="hljs-title function_">async</span> () =&gt; <span class="hljs-keyword">await</span> $.<span class="hljs-title function_">ajax</span>(<span class="hljs-string">&#x27;/hello/c&#x27;</span>)<br>hello = <span class="hljs-title function_">async</span> () =&gt; <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([<span class="hljs-title function_">A</span>(), <span class="hljs-title function_">B</span>(), <span class="hljs-title function_">C</span>()])<br><span class="hljs-title function_">hello</span>()<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">alert</span>)<br>  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;fetch failed!&#x27;</span>) &#125; )<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// å¼‚æ­¥å‡½æ•°ç¤ºä¾‹</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;https://api.example.com/data&#x27;</span>);<br>    <span class="hljs-keyword">const</span> data = response.<span class="hljs-property">data</span>;<br>    <span class="hljs-keyword">return</span> data;<br>  &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Failed to fetch data&#x27;</span>);<br>  &#125;<br>&#125;<br><br><br><span class="hljs-comment">// è°ƒç”¨å¼‚æ­¥å‡½æ•°</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Before fetchData()&#x27;</span>);<br><br><span class="hljs-title function_">fetchData</span>()<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Data:&#x27;</span>, data);<br>  &#125;)<br>  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Error:&#x27;</span>, error);<br>  &#125;);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;After fetchData()&#x27;</span>);<br><br><span class="hljs-comment">// res:</span><br>    <span class="hljs-comment">// Before fetchData()</span><br>    <span class="hljs-comment">// After fetchData()</span><br>    <span class="hljs-comment">// Data: [data from API]</span><br></code></pre></td></tr></table></figure>



<h3 id="å¹¶å‘bug"><a href="#å¹¶å‘bug" class="headerlink" title="å¹¶å‘bug"></a>å¹¶å‘bug</h3><ul>
<li>æ­»é”</li>
<li>æ•°æ®ç«äº‰</li>
<li>åŸå­æ€§å’Œé¡ºåºè¿å</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">assert mode in [XRay, Electron]<br>assert mirror in [On, Off]<br>assert <span class="hljs-title function_">not</span> <span class="hljs-params">(mode == XRay and mirror == Off)</span><br></code></pre></td></tr></table></figure>

<h4 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a>æ­»é”</h4><p>è¡¨ç°æ˜æ˜¾ï¼šç¨‹åºåœæ­¢äº†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c">lock(&amp;lk);<br><span class="hljs-comment">// lk = LOCKED;</span><br>lock(&amp;lk);<br><span class="hljs-comment">// while (xchg(&amp;lk, LOCKED) == LOCKED) ;</span><br>	å¤šå±‚å‡½æ•°è°ƒç”¨ã€éšè—çš„æ§åˆ¶æµï¼ˆä¸­æ–­ï¼‰<br>        <br>        <br><span class="hljs-type">void</span> <span class="hljs-title function_">Tphilosopher</span><span class="hljs-params">()</span> &#123;<br>  P(&amp;avail[lhs]);<br>  P(&amp;avail[rhs]);<br>  <span class="hljs-comment">// ...</span><br>  V(&amp;avail[lhs]);<br>  V(&amp;avail[rhs]);<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>Mutual-exclusion - ä¸€å¼ æ ¡å›­å¡åªèƒ½è¢«ä¸€ä¸ªäººæ‹¥æœ‰</li>
<li>Wait-for - ä¸€ä¸ªäººç­‰å…¶ä»–æ ¡å›­å¡æ—¶ï¼Œä¸ä¼šé‡Šæ”¾å·²æœ‰çš„æ ¡å›­å¡</li>
<li>No-preemption - ä¸èƒ½æŠ¢å¤ºä»–äººçš„æ ¡å›­å¡</li>
<li>Circular-chain - å½¢æˆæ ¡å›­å¡çš„å¾ªç¯ç­‰å¾…å…³ç³»</li>
</ul>
<p> <strong>å¤„ç†æ–¹æ³•</strong>ï¼š</p>
<ul>
<li><strong>é¢„é˜²æ­»é”</strong>ï¼ˆä¸€æ¬¡æ€§åˆ†é…èµ„æºï¼› å…è®¸æŠ¢å ï¼› <code>Locker order</code>è§„å®šè·å–é”çš„é¡ºåºï¼Œå¿…é¡»ä»å°åˆ°å¤§ï¼ˆè·å¾—ç¼–å·æœ€å¤§çš„è¿›ç¨‹èƒ½è¿è¡Œï¼‰ï¼‰</li>
<li><strong>é¿å…æ­»é”</strong>ï¼ˆ<strong>é“¶è¡Œå®¶</strong>ï¼šåœ¨ä¸€æ¬¡åˆ†é…å®Œåæ£€æŸ¥æ˜¯å¦æœ‰å®‰å…¨åºåˆ—èƒ½å®ç°å…¨éƒ¨è¿è¡Œï¼‰</li>
<li><strong>ç›‘æµ‹æ­»é”</strong>ï¼ˆ<strong>èµ„æºåˆ†é…å›¾</strong>ï¼Œåˆ†é…å®Œæœ‰æ²¡æœ‰ç¯ï¼‰</li>
<li><strong>è§£é™¤æ­»é”</strong>ï¼ˆèµ„æºå‰¥å¤ºã€å›æ»šè¿›ç¨‹ã€ç»ˆæ­¢è¿›ç¨‹ï¼‰</li>
</ul>
<h4 id="æ•°æ®ç«äº‰"><a href="#æ•°æ®ç«äº‰" class="headerlink" title="æ•°æ®ç«äº‰"></a>æ•°æ®ç«äº‰</h4><p>å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€å†…å­˜è¿›è¡Œè¯»å†™ï¼Œå…ˆå†™è¿˜æ˜¯å…ˆè¯»äº§ç”Ÿçš„ç»“æœä¸åŒã€‚å±±å¯¨æ”¯ä»˜å®åˆ¤æ–­å¹¶ä¿®æ”¹ä½™é¢</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404513.png" srcset="/img/loading.gif" lazyload alt="image-20230530154901555"></p>
<p>å…ˆæ¥å…ˆå†™ï¼Œå¤šä¸ªmemoryï¼Œæ— æ³•å®šä¹‰è°å…ˆæ¥ï¼Œæ‰€ä»¥éœ€è¦é¿å…data raceã€‚ä¸Šé”</p>
<p><strong>ä¸åŒçš„çº¿ç¨‹</strong>åŒæ—¶è®¿é—®<strong>åŒä¸€å†…å­˜</strong>ï¼Œä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™</p>
<ul>
<li>â€œå†…å­˜â€ å¯ä»¥æ˜¯åœ°å€ç©ºé—´ä¸­çš„ä»»ä½•å†…å­˜<ul>
<li>å¯ä»¥æ˜¯å…¨éƒ¨å˜é‡</li>
<li>å¯ä»¥æ˜¯å †åŒºåˆ†é…çš„å˜é‡</li>
<li>å¯ä»¥æ˜¯æ ˆ</li>
</ul>
</li>
<li>â€œè®¿é—®â€ å¯ä»¥æ˜¯ä»»ä½•ä»£ç <ul>
<li>å¯èƒ½å‘ç”Ÿåœ¨ä½ çš„ä»£ç é‡Œ</li>
<li>å¯ä»¥å‘ç”Ÿåœ¨æ¡†æ¶ä»£ç é‡Œ</li>
<li>å¯èƒ½æ˜¯ä¸€è¡Œä½ æ²¡æœ‰è¯»åˆ°è¿‡çš„æ±‡ç¼–ä»£ç </li>
<li>å¯èƒ½æ—¶ä¸€æ¡ ret æŒ‡ä»¤</li>
</ul>
</li>
</ul>
<h4 id="åŸå­æ€§è¿å"><a href="#åŸå­æ€§è¿å" class="headerlink" title="åŸå­æ€§è¿å"></a>åŸå­æ€§è¿å</h4><p>è°ƒæŸ¥100ä¸ªBUGsï¼Œ97% çš„éæ­»é”å¹¶å‘ bug éƒ½æ˜¯<strong>åŸå­æ€§</strong>ï¼ˆå±±å¯¨æ”¯ä»˜å®ï¼‰æˆ–<strong>é¡ºåºé”™è¯¯</strong></p>
<p> <img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404514.png" srcset="/img/loading.gif" lazyload alt="image-20230530161346187"></p>
<h3 id="åº”å¯¹å¹¶å‘bug"><a href="#åº”å¯¹å¹¶å‘bug" class="headerlink" title="åº”å¯¹å¹¶å‘bug"></a>åº”å¯¹å¹¶å‘bug</h3><p>å‡è®¾ç¨‹åºå‘˜ä¼šèŠ±å¼çŠ¯é”™</p>
<p><strong>ç¼–è¯‘å™¨</strong>ï¼šåªç®¡ç¿»è¯‘ä»£ç ï¼Œä¸ç®¡éœ€æ±‚å«ä¹‰</p>
<p>æ€ä¹ˆæ‰èƒ½ç¼–å†™å‡º â€œæ­£ç¡®â€ (ç¬¦åˆ specification) çš„ç¨‹åºï¼Ÿ</p>
<ul>
<li>è¯æ˜ï¼šAnnotation verifier (<a target="_blank" rel="noopener" href="https://dafny-lang.github.io/dafny/">Dafny</a>), <a target="_blank" rel="noopener" href="https://dl.acm.org/doi/10.1145/113446.113468">Refinement types</a></li>
<li>æ¨æµ‹ï¼šSpecification mining (<a target="_blank" rel="noopener" href="http://plse.cs.washington.edu/daikon/">Daikon</a>)</li>
<li>æ„é€ ï¼š<a target="_blank" rel="noopener" href="https://link.springer.com/article/10.1007/s10009-012-0249-7">Program sketching</a></li>
<li>ç¼–ç¨‹è¯­è¨€çš„å†å²å’Œæœªæ¥<ul>
<li>æœºå™¨è¯­è¨€ â†’ æ±‡ç¼–è¯­è¨€ â†’ é«˜çº§è¯­è¨€ â†’ <strong>è‡ªç„¶ç¼–ç¨‹è¯­è¨€</strong></li>
</ul>
</li>
</ul>
<h4 id="é˜²å¾¡æ€§ç¼–ç¨‹"><a href="#é˜²å¾¡æ€§ç¼–ç¨‹" class="headerlink" title="é˜²å¾¡æ€§ç¼–ç¨‹"></a>é˜²å¾¡æ€§ç¼–ç¨‹</h4><p>æœºå™¨æ°¸è¿œæ˜¯å¯¹çš„ï¼Œä»£ç å§‹ç»ˆæ˜¯é”™çš„</p>
<p>é˜²å¾¡æ€§ç¼–ç¨‹ï¼šæŠŠå¯èƒ½ä¸å¯¹çš„æƒ…å†µéƒ½æ£€æŸ¥ä¸€éã€‚<code>assert</code>  å¤§å‹é¡¹ç›®å¾ˆéœ€è¦</p>
<ul>
<li><p>Peterson ç®—æ³•ä¸­çš„ä¸´ç•ŒåŒºè®¡æ•°å™¨</p>
<ul>
<li><code>assert(nest == 1);</code></li>
</ul>
</li>
<li><p>äºŒå‰æ ‘çš„æ—‹è½¬</p>
<ul>
<li><code>assert(p-&gt;parent-&gt;left == p || p-&gt;parent-&gt;right == p);</code></li>
</ul>
</li>
<li><p>AA-Deadlock çš„æ£€æŸ¥</p>
<ul>
<li><code>if (holding(&amp;lk)) panic();</code></li>
<li>xv6 spinlock å®ç°ç¤ºä¾‹</li>
</ul>
</li>
</ul>
<h4 id="è‡ªåŠ¨è¿è¡Œæ—¶æ£€æŸ¥"><a href="#è‡ªåŠ¨è¿è¡Œæ—¶æ£€æŸ¥" class="headerlink" title="è‡ªåŠ¨è¿è¡Œæ—¶æ£€æŸ¥"></a>è‡ªåŠ¨è¿è¡Œæ—¶æ£€æŸ¥</h4><h5 id="Lockdepæ­»é”æ£€æµ‹"><a href="#Lockdepæ­»é”æ£€æµ‹" class="headerlink" title="Lockdepæ­»é”æ£€æµ‹"></a>Lockdepæ­»é”æ£€æµ‹</h5><p><code>Lockdep</code> ï¼šæ­»é”çš„æ£€æŸ¥ã€‚linuxå†…æ ¸</p>
<p>â€‹	æ¯ä¸€ä¸ªé”æœ‰ä¸€ä¸ªå”¯ä¸€çš„siteï¼ˆçº¿ç¨‹æ–‡ä»¶è¡Œå·ï¼‰ï¼Œä¸Šé”è§£é”æ—¥å¿—è®°å½•ä¸‹è¯¥siteã€‚é€šè¿‡æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—æœ‰æ²¡æœ‰ç¯</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">(<span class="hljs-type">lock_t</span> *lk)</span> &#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;LOCK   %s\n&quot;</span>, lk-&gt;site);<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="data-raceæ£€æµ‹"><a href="#data-raceæ£€æµ‹" class="headerlink" title="data raceæ£€æµ‹"></a>data raceæ£€æµ‹</h5><p><code>ThreadSanitizer</code>ï¼šè¿è¡Œæ—¶çš„æ•°æ®ç«äº‰æ£€æŸ¥.ç¼–è¯‘æ—¶å®ç°</p>
<p>ä¸¤ä¸ªè¿›ç¨‹åŒæ—¶è¯»å†™åŒä¸€å†…å­˜ï¼Œæœ‰æ²¡æœ‰happens-beforeå…³ç³»ï¼Œæ²¡æœ‰å°±å­˜åœ¨data race (T1-5 T2-5)</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404515.png" srcset="/img/loading.gif" lazyload alt="image-20230531112908484"></p>
<h4 id="rule-of-thumb"><a href="#rule-of-thumb" class="headerlink" title="rule of thumb"></a>rule of thumb</h4><ul>
<li>ä¸å®ç° â€œå®Œæ•´â€ çš„æ£€æŸ¥</li>
<li>å…è®¸å­˜åœ¨è¯¯æŠ¥&#x2F;æ¼æŠ¥</li>
<li>ä½†å®ç°ç®€å•ã€éå¸¸æœ‰ç”¨</li>
</ul>
<h5 id="canary"><a href="#canary" class="headerlink" title="canary"></a>canary</h5><p>â€œç‰ºç‰²â€ ä¸€äº›å†…å­˜å•å…ƒï¼Œæ¥é¢„è­¦ memory error çš„å‘ç”Ÿã€‚æ ˆç©ºé—´å¤šåˆ†é…ä¸€äº›<code>canary</code>ç©ºé—´ä½œä¸ºä¿æŠ¤ï¼Œå€¼è¢«ä¿®æ”¹äº†å°±å¼‚å¸¸äº†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAGIC 0x55555555</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BOTTOM (STK_SZ / sizeof(u32) - 1)</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stack</span> &#123;</span> <span class="hljs-type">char</span> data[STK_SZ]; &#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">canary_init</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">stack</span> *s)</span> &#123;<br>  u32 *ptr = (u32 *)s;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; CANARY_SZ; i++)<br>    ptr[BOTTOM - i] = ptr[i] = MAGIC;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">canary_check</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">stack</span> *s)</span> &#123;<br>  u32 *ptr = (u32 *)s;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; CANARY_SZ; i++) &#123;<br>    panic_on(ptr[BOTTOM - i] != MAGIC, <span class="hljs-string">&quot;underflow&quot;</span>);<br>    panic_on(ptr[i] != MAGIC, <span class="hljs-string">&quot;overflow&quot;</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>msvc ä¸­ debug mode çš„ guard&#x2F;fence&#x2F;canary</p>
<ul>
<li>æœªåˆå§‹åŒ–æ ˆ: <code>0xcccccccc </code>  çƒ«</li>
<li>æœªåˆå§‹åŒ–å †: <code>0xcdcdcdcd </code> å±¯</li>
<li>å¯¹è±¡å¤´å°¾: <code>0xfdfdfdfd</code></li>
</ul>
<h5 id="ä½é…lockdep"><a href="#ä½é…lockdep" class="headerlink" title="ä½é…lockdep"></a>ä½é…lockdep</h5><p>ç»Ÿè®¡è‡ªæ—‹çš„æ¬¡æ•°ï¼Œè¶…è¿‡æŸä¸ªå€¼è‚¯å®šä¸æ­£å¸¸</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">while</span> (xchg(&amp;lk, LOCKED) == LOCKED) &#123;<br>  <span class="hljs-keyword">if</span> (count++ &gt; SPIN_LIMIT) &#123;<br>    panic(<span class="hljs-string">&quot;Spin limit exceeded @ %s:%d\n&quot;</span>, __FILE__, __LINE__);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="ä½é…AddressSanitizer"><a href="#ä½é…AddressSanitizer" class="headerlink" title="ä½é…AddressSanitizer"></a>ä½é…AddressSanitizer</h5><p>å¹¶å‘åˆ†é…å†…å­˜æ—¶ï¼Œåˆ†é…å®Œæ ‡è®°ä¸€ä¸ªé¢œè‰²</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// allocation</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; (i + <span class="hljs-number">1</span>) * <span class="hljs-keyword">sizeof</span>(u32) &lt;= size; i++) &#123;<br>  panic_on(((u32 *)ptr)[i] == MAGIC, <span class="hljs-string">&quot;double-allocation&quot;</span>);<br>  arr[i] = MAGIC;<br>&#125;<br><br><span class="hljs-comment">// free</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; (i + <span class="hljs-number">1</span>) * <span class="hljs-keyword">sizeof</span>(u32) &lt;= alloc_size(ptr); i++) &#123;<br>  panic_on(((u32 *)ptr)[i] == <span class="hljs-number">0</span>, <span class="hljs-string">&quot;double-free&quot;</span>);<br>  arr[i] = <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="å¤šå¤„ç†å™¨ä¸ä¸­æ–­"><a href="#å¤šå¤„ç†å™¨ä¸ä¸­æ–­" class="headerlink" title="å¤šå¤„ç†å™¨ä¸ä¸­æ–­"></a>å¤šå¤„ç†å™¨ä¸ä¸­æ–­</h3><p>å¤„ç†å™¨å¦‚ä½•å®ç°å¤šçº¿ç¨‹ï¼Ÿä¸­æ–­</p>
<p><strong>æœ¬è®²å†…å®¹</strong>ï¼šæ“ä½œç³»ç»Ÿå†…æ ¸å®ç°ã€‚</p>
<ul>
<li>å¤šå¤„ç†å™¨å’Œä¸­æ–­</li>
<li>AbstractMachine API</li>
<li>50 è¡Œå®ç°åµŒå…¥å¼æ“ä½œç³»ç»Ÿ</li>
</ul>
<p>å¤šå¤„ç†å™¨çš„çŠ¶æ€æœºæ¨¡å‹ï¼šçŠ¶æ€ä¸ºå†…å­˜å’Œæ¯ä¸€ä¸ªçŠ¶æ€ã€‚æ‰§è¡Œä¸º<strong>ä»»é€‰</strong>ä¸€ä¸ª<code>cpu</code></p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404516.png" srcset="/img/loading.gif" lazyload alt="image-20230601105219177"></p>
<p>å¦‚æœæ­»å¾ªç¯æŸä¸ªCPUå°±ä¼šå¡æ­»ï¼Œè€Œä¸ºä»€ä¹ˆæˆ‘ä»¬å†™çš„æ­»å¾ªç¯ç¨‹åºä¸ä¼šå¡æ­»ç”µè„‘ï¼Ÿ</p>
<h4 id="ä¸­æ–­"><a href="#ä¸­æ–­" class="headerlink" title="ä¸­æ–­"></a>ä¸­æ–­</h4><p>ä¸‹é™æ²¿è§¦å‘çš„ä¸€æ ¹çº¿ã€‚IFå¯„å­˜å™¨(interrupter flag) å†³å®šæ˜¯å¦å“åº”ä¸­æ–­ï¼ˆæ“ä½œç³»ç»Ÿå¯ä»¥ä¿®æ”¹è¯¥å€¼ï¼‰</p>
<img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404517.png" srcset="/img/loading.gif" lazyload alt="image-20230601111009780" style="zoom:50%;" />

<ul>
<li>x86 Family<ul>
<li>è¯¢é—®ä¸­æ–­æ§åˆ¶å™¨è·å¾—ä¸­æ–­å· n</li>
<li>ä¿å­˜ CS, RIP, RFLAGS, SS, RSP åˆ°å †æ ˆ</li>
<li>è·³è½¬åˆ° <code>IDT[n]</code> æŒ‡å®šçš„åœ°å€ï¼Œå¹¶è®¾ç½®å¤„ç†å™¨çŠ¶æ€ (ä¾‹å¦‚å…³é—­ä¸­æ–­)</li>
</ul>
</li>
</ul>
<p>å…³ä¸­æ–­å®ç°äº† â€œstop the worldâ€  ï¼Œå°è¯•<code>asm volatile (&quot;cli&quot;)</code>è¢«æ“ä½œç³»ç»Ÿæ£€æµ‹åˆ°ï¼Œä¼šç›´æ¥æŠ¥é”™</p>
<h4 id="ä¸Šä¸‹æ–‡ä¿å­˜"><a href="#ä¸Šä¸‹æ–‡ä¿å­˜" class="headerlink" title="ä¸Šä¸‹æ–‡ä¿å­˜"></a>ä¸Šä¸‹æ–‡ä¿å­˜</h4><p>æ‰€æœ‰çº¿ç¨‹éƒ½æœ‰ä¸€å—å†…å­˜ç”¨æ¥ä¿å­˜è‡ªå·±çš„ç°åœº</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Context</span> &#123;</span><br>    uint64_ t rax, rbx, rcx, rdx,<br>        rbp, rsi, rdi,<br>        r8ï¼Œr9ï¼Œr10, r11,<br>        r12ï¼Œr13ï¼Œ r14ï¼Œ r15,<br>        rip, cs, rflags,<br>        rsp, ss, rsp0; <br>&#125;;<br></code></pre></td></tr></table></figure>

<p>ä¸­æ–­å¤„ç†ï¼šä¿å­˜å½“å‰çš„ctxï¼Œå¹¶è¿”å›è¿è¡Œåœ¨è¯¥cpuä¸Šçš„å¦ä¸€ä¸ªçº¿ç¨‹çš„ä¸Šä¸‹æ–‡</p>
<ul>
<li><code>tasks[n]</code>æ˜¯å†…å­˜ä¸­æ‰€æœ‰çº¿ç¨‹çš„çŠ¶æ€ã€‚nextæŒ‡é’ˆæŠŠæ‰€æœ‰çŠ¶æ€ä¸²è”</li>
<li><code>currents[MAX_CPU]</code> æ˜¯æ¯ä¸€ä¸ªcpuå½“å‰çš„çŠ¶æ€ï¼Œéƒ½æŒ‡å‘tasksä¸­çš„æŸä¸€ä¸ª</li>
<li><code>current=currents[cpu_current()]</code>æ˜¯å½“å‰cpuçŠ¶æ€æŒ‡é’ˆï¼Œ<code>current-&gt;context = ctx</code>ä¿å­˜ç°åœºåˆ°å†…å­˜</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c">Task *currents[MAX_CPU];<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> current currents[cpu_current()]</span><br><br>Context *<span class="hljs-title function_">on_interrupt</span><span class="hljs-params">(Event ev, Context *ctx)</span> &#123;<br>  <span class="hljs-keyword">if</span> (!current) &#123;<br>    current = &amp;tasks[<span class="hljs-number">0</span>];  <span class="hljs-comment">// First trap for this CPU</span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    current-&gt;context = ctx; <span class="hljs-comment">// Keep the stack-saved context</span><br>  &#125;<br><br>  <span class="hljs-comment">// Schedule</span><br>  <span class="hljs-keyword">do</span> &#123;<br>    current = current-&gt;next;<br>  &#125; <span class="hljs-keyword">while</span> (!on_this_cpu(current)); <span class="hljs-comment">// ((current - tasks) % cpu_count() != cpu_current());</span><br><br>  <span class="hljs-keyword">return</span> current-&gt;context;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="50è¡Œæ“ä½œç³»ç»Ÿ"><a href="#50è¡Œæ“ä½œç³»ç»Ÿ" class="headerlink" title="50è¡Œæ“ä½œç³»ç»Ÿ"></a>50è¡Œæ“ä½œç³»ç»Ÿ</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;am.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;klib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;klib-macros.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_CPU 8</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">task</span> &#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">task</span> *<span class="hljs-title">next</span>;</span><br>    <span class="hljs-type">void</span>      (*entry)(<span class="hljs-type">void</span> *);<br>    Context    *context;<br>  &#125;;<br>  <span class="hljs-type">uint8_t</span> <span class="hljs-built_in">stack</span>[<span class="hljs-number">8192</span>];<br>&#125; Task;  <span class="hljs-comment">// A &quot;state machine&quot;</span><br><br>Task *currents[MAX_CPU];<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> current currents[cpu_current()]</span><br><br><span class="hljs-type">int</span> locked = <span class="hljs-number">0</span>;  <span class="hljs-comment">// A spin lock</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span>   &#123; <span class="hljs-keyword">while</span> (<span class="hljs-type">atomic_xchg</span>(&amp;locked, <span class="hljs-number">1</span>)); &#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> &#123; <span class="hljs-type">atomic_xchg</span>(&amp;locked, <span class="hljs-number">0</span>); &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;tasks.h&quot;</span></span><br><br>Context *<span class="hljs-title function_">on_interrupt</span><span class="hljs-params">(Event ev, Context *ctx)</span> &#123;<br>  <span class="hljs-keyword">if</span> (!current) current = &amp;tasks[<span class="hljs-number">0</span>];  <span class="hljs-comment">// First interrupt</span><br>  <span class="hljs-keyword">else</span> current-&gt;context = ctx;  <span class="hljs-comment">// Save pointer to stack-saved context</span><br>  <span class="hljs-keyword">do</span> &#123;<br>    current = current-&gt;next;<br>  &#125; <span class="hljs-keyword">while</span> ((current - tasks) % cpu_count() != cpu_current());<br>  <span class="hljs-keyword">return</span> current-&gt;context;  <span class="hljs-comment">// Restore a new context</span><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">mp_entry</span><span class="hljs-params">()</span> &#123;<br>  yield();  <span class="hljs-comment">// Self-trap; never returns</span><br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>  cte_init(on_interrupt);<br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; LENGTH(tasks); i++) &#123;<br>    Task *task    = &amp;tasks[i];<br>    Area <span class="hljs-built_in">stack</span>    = (Area) &#123; &amp;task-&gt;context + <span class="hljs-number">1</span>, task + <span class="hljs-number">1</span> &#125;; <span class="hljs-comment">// æ ˆèµ·å§‹ç»“æŸåœ°å€</span><br>    task-&gt;context = kcontext(<span class="hljs-built_in">stack</span>, task-&gt;entry, (<span class="hljs-type">void</span> *)task-&gt;name); <br>    task-&gt;next    = &amp;tasks[(i + <span class="hljs-number">1</span>) % LENGTH(tasks)];<br>  &#125;<br>  mpe_init(mp_entry);<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// User-defined tasks</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">func</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span> &#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>    lock();<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Thread-%s on CPU #%d\n&quot;</span>, arg, cpu_current());<br>    unlock();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-keyword">volatile</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; i++) ;<br>  &#125;<br>&#125;<br><br>Task tasks[] = &#123;<br>  &#123; .name = <span class="hljs-string">&quot;A&quot;</span>, .entry = func &#125;,<br>  &#123; .name = <span class="hljs-string">&quot;B&quot;</span>, .entry = func &#125;,<br>  &#123; .name = <span class="hljs-string">&quot;C&quot;</span>, .entry = func &#125;,<br>  &#123; .name = <span class="hljs-string">&quot;D&quot;</span>, .entry = func &#125;,<br>  &#123; .name = <span class="hljs-string">&quot;E&quot;</span>, .entry = func &#125;,<br>&#125;;<br></code></pre></td></tr></table></figure>



<h2 id="å†…æ ¸"><a href="#å†…æ ¸" class="headerlink" title="å†…æ ¸"></a>å†…æ ¸</h2><h3 id="fork-execv-exit"><a href="#fork-execv-exit" class="headerlink" title="fork execv exit"></a>fork execv exit</h3><ul>
<li>åº”ç”¨ç¨‹åº &#x3D; çº¯ç²¹è®¡ç®—ï¼ˆPython ä»£ç ï¼‰ + <code>syscall</code>ï¼›  			çŠ¶æ€æœº</li>
<li>æ“ä½œç³»ç»Ÿ &#x3D; <code>syscall</code>å®ç°ï¼šé‡è¦çš„ä¸‰ä¸ªç³»ç»Ÿè°ƒç”¨<ul>
<li>fork: å¯¹å½“å‰çŠ¶æ€æœºçŠ¶æ€è¿›è¡Œå®Œæ•´å¤åˆ¶</li>
<li>execve: å°†å½“å‰çŠ¶æ€æœºçŠ¶æ€é‡ç½®ä¸ºæŸä¸ªå¯æ‰§è¡Œæ–‡ä»¶æè¿°çš„çŠ¶æ€æœº</li>
<li>exit: é”€æ¯å½“å‰çŠ¶æ€æœº</li>
</ul>
</li>
</ul>
<h4 id="fork"><a href="#fork" class="headerlink" title="fork"></a>fork</h4><p><code>fork</code>: <strong>å®Œå…¨</strong>å¤åˆ¶ä¸€ä»½å½“å‰çš„çŠ¶æ€ (å†…å­˜ã€å¯„å­˜å™¨ç°åœº)ï¼Œç›¸å½“äºåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œè¿”å›å­è¿›ç¨‹å·ã€‚<code>unix</code>å”¯ä¸€æ–¹æ³•</p>
<p>å› ä¸ºçŠ¶æ€æœºæ˜¯å¤åˆ¶çš„ï¼Œå› æ­¤æ€»èƒ½æ‰¾åˆ° â€œçˆ¶å­å…³ç³»â€</p>
<ul>
<li>å› æ­¤æœ‰äº†è¿›ç¨‹æ ‘ (<code>pstree</code>)</li>
</ul>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs coq">systemd-+-ModemManager--<span class="hljs-number">-2</span>*[&#123;ModemManager&#125;]<br>        |<span class="hljs-type">-NetworkManager</span>--<span class="hljs-number">-2</span>*[&#123;NetworkManager&#125;]<br>        |<span class="hljs-type">-accounts</span>-daemon--<span class="hljs-number">-2</span>*[&#123;accounts-daemon&#125;]<br>        |<span class="hljs-type">-at</span>-spi-bus-laun-+-dbus-daemon<br>        |                 <span class="hljs-type">`-3</span>*[&#123;<span class="hljs-built_in">at</span>-spi-bus-laun&#125;]<br>        |<span class="hljs-type">-at</span>-spi2-registr--<span class="hljs-number">-2</span>*[&#123;<span class="hljs-built_in">at</span>-spi2-registr&#125;]<br>        |<span class="hljs-type">-atd</span><br>        |<span class="hljs-type">-avahi</span>-daemon---avahi-daemon<br>        |<span class="hljs-type">-colord</span>--<span class="hljs-number">-2</span>*[&#123;colord&#125;]<br>        ...<br></code></pre></td></tr></table></figure>

<p>1ä¸ªå˜æˆäº†4ä¸ªã€‚forkå‡ºæ¥çš„å­è¿›ç¨‹ä¹Ÿä¼šæ‰§è¡Œä¸‹é¢çš„fork(), é™¤äº†xä¸ä¸€æ ·å…¶ä»–éƒ½ä¸€æ ·</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">pid_t</span> x = fork();<br><span class="hljs-type">pid_t</span> y = fork();<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d %d\n&quot;</span>, x, y);<br></code></pre></td></tr></table></figure>

<p>æ‰“å°äº†å¤šå°‘ä¸ªï¼Ÿ  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++) &#123;<br>  fork();<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Hello\n&quot;</span>);<br>&#125;<br><br>./a.out          <span class="hljs-number">6</span>ä¸ª<br>./a.out | cat    <span class="hljs-number">8</span>ä¸ª  å› ä¸ºå¦‚æœè¾“å…¥åˆ°ç®¡é“ï¼Œprintçš„ä¿¡æ¯ä¼šæ”¾åˆ°ç¼“å­˜ä¸­ï¼Œè¢«åŒæ—¶å¤åˆ¶<br></code></pre></td></tr></table></figure>

<h4 id="execv"><a href="#execv" class="headerlink" title="execv"></a>execv</h4><p><code>execv</code> ï¼š</p>
<ul>
<li>å°†å½“å‰è¿›ç¨‹<strong>é‡ç½®</strong>æˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æè¿°çŠ¶æ€æœºçš„åˆå§‹çŠ¶æ€</li>
<li>å”¯ä¸€èƒ½å¤Ÿæ‰§è¡Œç¨‹åºçš„ç³»ç»Ÿè°ƒç”¨ï¼Œä¸€åˆ‡ç¨‹åºçš„<strong>èµ·ç‚¹</strong>ï¼ˆforkæ˜¯çˆ¶è¿›ç¨‹è°ƒç”¨çš„ï¼‰</li>
<li>ä¼ å…¥<strong>å‚æ•°</strong>å’Œ<strong>ç¯å¢ƒå˜é‡</strong></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">execve</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename,</span><br><span class="hljs-params">           <span class="hljs-type">char</span> * <span class="hljs-type">const</span> argv[], <span class="hljs-type">char</span> * <span class="hljs-type">const</span> envp[])</span>;<br><br>ls -al <br><span class="hljs-title function_">execve</span><span class="hljs-params">(<span class="hljs-string">&quot; /usr/bin/ls&quot;</span>, [<span class="hljs-string">&quot;ls&quot;</span>ï¼Œ <span class="hljs-string">&quot;-al&quot;</span>]ï¼Œ <span class="hljs-number">0x7ffeaabcda88</span> <span class="hljs-comment">/* 54 vars */</span>)</span> = <span class="hljs-number">0</span> <br></code></pre></td></tr></table></figure>

<p>ç¯å¢ƒå˜é‡ï¼Œé»˜è®¤ç»§æ‰¿çˆ¶è¿›ç¨‹</p>
<ul>
<li>ä½¿ç”¨<code>env</code>å‘½ä»¤æŸ¥çœ‹<ul>
<li><code>PATH</code>: å¯æ‰§è¡Œæ–‡ä»¶æœç´¢è·¯å¾„</li>
<li><code>PWD</code>: å½“å‰è·¯å¾„</li>
<li><code>HOME</code>: home ç›®å½•</li>
<li><code>DISPLAY</code>: å›¾å½¢è¾“å‡º</li>
<li><code>PS1</code>: shell çš„æç¤ºç¬¦</li>
</ul>
</li>
<li><code>export</code>: å‘Šè¯‰ shell åœ¨åˆ›å»ºå­è¿›ç¨‹æ—¶è®¾ç½®ç¯å¢ƒå˜é‡<ul>
<li>å°æŠ€å·§ï¼š<code>export ARCH=x86_64-qemu</code> æˆ– <code>export ARCH=native</code></li>
</ul>
</li>
</ul>
<p>strace gcc  gccä¼šå…ˆå»æ‰¾å¯æ‰§è¡Œçš„<code>as</code>æ±‡ç¼–å™¨ç¨‹åºï¼Œå»pathé‡Œæ‰¾ï¼Œæ‰€ä»¥ä¼šè¾“å‡ºï¼š</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">pid 28369</span>] execve(<span class="hljs-string">&quot;/usr/local/sbin/as&quot;</span>, [<span class="hljs-string">&quot;as&quot;</span>, <span class="hljs-string">&quot;--64&quot;</span>, ...<br>[<span class="hljs-meta">pid 28369</span>] execve(<span class="hljs-string">&quot;/usr/local/bin/as&quot;</span>, [<span class="hljs-string">&quot;as&quot;</span>, <span class="hljs-string">&quot;--64&quot;</span>, ...<br>[<span class="hljs-meta">pid 28369</span>] execve(<span class="hljs-string">&quot;/usr/sbin/as&quot;</span>, [<span class="hljs-string">&quot;as&quot;</span>, <span class="hljs-string">&quot;--64&quot;</span>, ...<br>[<span class="hljs-meta">pid 28369</span>] execve(<span class="hljs-string">&quot;/usr/bin/as&quot;</span>, [<span class="hljs-string">&quot;as&quot;</span>, <span class="hljs-string">&quot;--64&quot;</span>, ..<br></code></pre></td></tr></table></figure>

<h4 id="exit"><a href="#exit" class="headerlink" title="exit"></a>exit</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> _exit(<span class="hljs-type">int</span> status)<br>    é”€æ¯å½“å‰çŠ¶æ€æœºï¼Œå¹¶å…è®¸æœ‰ä¸€ä¸ªè¿”å›å€¼<br>    å­è¿›ç¨‹ç»ˆæ­¢ä¼šé€šçŸ¥çˆ¶è¿›ç¨‹ (åç»­è¯¾ç¨‹è§£é‡Š)<br></code></pre></td></tr></table></figure>

<p> exit çš„å‡ ç§å†™æ³• (å®ƒä»¬æ˜¯ä¸åŒ)</p>
<ul>
<li>exit(0)   	stdlib.hä¸­å£°æ˜çš„ libc å‡½æ•°<ul>
<li>ä¼šè°ƒç”¨ <code>atexit</code></li>
</ul>
</li>
<li><code>_exit(0)</code>  glibc çš„ syscall wrapper<ul>
<li>æ‰§è¡Œ â€œexit_groupâ€ ç³»ç»Ÿè°ƒç”¨ç»ˆæ­¢æ•´ä¸ªè¿›ç¨‹ (æ‰€æœ‰çº¿ç¨‹)<ul>
<li>ç»†å¿ƒçš„åŒå­¦å·²ç»åœ¨ strace ä¸­å‘ç°äº†</li>
</ul>
</li>
<li>ä¸ä¼šè°ƒç”¨ <code>atexit</code></li>
</ul>
</li>
<li><code>syscall(SYS_exit, 0)</code><ul>
<li>æ‰§è¡Œ â€œ<code>exit</code>â€ ç³»ç»Ÿè°ƒç”¨ç»ˆæ­¢å½“å‰çº¿ç¨‹</li>
<li>ä¸ä¼šè°ƒç”¨ <code>atexit</code></li>
</ul>
</li>
</ul>
<h4 id="shellä¸­è¿è¡Œ-a-out"><a href="#shellä¸­è¿è¡Œ-a-out" class="headerlink" title="shellä¸­è¿è¡Œ.&#x2F;a.out:"></a>shellä¸­è¿è¡Œ.&#x2F;a.out:</h4><ol>
<li>Shellè§£æå‘½ä»¤è¡Œè¾“å…¥ï¼Œå‘ç°<code>./a.out</code>æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚</li>
<li>Shellè°ƒç”¨<code>fork()</code>ç³»ç»Ÿè°ƒç”¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„å­è¿›ç¨‹ã€‚å­è¿›ç¨‹å¤åˆ¶çˆ¶è¿›ç¨‹çš„æ‰€æœ‰èµ„æºå’Œä»£ç æ®µã€‚</li>
<li>å­è¿›ç¨‹è°ƒç”¨<code>execve()</code>ç³»ç»Ÿè°ƒç”¨ï¼ŒåŠ è½½å¹¶æ‰§è¡Œ<code>a.out</code>å¯æ‰§è¡Œæ–‡ä»¶ã€‚<ol>
<li>å¦‚æœå¯æ‰§è¡Œæ–‡ä»¶éœ€è¦è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œä¾‹å¦‚è¯»å–æ–‡ä»¶æˆ–å†™å…¥æ–‡ä»¶ï¼Œå®ƒä¼šä½¿ç”¨ç›¸åº”çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚<code>open()</code>ã€<code>read()</code>ã€<code>write()</code>ç­‰ã€‚</li>
<li>å½“å¯æ‰§è¡Œæ–‡ä»¶æ‰§è¡Œå®Œæ¯•æˆ–è°ƒç”¨äº†<code>exit()</code>ç³»ç»Ÿè°ƒç”¨æ¥ç»ˆæ­¢è¿›ç¨‹æ—¶ï¼Œè¿›ç¨‹ä¼šè¿”å›åˆ°Shellã€‚</li>
</ol>
</li>
<li>shell <code>wail()</code>ç­‰å¾…å­è¿›ç¨‹(å¦‚æœåå°è¿è¡Œ<code>&amp;</code>å°±ä¸ä¼šç­‰å¾…)</li>
</ol>
<p>Shellæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªè¿›ç¨‹<code>/bin/bash</code>ï¼Œåˆå§‹çŠ¶æ€è¯»å–é…ç½®æ–‡ä»¶<code>~/.bashrc</code>ã€‚è¾“å…¥ï¼š</p>
<ul>
<li>æ‰§è¡Œå†…éƒ¨å‘½ä»¤ï¼ˆä¾‹å¦‚<code>cd</code>æˆ–<code>echo</code>ï¼‰</li>
<li>æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼ˆä¾‹å¦‚<code>ls</code>æˆ–<code>grep</code>ï¼‰ï¼ˆæœ¬è´¨ä¸Šä¹Ÿæ˜¯å¯æ‰§è¡Œæ–‡ä»¶ï¼‰</li>
<li>å¯æ‰§è¡Œæ–‡ä»¶</li>
</ul>
<h3 id="Linuxä¸­çš„init"><a href="#Linuxä¸­çš„init" class="headerlink" title="Linuxä¸­çš„init"></a>Linuxä¸­çš„init</h3><ul>
<li>Linux æ“ä½œç³»ç»Ÿ</li>
<li>Linux ç³»ç»Ÿå¯åŠ¨å’Œ initramfs</li>
<li>Linux åº”ç”¨ä¸–ç•Œçš„æ„å»º</li>
</ul>
<p>just for fun</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">Hello, everybody out there using minix â€“ Iâ€™m doing a (free) operating system (<span class="hljs-keyword">just </span>a hobby, wonâ€™t <span class="hljs-keyword">be </span><span class="hljs-keyword">big </span><span class="hljs-keyword">and </span>professional like gnu) for <span class="hljs-number">386</span>(<span class="hljs-number">486</span>) <span class="hljs-built_in">AT</span> <span class="hljs-keyword">clones. </span>This has <span class="hljs-keyword">been </span><span class="hljs-keyword">brewing </span>since April, <span class="hljs-keyword">and </span>is starting to get ready.<br>â€”â€” Linus Torvalds (æ—¶å¹´ <span class="hljs-number">21</span> å²)<br></code></pre></td></tr></table></figure>

<p><code>Minix</code>: å®Œå…¨ç”¨äºæ•™å­¦çš„çœŸå®æ“ä½œç³»ç»Ÿ 1987ã€‚Andrew Tanenbaumã€‚  <code>Linux</code> çš„èµ·ç‚¹</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404518.png" srcset="/img/loading.gif" lazyload alt="image-20230604102002909"></p>
<h4 id="Kernel"><a href="#Kernel" class="headerlink" title="Kernel"></a>Kernel</h4><ul>
<li>åŠ è½½ç¬¬ä¸€ä¸ªè¿›ç¨‹<ul>
<li>ç›¸å½“äºåœ¨æ“ä½œç³»ç»Ÿä¸­ â€œæ”¾ç½®ä¸€ä¸ªä½äºåˆå§‹çŠ¶æ€çš„çŠ¶æ€æœºâ€ **init **    <strong>systemd</strong> </li>
<li>Single user model (é«˜æƒé™)</li>
</ul>
</li>
<li>åŒ…å«ä¸€äº›è¿›ç¨‹å¯æ“çºµçš„æ“ä½œç³»ç»Ÿå¯¹è±¡</li>
<li>é™¤æ­¤ä¹‹å¤– â€œä»€ä¹ˆä¹Ÿæ²¡æœ‰â€<ul>
<li>Linux å˜ä¸ºä¸€ä¸ªä¸­æ–­ (ç³»ç»Ÿè°ƒç”¨) å¤„ç†ç¨‹åº</li>
</ul>
</li>
</ul>
<p>Linux Kernel ç³»ç»Ÿè°ƒç”¨ä¸Šçš„å‘è¡Œç‰ˆå’Œåº”ç”¨ç”Ÿæ€</p>
<ul>
<li>ç³»ç»Ÿå·¥å…· <a target="_blank" rel="noopener" href="https://www.gnu.org/software/coreutils/coreutils.html">coreutils</a>, <a target="_blank" rel="noopener" href="https://www.gnu.org/software/binutils/">binutils</a>, <a target="_blank" rel="noopener" href="https://systemd.io/">systemd</a>, â€¦</li>
<li>æ¡Œé¢ç³»ç»Ÿ Gnome, xfce, Android</li>
<li>åº”ç”¨ç¨‹åº file manager, vscode, â€¦</li>
</ul>
<h4 id="ç¬¬ä¸€ä¸ªçŠ¶æ€æœº"><a href="#ç¬¬ä¸€ä¸ªçŠ¶æ€æœº" class="headerlink" title="ç¬¬ä¸€ä¸ªçŠ¶æ€æœº"></a>ç¬¬ä¸€ä¸ªçŠ¶æ€æœº</h4><p>1.æˆ‘ä»¬å¯ä»¥æ§åˆ¶initç¨‹åºæ˜¯è°ï¼Œæ¯”å¦‚æœ€ç®€å•çš„<code>helloword</code>ã€‚å½“<code>helloword</code> é€€å‡ºåï¼Œä¹Ÿå°±æ˜¯æ€æ­»æœ€åä¸€ä¸ªè¿›ç¨‹ï¼ŒKernel panic</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh">INIT := /init<br><span class="hljs-comment"># INIT := /minimal</span><br><br>run:<br><span class="hljs-comment"># Run QEMU with the installed kernel and generated initramfs</span><br>	qemu-system-x86_64 \<br>	  -serial mon:stdio \ <br>	  -kernel build/vmlinuz \<br>	  -initrd build/initramfs.cpio.gz \<br>	  -machine accel=kvm:tcg \<br>	  -append <span class="hljs-string">&quot;console=ttyS0 quiet rdinit=<span class="hljs-subst">$(INIT)</span>&quot;</span><br></code></pre></td></tr></table></figure>

<p>2.æ”¹å›å¯åŠ¨Initç¨‹åºï¼Œå…¶ä¸­<code>busybox</code> æ˜¯ä¸€ä¸ªç¨‹åºï¼Œä½†åŒ…å«å¾ˆå¤šæ–‡ä»¶ 5000è¡Œ     <code>busybox  vi</code>      <code>busybox  sh</code>ï¼Œå› æ­¤æˆ‘ä»¬çš„initç¨‹åºå°±å¯ä»¥ä½¿ç”¨å‘½ä»¤äº†ï¼Œå†é€šè¿‡è½¯è¿æ¥å°±å¯ä»¥ç›´æ¥æ‰§è¡Œäº†</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/busybox sh</span><br><br><span class="hljs-comment"># initrd, only busybox and /init</span><br>BB=/bin/busybox<br><br><span class="hljs-comment"># (1) Print something and exit</span><br><span class="hljs-variable">$BB</span> <span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;\033[31mHello, OS World\033[0m&quot;</span><br><span class="hljs-variable">$BB</span> poweroff -f<br><br><span class="hljs-comment"># (2) Run a shell on the init console</span><br><span class="hljs-variable">$BB</span> sh<br><br><span class="hljs-comment"># (3) Rock&#x27;n Roll!</span><br><span class="hljs-keyword">for</span> cmd <span class="hljs-keyword">in</span> $(<span class="hljs-variable">$BB</span> --list); <span class="hljs-keyword">do</span><br>  <span class="hljs-variable">$BB</span> <span class="hljs-built_in">ln</span> -s <span class="hljs-variable">$BB</span> /bin/<span class="hljs-variable">$cmd</span><br><span class="hljs-keyword">done</span><br>    <span class="hljs-comment"># /bin/ls -&gt; /bin/busybox</span><br>    <span class="hljs-comment"># /bin/cat -&gt; /bin/busybox</span><br>    <span class="hljs-comment"># /bin/grep -&gt; /bin/busybox</span><br><span class="hljs-built_in">mkdir</span> -p /tmp<br><span class="hljs-built_in">mkdir</span> -p /proc &amp;&amp; mount -t proc  none /proc<br><span class="hljs-built_in">mkdir</span> -p /sys  &amp;&amp; mount -t sysfs none /sys<br><span class="hljs-built_in">mknod</span> /dev/tty c 4 1<br>setsid /bin/sh &lt;/dev/tty &gt;/dev/tty 2&gt;&amp;1<br></code></pre></td></tr></table></figure>

<p>è‡³æ­¤æˆ‘ä»¬é€šè¿‡initå¯åŠ¨äº†ä¸€ä¸ªç‹¬ç«‹shï¼Œshä¸­å¯ä»¥æ‰§è¡Œæˆ‘ä»¬çš„æŒ‡ä»¤</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs vim">å¦‚æœæˆ‘ä»¬æ”¾ä¸€ä¸ª<span class="hljs-keyword">vi</span> &amp; åœ¨åå°<br># pstree<br>init---<span class="hljs-keyword">sh</span>---pstree<br>           -<span class="hljs-keyword">vi</span><br>           <br>æŒ‡ä»¤éƒ½æ˜¯æŒ‡å‘busyboxï¼Œbusyboxé€šè¿‡ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°(æ‰§è¡Œçš„åç§°)å®ç°ä¸åŒçš„å‘½ä»¤<br></code></pre></td></tr></table></figure>

<h4 id="å…¶ä»–å·¥ä½œ"><a href="#å…¶ä»–å·¥ä½œ" class="headerlink" title="å…¶ä»–å·¥ä½œ"></a>å…¶ä»–å·¥ä½œ</h4><p>åªæ˜¯ä¸€ä¸ªå†…å­˜é‡Œçš„å°æ–‡ä»¶ç³»ç»Ÿ</p>
<ul>
<li>æˆ‘ä»¬ â€œçœ‹åˆ°â€ çš„éƒ½æ˜¯è¢« init åˆ›é€ å‡ºæ¥çš„<ul>
<li>åŠ è½½å‰©ä½™å¿…è¦çš„é©±åŠ¨ç¨‹åºï¼Œä¾‹å¦‚ç½‘å¡</li>
<li>æ ¹æ® fstab ä¸­çš„ä¿¡æ¯æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼Œä¾‹å¦‚ç½‘ç»œé©±åŠ¨å™¨</li>
<li>å°†æ ¹æ–‡ä»¶ç³»ç»Ÿå’Œæ§åˆ¶æƒç§»äº¤<code>pivot_root</code>ç»™å¦ä¸€ä¸ªç¨‹åºï¼Œä¾‹å¦‚ systemd</li>
</ul>
</li>
</ul>
<h3 id="è¿›ç¨‹çš„åœ°å€ç©ºé—´"><a href="#è¿›ç¨‹çš„åœ°å€ç©ºé—´" class="headerlink" title="è¿›ç¨‹çš„åœ°å€ç©ºé—´"></a>è¿›ç¨‹çš„åœ°å€ç©ºé—´</h3><p>è¿›ç¨‹çš„çŠ¶æ€ç”± (M,R) ç»„æˆï¼ŒRä¸ºä½“ç³»ç»“æ„ä¸­å†³å®šçš„ï¼ŒMçš„å…·ä½“å®ç°ï¼Ÿ</p>
<h4 id="åœ°å€ç©ºé—´å†…å®¹"><a href="#åœ°å€ç©ºé—´å†…å®¹" class="headerlink" title="åœ°å€ç©ºé—´å†…å®¹"></a>åœ°å€ç©ºé—´å†…å®¹</h4><p><code>pmap pid</code>   è¯»å–<code>/proc/pid/maps</code>   <code>strace</code>è·Ÿè¸ªå¯ä»¥è¯æ˜</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># ä¸€å¤§å †å†…å­˜ï¼Œæœ‰çš„rxä¸ºä»£ç pcè®¿é—®  æœ‰çš„r(å­—ç¬¦ä¸²å¸¸é‡)  æœ‰çš„rw(å˜é‡ æ ˆ)</span><br>12345:   executable_program<br>Address           Kbytes     RSS   Dirty Mode   Mapping<br>0000000000400000    2048     976     976 r-x--  executable_program<br>0000000000600000    1024     512     512 rw---  executable_program<br>0000000000700000    4096    2048    2048 rw---    [ anon ]<br>00007f9a28345000    4096    2048    2048 r-x--  libc.so.6<br>00007f9a283d4000    2048       0       0 -----  libc.so.6<br>00007f9a285d4000      16      12       0 r----  libc.so.6<br>00007f9a285d8000       4       4       4 rw---  libc.so.6<br>00007f9a285d9000      16       4       4 rw---    [ stack ]<br><br><span class="hljs-comment"># çŒœæµ‹å¯¹ä¸å¯¹çš„ä¸Šï¼Ÿ åŠ ä¸€äº›å˜é‡ä»£ç ï¼Œç„¶åè°ƒè¯•</span><br></code></pre></td></tr></table></figure>

<p>å¦‚æœæ˜¯åŠ¨æ€é“¾æ¥å‘¢ï¼Ÿæœ‰ä¸€ä¸ªåŠ è½½çš„è¿‡ç¨‹ï¼Œåœ¨<code>main</code>ä¹‹å‰æŠŠåŠ¨æ€é“¾æ¥åº“ï¼ˆå¦‚libc.so.6ï¼‰åŠ è½½åˆ°åœ°å€ç©ºé—´ä¸­</p>
<p> ç³»ç»Ÿè°ƒç”¨éœ€è¦é™·å…¥å†…æ ¸ï¼Œä½†æœ‰äº›ç®€å•çš„(åªè¯»çš„)å¯ä»¥ä¸ç”¨é™·å…¥å†…æ ¸æ‰§è¡Œ</p>
<ul>
<li><code>vvar</code> ï¼šVirtual Variable  å­˜å‚¨å†…æ ¸å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´å…±äº«çš„å˜é‡ã€‚è¿™äº›å˜é‡åŒ…æ‹¬ä¸æ—¶é—´ç›¸å…³çš„ä¿¡æ¯ã€çº¿ç¨‹ç‰¹å®šçš„æ•°æ®ç­‰ã€‚</li>
<li><code>vdso</code>ï¼šå–è¿™äº›ä¿¡æ¯çš„ä»£ç ï¼Œ<strong>ä¸è¿›å…¥å†…æ ¸çš„ç³»ç»Ÿè°ƒç”¨</strong></li>
</ul>
<h4 id="ç©ºé—´çš„ç®¡ç†"><a href="#ç©ºé—´çš„ç®¡ç†" class="headerlink" title="ç©ºé—´çš„ç®¡ç†"></a>ç©ºé—´çš„ç®¡ç†</h4><p>ç¨‹åºç©ºé—´æ˜¯å˜åŒ–çš„ï¼šæ“ä½œç³»ç»Ÿåº”è¯¥æä¾›ä¸€ä¸ª<strong>ä¿®æ”¹è¿›ç¨‹åœ°å€ç©ºé—´çš„ç³»ç»Ÿè°ƒç”¨</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// æ˜ å°„  fdæ–‡ä»¶æè¿°ç¬¦ offsetåç§»é‡ï¼Œæä¾›æ—¶æŠŠæ–‡ä»¶å†…å®¹åŠ è½½åˆ°å†…å­˜</span><br><span class="hljs-type">void</span> *<span class="hljs-title function_">mmap</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr, <span class="hljs-type">size_t</span> length, <span class="hljs-type">int</span> prot, <span class="hljs-type">int</span> flags,</span><br><span class="hljs-params">           <span class="hljs-type">int</span> fd, <span class="hljs-type">off_t</span> offset)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">munmap</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr, <span class="hljs-type">size_t</span> length)</span>;<br><span class="hljs-comment">// ä¸º malloc/free æä¾›äº†æœºåˆ¶</span><br><br><span class="hljs-comment">// ä¿®æ”¹æ˜ å°„æƒé™</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">mprotect</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr, <span class="hljs-type">size_t</span> length, <span class="hljs-type">int</span> prot)</span>;<br></code></pre></td></tr></table></figure>

<p>åˆ†é…8G(å¯ä»¥è¶…è¿‡å†…å­˜)ä¼šç›´æ¥åˆ†é…ï¼Œä½¿ç”¨æ—¶æ‰åŠ å…¥å†…å­˜å‘ç”Ÿç¼ºé¡µä¸­æ–­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> GiB * (1024LL * 1024 * 1024)</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-keyword">volatile</span> <span class="hljs-type">uint8_t</span> *p = mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">8</span> GiB, PROT_READ | PROT_WRITE, MAP_ANONYMOUS | MAP_PRIVATE, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;mmap: %lx\n&quot;</span>, (<span class="hljs-type">uintptr_t</span>)p);<br>  <span class="hljs-keyword">if</span> ((<span class="hljs-type">intptr_t</span>)p == <span class="hljs-number">-1</span>) &#123;<br>    perror(<span class="hljs-string">&quot;cannot map&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br>  *(p + <span class="hljs-number">2</span> GiB) = <span class="hljs-number">1</span>;<br>  *(p + <span class="hljs-number">4</span> GiB) = <span class="hljs-number">2</span>;<br>  *(p + <span class="hljs-number">7</span> GiB) = <span class="hljs-number">3</span>;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Read get: %d\n&quot;</span>, *(p + <span class="hljs-number">4</span> GiB));<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Read get: %d\n&quot;</span>, *(p + <span class="hljs-number">6</span> GiB));<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Read get: %d\n&quot;</span>, *(p + <span class="hljs-number">7</span> GiB));<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>Memory-Mapped File</strong>: ä¸€è‡´æ€§ï¼šä»€ä¹ˆæ—¶å€™å°†ä¿®æ”¹å†™å…¥ç£ç›˜ï¼Ÿå¤šè¿›ç¨‹å¦‚ä½•å…±äº«ï¼Ÿ</p>
<h4 id="å…¥ä¾µåœ°å€ç©ºé—´"><a href="#å…¥ä¾µåœ°å€ç©ºé—´" class="headerlink" title="å…¥ä¾µåœ°å€ç©ºé—´"></a>å…¥ä¾µåœ°å€ç©ºé—´</h4><p>å…¥ä¾µåœ°å€ç©ºé—´å°±æ˜¯å¯ä»¥ä»»æ„æ“æ§å…¶ä»–è¿›ç¨‹</p>
<ul>
<li>è°ƒè¯•å™¨ (gdb)<ul>
<li>gdb å¯ä»¥ä»»æ„è§‚æµ‹å’Œä¿®æ”¹ç¨‹åºçš„çŠ¶æ€</li>
</ul>
</li>
<li>Profiler (perf)<ul>
<li>åˆç†çš„éœ€æ±‚ï¼Œæ“ä½œç³»ç»Ÿå°±å¿…é¡»æ”¯æŒ</li>
</ul>
</li>
</ul>
<h5 id="é‡‘æ‰‹æŒ‡"><a href="#é‡‘æ‰‹æŒ‡" class="headerlink" title="é‡‘æ‰‹æŒ‡"></a>é‡‘æ‰‹æŒ‡</h5><p>ç‰©ç†åŠ«æŒ</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202306091404519.png" srcset="/img/loading.gif" lazyload alt="image-20230605105022909"></p>
<h5 id="é‡‘å±±æ¸¸ä¾ "><a href="#é‡‘å±±æ¸¸ä¾ " class="headerlink" title="é‡‘å±±æ¸¸ä¾ "></a>é‡‘å±±æ¸¸ä¾ </h5><p>å…¥ä¾µåœ°å€ç©ºé—´ï¼Œä¿®æ”¹<strong>é‡‘é’±</strong>ã€<strong>ç”Ÿå‘½</strong>å±æ€§</p>
<p>ä»»ä½•æ“ä½œç³»ç»Ÿè‚¯å®šæä¾›äº†gdb</p>
<p>åŸç†ä¸º<code>pmap</code>è¯»å–å†…å­˜çš„å†…å®¹å¹¶ä¿®æ”¹</p>
<p>ä»£ç æ‰«ææ‰€æœ‰åœ°å€ï¼Œæ‰¾å‡ºé‡‘é’±ä¸º3000çš„ï¼Œæ¶ˆè€—ä¸€äº›åæ‰¾å‡ºä»·é’±ä¸º2700çš„ï¼Œè¿™äº›åœ°å€å€¼éƒ½ä¿®æ”¹å°±å¯ä»¥ä¿®æ”¹é‡‘é’±</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span> &#123;<br>  <span class="hljs-type">long</span> val;<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">64</span>];<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">game</span> <span class="hljs-title">game</span>;</span><br><br>  <span class="hljs-keyword">if</span> (load_game(&amp;game, argv[<span class="hljs-number">1</span>]) &lt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">goto</span> release;<br>  &#125;<br><br>  <span class="hljs-keyword">while</span> (!feof(<span class="hljs-built_in">stdin</span>)) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;(%s %d) &quot;</span>, game.name, game.pid);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%s&quot;</span>, buf) &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">goto</span> release;<br><br>    <span class="hljs-keyword">switch</span> (buf[<span class="hljs-number">0</span>]) &#123;<br>      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;q&#x27;</span>: <span class="hljs-keyword">goto</span> release; <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%ld&quot;</span>, &amp;val); game.bits = val; reset(&amp;game); <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;s&#x27;</span>: <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%ld&quot;</span>, &amp;val); scan(&amp;game, val); <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;w&#x27;</span>: <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%ld&quot;</span>, &amp;val); overwrite(&amp;game, val); <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;r&#x27;</span>: reset(&amp;game); <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br><br>release:<br>  close_game(&amp;game);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="æŒ‰é”®ç²¾çµ"><a href="#æŒ‰é”®ç²¾çµ" class="headerlink" title="æŒ‰é”®ç²¾çµ"></a>æŒ‰é”®ç²¾çµ</h5><p>å¤§é‡é‡å¤å›ºå®šä»»åŠ¡ã€‚è¿™ä¸ªç®€å•ï¼Œå°±æ˜¯ç»™è¿›ç¨‹å‘é€é”®ç›˜&#x2F;é¼ æ ‡äº‹ä»¶</p>
<ul>
<li>åšä¸ªé©±åŠ¨ (å¯ç¼–ç¨‹é”®ç›˜&#x2F;é¼ æ ‡)</li>
<li>åˆ©ç”¨æ“ä½œç³»ç»Ÿ&#x2F;çª—å£ç®¡ç†å™¨æä¾›çš„ API<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/jordansissel/xdotool">xdotool</a> (æˆ‘ä»¬ç”¨è¿™ç©æ„æµ‹è¯• vscode çš„æ’ä»¶)</li>
<li><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/input/input.html">evdev</a> (æŒ‰é”®æ˜¾ç¤ºè„šæœ¬ï¼›ä¸»æ’­å¸¸ç”¨)</li>
</ul>
</li>
</ul>
<h5 id="å˜é€Ÿé½¿è½®"><a href="#å˜é€Ÿé½¿è½®" class="headerlink" title="å˜é€Ÿé½¿è½®"></a>å˜é€Ÿé½¿è½®</h5><p>è·³è½¬æ¸¸æˆé€»è¾‘æ›´æ–°é€Ÿåº¦</p>
<p>ç¨‹åºåªæ˜¯çŠ¶æ€æœºï¼Œé™¤äº†<code>syscall</code>æ— æ³•æ„ŸçŸ¥æ—¶é—´ã€‚ä¿®æ”¹<code>syscall</code>è¿”å›å€¼å°±å¯ä»¥æ¬ºéª—ç¨‹åºã€‚</p>
<h5 id="ä»£ç æ³¨å…¥"><a href="#ä»£ç æ³¨å…¥" class="headerlink" title="ä»£ç æ³¨å…¥"></a>ä»£ç æ³¨å…¥</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// ä¿®æ”¹ API è°ƒç”¨çš„å€¼</span><br>set_alarm(<span class="hljs-number">1000</span> / FPS); <span class="hljs-comment">// å¸Œæœ›æ”¹æˆ 100 / FPS</span><br><br><span class="hljs-comment">// é”å®šç”Ÿå‘½å€¼</span><br>hp -= damage; <span class="hljs-comment">// å¸Œæœ› â€œæ¶ˆé™¤â€ æ­¤æ¬¡ä¿®æ”¹</span><br><span class="hljs-keyword">if</span> (hp &lt; <span class="hljs-number">0</span>) game_over();<br></code></pre></td></tr></table></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" class="category-chain-item">è®¡ç®—æœºåŸºç¡€</a>
  
  
    <span>></span>
    
  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/408/" class="category-chain-item">408</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" class="print-no-link">#è®¡ç®—æœºåŸºç¡€</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/05/23/dl/%E5%8A%A8%E6%89%8B%E5%AD%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0NLP/" title="åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ NLP">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ NLP</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/05/12/book/%E7%A9%BF%E8%B6%8A%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%B7%E9%9B%BE/" title="ç©¿è¶Šè®¡ç®—æœºçš„è¿·é›¾">
                        <span class="hidden-mobile">ç©¿è¶Šè®¡ç®—æœºçš„è¿·é›¾</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="waline"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#waline', function() {
      Fluid.utils.createCssLink('https://lib.baomitu.com/waline/2.14.1/waline.css')
      Fluid.utils.createScript('https://lib.baomitu.com/waline/2.14.1/waline.js', function() {
        var options = Object.assign(
          {"serverURL":"https://comment.bytewaver.top/","path":"window.location.pathname","meta":["nick","mail","link"],"requiredMeta":["nick"],"lang":"zh-CN","emoji":["https://cdn.jsdelivr.net/gh/walinejs/emojis/weibo"],"dark":"html[data-user-color-scheme=\"dark\"]","wordLimit":0,"pageSize":10,"reaction":true},
          {
            el: '#waline',
            path: window.location.pathname
          }
        )
        Waline.init(options);
        Fluid.utils.waitElementVisible('#waline .vcontent', () => {
          var imgSelector = '#waline .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>
  </div>
</div>





  



  



  



  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="leancloud-site-pv"></span>
         æ¬¡
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="leancloud-site-uv"></span>
         äºº
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
