

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/logo.png">
  <link rel="icon" href="/img/logo.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#B1A58E">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="这篇文章主要围绕软件开发中的设计模式、系统架构优化和故障处理展开，以下是摘要内容：  1. **学习能力与代码优化**      - 知识更新快、需求变化多，需通过优化代码结构应对（如避免重复代码）。提出两种方案：        - 方案1：工具类统一逻辑，标准化流程        - 方案2：模板方法模式（Java示例），固定调用顺序，集中处理日志&#x2F;错误    2. **领域驱动设计（DDD）与">
<meta property="og:type" content="article">
<meta property="og:title" content="趣学架构">
<meta property="og:url" content="http://example.com/2024/01/25/%E8%B6%A3%E5%AD%A6%E6%9E%B6%E6%9E%84/index.html">
<meta property="og:site_name" content="Xun&#39;s Blog">
<meta property="og:description" content="这篇文章主要围绕软件开发中的设计模式、系统架构优化和故障处理展开，以下是摘要内容：  1. **学习能力与代码优化**      - 知识更新快、需求变化多，需通过优化代码结构应对（如避免重复代码）。提出两种方案：        - 方案1：工具类统一逻辑，标准化流程        - 方案2：模板方法模式（Java示例），固定调用顺序，集中处理日志&#x2F;错误    2. **领域驱动设计（DDD）与">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240325201646820.png">
<meta property="article:published_time" content="2024-01-25T12:00:00.000Z">
<meta property="article:modified_time" content="2025-04-10T08:51:01.041Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="java">
<meta property="article:tag" content="系统架构">
<meta property="article:tag" content="设计模式">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240325201646820.png">
  
  
  
  <title>趣学架构 - Xun&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":false},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"left","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"GEluhFhlvVVyi1wC9RzB0vSk-MdYXbMMI","app_key":"9ng4wvU8n0568liU440awYcT","server_url":"https://proxy.bytewaver.top/proxy/geluhfhl.api.lncldglobal.com","path":"window.location.pathname","ignore_local":true}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 50vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong> </strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/bg/pink-small.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">趣学架构</span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-01-25 20:00" pubdate>
          2024年1月25日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          5.8k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          49 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="padding-left: 2rem; margin-right: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">趣学架构</h1>
            
            
              <div class="markdown-body">
                
                <blockquote>
<p><strong>GPT摘要</strong></p>
<p>这篇文章主要围绕软件开发中的设计模式、系统架构优化和故障处理展开，以下是摘要内容：  1. <strong>学习能力与代码优化</strong>      - 知识更新快、需求变化多，需通过优化代码结构应对（如避免重复代码）。提出两种方案：        - 方案1：工具类统一逻辑，标准化流程        - 方案2：模板方法模式（Java示例），固定调用顺序，集中处理日志&#x2F;错误    2. <strong>领域驱动设计（DDD）与流程引擎</strong>      - 通过事件风暴建模划分业务边界（如电商场景），抽象核心领域模型（订单、支付）。      - 分层架构：接口层（校验格式）、服务层（编排流程）、领域层（规则实现）、数据层（单纯CRUD）。      - 流程引擎实践：将业务拆分为处理器（Processor），通过模板或JSON配置驱动流程（如转账、风控）。    3. <strong>设计模式应用</strong>      - <strong>责任链模式</strong>：处理参数校验（如多条件依次验证）。      - <strong>策略模式</strong>：动态选择通知方式（短信&#x2F;邮件）。      - <strong>观察者模式</strong>：异步处理非主链路操作（如打点监控）。      - <strong>状态编排</strong>：通过事件驱动状态机（如订单状态流转）。    4. <strong>高并发与扩展性</strong>      - 读优化：多级缓存（本地+Redis）、缓存策略（延迟双删）。      - 写优化：批量操作、缓冲记账（先写文件再同步DB）。      - 分库分表：按用户ID哈希路由，隔离资源。    5. <strong>容错与稳定性</strong>      - 幂等设计：唯一ID+流水表防重。      - 降级策略：非核心依赖熔断（如查询余额忽略账单服务）。      - 监控：日志采集、链路追踪、定时对账。    6. <strong>故障预防与发布</strong>      - 灰度发布：按用户ID分段生效。      - 回滚机制：兼容性设计（新旧代码并存）。      - 全链路压测：模拟真实流量验证性能。    7. <strong>异常处理规范</strong>      - 系统内用异常中断流程，RPC接口返回错误码。      - 区分业务异常（如余额不足）与系统异常（如DB超时）。    总结：通过设计模式解耦、领域建模明确边界、分层架构隔离变化，结合流程引擎提升扩展性，再辅以缓存&#x2F;容错&#x2F;监控保障稳定性，最终实现高内聚低耦合的系统设计。</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1pz4y1j72C">https://www.bilibili.com/video/BV1pz4y1j72C</a></p>
<h2 id="1-大学学点啥"><a href="#1-大学学点啥" class="headerlink" title="1.大学学点啥"></a>1.大学学点啥</h2><p>学习能力</p>
<ul>
<li>知识多</li>
<li>更新换代快</li>
<li>时间约束</li>
</ul>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202402292125524.png" srcset="/img/loading.gif" lazyload alt="image-20240118150913790"></p>
<h2 id="2-搭建系统先搭架子"><a href="#2-搭建系统先搭架子" class="headerlink" title="2.搭建系统先搭架子"></a>2.搭建系统先搭架子</h2><h3 id="1-用户首页"><a href="#1-用户首页" class="headerlink" title="1.用户首页"></a>1.用户首页</h3><p>（用户信息、余额、消费等）</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202402292125135.png" srcset="/img/loading.gif" lazyload alt="image-20240118152725304"></p>
<h3 id="2-新需求"><a href="#2-新需求" class="headerlink" title="2.新需求"></a>2.新需求</h3><p>需要添加用户修改功能；<strong>存在许多重复代码</strong></p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202403151317860.png" srcset="/img/loading.gif" lazyload alt="image-20240118152826760"></p>
<p>解决方案1：添加工具类</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202403151413979.png" srcset="/img/loading.gif" lazyload alt="image-20240118152927534"></p>
<h3 id="模板方法模式"><a href="#模板方法模式" class="headerlink" title="模板方法模式"></a>模板方法模式</h3><p>统一逻辑，标准化流程</p>
<p>解决方案2：<strong>模板方法模式</strong>；保证必须要调用以及调用顺序；通用部分直接一起升级（log、error）</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/202403151413316.png" srcset="/img/loading.gif" lazyload alt="image-20240118152954535"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.google.common.base.Stopwatch;<br><span class="hljs-keyword">import</span> java.util.Arrays;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceTemplate</span>&lt;T, R&gt; &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoggerImpl</span>();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 模板统一暴露执行入口</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> R <span class="hljs-title function_">process</span><span class="hljs-params">(T request)</span> &#123;<br>        <span class="hljs-comment">// 1.打印入口日志</span><br>        logger.info(<span class="hljs-string">&quot;start invoke, request=&quot;</span> + request);<br>        <span class="hljs-comment">// 开始计时，用于日志记录耗时</span><br>        <span class="hljs-type">Stopwatch</span> <span class="hljs-variable">stopwatch</span> <span class="hljs-operator">=</span> Stopwatch.createStarted();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 2. 校验参数</span><br>            validParam(request);<br>            <span class="hljs-comment">// 3. 子类实现逻辑</span><br>            <span class="hljs-type">R</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> doProcess(request);<br>            <span class="hljs-comment">// 4.打印出口日志</span><br>            <span class="hljs-type">long</span> <span class="hljs-variable">timeCost</span> <span class="hljs-operator">=</span> stopwatch.elapsed(TimeUnit.MILLISECONDS);<br>            logger.info(<span class="hljs-string">&quot;end invoke, response=&quot;</span> + response + <span class="hljs-string">&quot;, costTime=&quot;</span> + timeCost);<br>            <span class="hljs-keyword">return</span> response;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-comment">// 打印异常日志</span><br>            logger.error(<span class="hljs-string">&quot;error invoke, exception:&quot;</span> + Arrays.toString(e.getStackTrace()));<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 参数校验(交给子类实现)</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validParam</span><span class="hljs-params">(T request)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 执行业务逻辑(交给子类实现)</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> R <span class="hljs-title function_">doProcess</span><span class="hljs-params">(T request)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 模拟的Logger类</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggerImpl</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">info</span><span class="hljs-params">(String msg)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;INFO: &quot;</span> + msg);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">error</span><span class="hljs-params">(String msg)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;ERROR: &quot;</span> + msg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">get</span><span class="hljs-params">(Integer userId)</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceTemplate</span>&lt;&gt;() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validParam</span><span class="hljs-params">(Integer request)</span> &#123;<br>        <span class="hljs-keyword">if</span> (request == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Request cannot be null&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> Integer <span class="hljs-title function_">doProcess</span><span class="hljs-params">(Integer request)</span> &#123;<br>        <span class="hljs-comment">// 具体业务 获取用户信息、消费情况、余额</span><br>        <span class="hljs-keyword">return</span> request * request;<br>    &#125;<br>&#125;.process(userId);<br></code></pre></td></tr></table></figure>

<p>再进一步：如果子需求再次变化，例如添加优惠券信息、消费记录查询限制时间、只有授权才返回余额</p>
<p>这样代码越来越长，并且子业务之间相互影响；<strong>耦合</strong></p>
<h2 id="3-搭完架子串珠子"><a href="#3-搭完架子串珠子" class="headerlink" title="3.搭完架子串珠子"></a>3.搭完架子串珠子</h2><h3 id="流程引擎"><a href="#流程引擎" class="headerlink" title="流程引擎"></a>流程引擎</h3><p>逻辑拆分、边界组装</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240118161401411.png" srcset="/img/loading.gif" lazyload alt="image-20240118161401411"></p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240118155403367.png" srcset="/img/loading.gif" lazyload alt="image-20240118155403367"></p>
<p>其实就是实习中遇到的模板引擎玩法</p>
<p>在活动中，就是处理器就是 获取活动信息  过活动人群  过任务人群  过风控  处理业务  （首次进入任务就是添加一次任务记录，然后发一次抽奖机会；抽奖就是消耗抽奖机会，然后执行抽奖流程）</p>
<h3 id="CODE"><a href="#CODE" class="headerlink" title="CODE"></a>CODE</h3><h4 id="造珠子（定义组件）"><a href="#造珠子（定义组件）" class="headerlink" title="造珠子（定义组件）"></a>造珠子（定义组件）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Processor</span> &#123;<br>    <span class="hljs-comment">// 包含两个参数  </span><br>    <span class="hljs-comment">// 1.入参 本次请求需要的参数，这个也可也定义一个函数来获取</span><br>    <span class="hljs-comment">// 2.上下文 处理器之间的信息传递 也是最后结果的返回数据源</span><br>    <br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">needExecute</span><span class="hljs-params">(ProcessRequest request, ProcessContext context)</span>; <span class="hljs-comment">// 灰度</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(ProcessRequest request, ProcessContext context)</span>;<br>&#125;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserInfoQueryProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Processor</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserBaseInfoRepository userBaseInfoRepository; <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserSpecialInfoRepository userSpecialInfoRepository;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">needExecute</span><span class="hljs-params">(ProcessRequest request, ProcessContext context)</span> &#123;<br>        <span class="hljs-comment">// 实现具体的判断逻辑</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 示例，默认总是执行</span><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(ProcessRequest request, ProcessContext context)</span> &#123;<br>        <span class="hljs-comment">// 实现具体的处理逻辑</span><br>        <span class="hljs-type">UserBaseInfoVO</span> <span class="hljs-variable">userBaseInfoVo</span> <span class="hljs-operator">=</span> userBaseInfoRepository.getUserBaseInfo(request.getUserId());<br>        <span class="hljs-type">UserSpecialInfoVO</span> <span class="hljs-variable">userSpecialInfoVo</span> <span class="hljs-operator">=</span> userSpecialInfoRepository.getUserSpecialInfo(request.getUserId());<br>        <br>        <span class="hljs-comment">// ... 更新context状态或处理其他业务逻辑</span><br>        context.setUserBaseInfo(userBaseInfoVo);<br>        context.setUserSpecialInfo(userSpecialInfoVo);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="串珠子（编排组件）"><a href="#串珠子（编排组件）" class="headerlink" title="串珠子（编排组件）"></a>串珠子（编排组件）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 引擎接口</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProcessEngine</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">(ProcessRequest request, ProcessContext context)</span>;<br>&#125;<br><br><span class="hljs-comment">// 引擎核心</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractProcessEngineImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ProcessEngine</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Logger logger;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ApplicationContext applicationContext;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">(ProcessRequest request, ProcessContext context)</span> &#123;<br>        logger.info(<span class="hljs-string">&quot;ProcessEngine start, request:&quot;</span> + request);<br>        <br>        <span class="hljs-comment">// 获取执行器列表</span><br>        List&lt;ProcessNameEnum&gt; processors = getProcessors();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 逐个运行执行器</span><br>            <span class="hljs-keyword">for</span> (ProcessNameEnum processorName : processors) &#123;<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> applicationContext.getBean(processorName.getName());<br>                <span class="hljs-keyword">if</span> (!(bean <span class="hljs-keyword">instanceof</span> Processor)) &#123;<br>                    logger.error(<span class="hljs-string">&quot;Processor: &quot;</span> + processorName + <span class="hljs-string">&quot; not exist or type is incorrect&quot;</span>);<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>                <br>                <span class="hljs-comment">// 执行器开始日志标注</span><br>                logger.info(<span class="hljs-string">&quot;Processor: &quot;</span> + processorName + <span class="hljs-string">&quot; start&quot;</span>);<br>                <br>                <span class="hljs-type">Processor</span> <span class="hljs-variable">processor</span> <span class="hljs-operator">=</span> (Processor) bean;<br>                <span class="hljs-comment">// 判断执行器是否符合执行条件</span><br>                <span class="hljs-keyword">if</span> (!processor.needExecute(request, context)) &#123;<br>                    logger.info(<span class="hljs-string">&quot;Processor: &quot;</span> + processorName + <span class="hljs-string">&quot; skipped&quot;</span>);<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>                <br>                <span class="hljs-comment">// 执行器执行</span><br>                processor.execute(request, context);<br>                <br>                <span class="hljs-comment">// 执行器结束日志标注</span><br>                logger.info(<span class="hljs-string">&quot;Processor: &quot;</span> + processorName + <span class="hljs-string">&quot; end&quot;</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-comment">// 执行异常中断日志打印</span><br>            logger.error(<span class="hljs-string">&quot;ProcessEngine interrupted, exception: &quot;</span> + Arrays.toString(e.getStackTrace()));<br>            <span class="hljs-comment">// 继续抛出异常</span><br>            <span class="hljs-keyword">throw</span> e;<br>        &#125;<br>        <br>        <span class="hljs-comment">// 打印引擎执行完成日志</span><br>        logger.info(<span class="hljs-string">&quot;ProcessEngine end, context: &quot;</span> + context);<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> List&lt;ProcessNameEnum&gt; <span class="hljs-title function_">getProcessors</span><span class="hljs-params">()</span>;<br>&#125;<br><br><span class="hljs-comment">// 具体引擎</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserInfoQueryProcessEngine</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractProcessEngineImpl</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> List&lt;ProcessNameEnum&gt; processorList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <br>    <span class="hljs-keyword">static</span> &#123;<br>        processorList.add(ProcessNameEnum.USER_INFO_QUERY_PROCESSOR);<br>        processorList.add(ProcessNameEnum.MONEY_PROCESSOR);<br>        processorList.add(ProcessNameEnum.CONSUME_RECORD_PROCESSOR);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> List&lt;ProcessNameEnum&gt; <span class="hljs-title function_">getProcessors</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> processorList;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="调用（启动流程）"><a href="#调用（启动流程）" class="headerlink" title="调用（启动流程）"></a>调用（启动流程）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> UserInfoDTO <span class="hljs-title function_">getUserInfo</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;userId&quot;)</span> String userId)</span> &#123;<br>    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceTemplate</span>&lt;String, UserInfoDTO&gt;() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validParam</span><span class="hljs-params">(String request)</span> &#123;<br>            <span class="hljs-comment">// ... 参数校验逻辑</span><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">protected</span> UserInfoDTO <span class="hljs-title function_">doProcess</span><span class="hljs-params">(String request)</span> &#123;<br>            <span class="hljs-comment">// ... 初始化请求和上下文对象</span><br>            <span class="hljs-type">ProcessRequest</span> <span class="hljs-variable">processRequest</span> <span class="hljs-operator">=</span> ProcessRequest.builder().userId(userId).build();<br>            <span class="hljs-type">ProcessContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> ProcessContext.builder().build();<br>            <br>            <span class="hljs-comment">// 启动引擎</span><br>            userInfoQueryProcessEngine.start(processRequest, ctx);<br>            <br>            <span class="hljs-comment">// 从上下文对象中获取数据并填充返回对象</span><br>            <span class="hljs-keyword">return</span> UserInfoDTO.builder()<br>                              .totalMoney(ctx.getTotalMoney())<br>                              .maxAmount(ctx.getMaxAmount())<br>                              .build();<br>        &#125;<br>    &#125;).process(userId);<br>&#125;<br><br></code></pre></td></tr></table></figure>



<h3 id="复杂流程编排"><a href="#复杂流程编排" class="headerlink" title="复杂流程编排"></a>复杂流程编排</h3><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240118162350908.png" srcset="/img/loading.gif" lazyload alt="image-20240118162350908"></p>
<p>amunda, JBPM, 或Activiti  轻量级框架：LiteFlow</p>
<p>0.JSON</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;initialProcessor&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;UserInfoQueryProcessor&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;processMap&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;UserInfoQueryProcessor&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;success&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;MoneyProcessor&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ErrorHandlingProcessor&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;MoneyProcessor&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;success&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ConsumeRecordProcessor&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ErrorHandlingProcessor&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;ConsumeRecordProcessor&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;success&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ErrorHandlingProcessor&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure>

<p>1.返回string，决定着next</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Processor</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">needExecute</span><span class="hljs-params">(ProcessRequest request, ProcessContext context)</span>;<br>    String <span class="hljs-title function_">execute</span><span class="hljs-params">(ProcessRequest request, ProcessContext context)</span> <span class="hljs-keyword">throws</span> Exception;<br>&#125;<br><br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserInfoQueryProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Processor</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserBaseInfoRepository userBaseInfoRepository; <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserSpecialInfoRepository userSpecialInfoRepository;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">needExecute</span><span class="hljs-params">(ProcessRequest request, ProcessContext context)</span> &#123;<br>        <span class="hljs-comment">// 实现具体的判断逻辑</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 示例，默认总是执行</span><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(ProcessRequest request, ProcessContext context)</span> &#123;<br>        <span class="hljs-comment">// 实现具体的处理逻辑</span><br>        <span class="hljs-type">UserBaseInfoVO</span> <span class="hljs-variable">userBaseInfoVo</span> <span class="hljs-operator">=</span> userBaseInfoRepository.getUserBaseInfo(request.getUserId());<br>        <span class="hljs-type">UserSpecialInfoVO</span> <span class="hljs-variable">userSpecialInfoVo</span> <span class="hljs-operator">=</span> userSpecialInfoRepository.getUserSpecialInfo(request.getUserId());<br>        <br>        <span class="hljs-comment">// 业务异常返回失败状态</span><br>        <span class="hljs-keyword">if</span> (userSpecialInfoVo == <span class="hljs-literal">null</span>)&#123; <br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;failed&quot;</span><br>        &#125;<br>        <br>        <span class="hljs-comment">// ... 更新context状态或处理其他业务逻辑</span><br>        context.setUserBaseInfo(userBaseInfoVo);<br>        context.setUserSpecialInfo(userSpecialInfoVo);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>2.编排</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigurableProcessEngineImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ProcessEngine</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Logger logger;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ApplicationContext applicationContext;<br><br>    <span class="hljs-keyword">private</span> Map&lt;String, Map&lt;String, String&gt;&gt; processMap;<br>    <span class="hljs-keyword">private</span> String initialProcessorName;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ConfigurableProcessEngineImpl</span><span class="hljs-params">(String jsonFilePath)</span> &#123;<br>        init(jsonFilePath);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(String jsonFilePath)</span> &#123;<br>        <span class="hljs-comment">// 读取JSON文件并解析为processMap和initialProcessorName</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">jsonContent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(Files.readAllBytes(Paths.get(jsonFilePath)));<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonConfig</span> <span class="hljs-operator">=</span> JSON.parseObject(jsonContent);<br>        <span class="hljs-built_in">this</span>.initialProcessorName = jsonConfig.getString(<span class="hljs-string">&quot;initialProcessor&quot;</span>);<br>        <span class="hljs-built_in">this</span>.processMap = parseProcessMap(jsonConfig.getJSONObject(<span class="hljs-string">&quot;processMap&quot;</span>));<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">(ProcessRequest request, ProcessContext context)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">currentProcessorName</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.initialProcessorName;<br>        Processor currentProcessor;<br><br>        <span class="hljs-keyword">while</span> (currentProcessorName != <span class="hljs-literal">null</span>) &#123;<br>            currentProcessor = (Processor) applicationContext.getBean(currentProcessorName);<br>            String result;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (currentProcessor.needExecute(request, context)) &#123;<br>                    result = currentProcessor.execute(request, context);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    logger.info(<span class="hljs-string">&quot;Processor: &quot;</span> + currentProcessorName + <span class="hljs-string">&quot; skipped&quot;</span>);<br>                    result = <span class="hljs-string">&quot;Skipped&quot;</span>; <span class="hljs-comment">// 或者其他表示跳过的结果</span><br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                result = <span class="hljs-string">&quot;Failed&quot;</span>; <span class="hljs-comment">// 或者其他表示失败的结果</span><br>                logger.error(<span class="hljs-string">&quot;Processor: &quot;</span> + currentProcessorName + <span class="hljs-string">&quot; failed, exception: &quot;</span> + Arrays.toString(e.getStackTrace()));<br>            &#125;<br><br>            currentProcessorName = determineNextProcessor(currentProcessorName, result);<br>        &#125;<br><br>        logger.info(<span class="hljs-string">&quot;ProcessEngine end, context: &quot;</span> + context);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">determineNextProcessor</span><span class="hljs-params">(String currentProcessorName, String result)</span> &#123;<br>        Map&lt;String, String&gt; decisionMap = processMap.get(currentProcessorName);<br>        <span class="hljs-keyword">if</span> (decisionMap == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> decisionMap.get(result);<br>    &#125;<br><br>    <span class="hljs-comment">// 解析processMap</span><br>    <span class="hljs-keyword">private</span> Map&lt;String, Map&lt;String, String&gt;&gt; <span class="hljs-title function_">parseProcessMap</span><span class="hljs-params">(JsonObject processMapJson)</span> &#123;<br>        <span class="hljs-comment">// 实现processMap的解析逻辑</span><br>        <span class="hljs-keyword">return</span> JSONObject.parseObject(processMapJson.toJSONString(),<br>                                      <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;Map&lt;String, Map&lt;String, String&gt;&gt;&gt;() &#123;&#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>3.调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> UserInfoDTO <span class="hljs-title function_">doProcess</span><span class="hljs-params">(String request)</span> &#123;<br>    <span class="hljs-comment">// 创建流程引擎</span><br>    <span class="hljs-type">ConfigurableProcessEngineImpl</span> <span class="hljs-variable">processEngine</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfigurableProcessEngineImpl</span>(<span class="hljs-string">&quot;/path/to/your/process-flow.json&quot;</span>);<br><br>    <span class="hljs-comment">// 启动流程引擎</span><br>    processEngine.start(request, context);<br><br><br>    <span class="hljs-comment">// ... 初始化请求和上下文对象</span><br>    <span class="hljs-type">ProcessRequest</span> <span class="hljs-variable">processRequest</span> <span class="hljs-operator">=</span> ProcessRequest.builder().userId(userId).build();<br>    <span class="hljs-type">ProcessContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> ProcessContext.builder().build();<br><br>    <span class="hljs-comment">// 启动引擎</span><br>    processEngine.start(processRequest, ctx);<br><br>    <span class="hljs-comment">// 从上下文对象中获取数据并填充返回对象</span><br>    <span class="hljs-keyword">return</span> UserInfoDTO.builder()<br>        .totalMoney(ctx.getTotalMoney())<br>        .maxAmount(ctx.getMaxAmount())<br>        .build();<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="责任链"><a href="#责任链" class="headerlink" title="责任链"></a>责任链</h3><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240118172157467.png" srcset="/img/loading.gif" lazyload alt="image-20240118172157467"></p>
<p>责任链：沿着这条链传递请求，直到有一个对象处理它为止，具体由哪个对象处理则在运行时动态决定的情况。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Handler</span> &#123;<br>    <span class="hljs-keyword">protected</span> Handler successor;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setSuccessor</span><span class="hljs-params">(Handler successor)</span> &#123;<br>        <span class="hljs-built_in">this</span>.successor = successor;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleRequest</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span>;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NoDiscountHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Handler</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleRequest</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;No discount applied.&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">LowDiscountHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Handler</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleRequest</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> &#123;<br>        <span class="hljs-keyword">if</span> (amount &lt; <span class="hljs-number">1000</span>) &#123;<br>            System.out.println(<span class="hljs-string">&quot;Low discount applied. Amount: &quot;</span> + amount);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (successor != <span class="hljs-literal">null</span>) &#123;<br>            successor.handleRequest(amount);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">HighDiscountHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Handler</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleRequest</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> &#123;<br>        <span class="hljs-keyword">if</span> (amount &gt;= <span class="hljs-number">1000</span>) &#123;<br>            System.out.println(<span class="hljs-string">&quot;High discount applied. Amount: &quot;</span> + amount);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (successor != <span class="hljs-literal">null</span>) &#123;<br>            successor.handleRequest(amount);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">HandlerChain</span> &#123;<br>    <span class="hljs-keyword">private</span> Handler head;<br>    <span class="hljs-keyword">private</span> Handler tail;<br><br>    <span class="hljs-keyword">public</span> HandlerChain <span class="hljs-title function_">add</span><span class="hljs-params">(Handler handler)</span> &#123;<br>        <span class="hljs-keyword">if</span> (head == <span class="hljs-literal">null</span>) &#123;<br>            head = handler;<br>            tail = handler;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            tail.setSuccessor(handler);<br>            tail = handler;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleRequest</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> &#123;<br>        <span class="hljs-keyword">if</span> (head != <span class="hljs-literal">null</span>) &#123;<br>            head.handleRequest(amount);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChainDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">HandlerChain</span> <span class="hljs-variable">chain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HandlerChain</span>();<br>        chain.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LowDiscountHandler</span>())<br>             .add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HighDiscountHandler</span>())<br>             .add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NoDiscountHandler</span>());<br><br>        <span class="hljs-comment">// Making requests</span><br>        chain.handleRequest(<span class="hljs-number">500</span>);<br>        chain.handleRequest(<span class="hljs-number">1500</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<h2 id="4-系统是个三明治"><a href="#4-系统是个三明治" class="headerlink" title="4.系统是个三明治"></a>4.系统是个三明治</h2><ul>
<li>提高复用性</li>
<li>降低耦合</li>
<li>提高可读性</li>
</ul>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240118195836506.png" srcset="/img/loading.gif" lazyload alt="image-20240118195836506" style="zoom:50%;" /><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240118195851875.png" srcset="/img/loading.gif" lazyload alt="image-20240118195851875" style="zoom:50%;" /></p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240118200142854.png" srcset="/img/loading.gif" lazyload alt="image-20240118200142854"></p>
<ul>
<li>[接口层] :对出入参仅做格式上的校验，不能涉及“例如用户是否在黑名单中”这样的校验。</li>
<li>[服务层] :负责编排流程、处理rpc请求、控制同异步。不能涉及领域概念。</li>
<li>[领域层] :针对领域规则来实现具体的能力。</li>
<li>[数据层] :仅对数据做CRUD,不能涉及对数据的额外加工。</li>
</ul>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240119160910358.png" srcset="/img/loading.gif" lazyload alt="image-20240119160910358"></p>
<h2 id="5-DDD"><a href="#5-DDD" class="headerlink" title="5.DDD"></a>5.DDD</h2><p>复杂度提升</p>
<ul>
<li>满足基本需求</li>
<li>良好的扩展性</li>
<li>稳定性、性能</li>
</ul>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240119171329282.png" srcset="/img/loading.gif" lazyload alt="image-20240119171329282"></p>
<p>设计策略：</p>
<ul>
<li>搞清功能</li>
<li>分析建模</li>
<li>便于拆分</li>
</ul>
<p><strong>case</strong>：卖家可以在网上挂商品售卖，买家可以选择商品并购买，购买后卖家会发快递，买家收到货后确认收货，网站把款项结算给卖家。</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240119172529042.png" srcset="/img/loading.gif" lazyload alt="image-20240119172529042"></p>
<h3 id="战略设计"><a href="#战略设计" class="headerlink" title="战略设计"></a>战略设计</h3><p>解释业务，建立业务模型，划分业务边界</p>
<h4 id="事件风暴"><a href="#事件风暴" class="headerlink" title="事件风暴"></a>事件风暴</h4><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240119165000678.png" srcset="/img/loading.gif" lazyload alt="image-20240119165000678"></p>
<p>事件：行为的结果（业务的重点），再通过事件反推整个流程</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240119164946344.png" srcset="/img/loading.gif" lazyload alt="image-20240119164946344"></p>
<h4 id="领域建模"><a href="#领域建模" class="headerlink" title="领域建模"></a><strong>领域建模</strong></h4><h5 id="分析领域模型"><a href="#分析领域模型" class="headerlink" title="分析领域模型"></a><strong>分析领域模型</strong></h5><ul>
<li><p>找出事件风暴中的名词</p>
</li>
<li><p>连接名词</p>
<img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240119172209854.png" srcset="/img/loading.gif" lazyload alt="image-20240119172209854" style="zoom:50%;" /></li>
</ul>
<h5 id="找聚合："><a href="#找聚合：" class="headerlink" title="找聚合："></a><strong>找聚合</strong>：</h5><p>直接关系最多的节点</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240119172306137.png" srcset="/img/loading.gif" lazyload alt="image-20240119172306137"></p>
<h5 id="划分（限界上下文）"><a href="#划分（限界上下文）" class="headerlink" title="划分（限界上下文）"></a><strong>划分（限界上下文）</strong></h5><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240119172428922.png" srcset="/img/loading.gif" lazyload alt="image-20240119172428922" style="zoom: 67%;" />

<p>1.整理出了重要的业务概念和规则.<br>2.所有角色都对概念对齐了认知<br>3.识别了重要的领域模型，继而指导了系统模型<br>4.做了系统划分</p>
<p>丛业务嘴里的模糊描述 -&gt;清晰的业务概念(多方认知)具体系统建设的内容</p>
<h3 id="战术设计"><a href="#战术设计" class="headerlink" title="战术设计"></a>战术设计</h3><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240119173515013.png" srcset="/img/loading.gif" lazyload alt="image-20240119173515013"></p>
<p><strong>领域模型</strong>：提供了基本的能力，包含业务规则（如类文件对外暴露的方法） </p>
<p><strong>领域服务</strong>：就是<strong>命令</strong>（动作），由多个领域模型聚合</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240119173056903.png" srcset="/img/loading.gif" lazyload alt="image-20240119173056903"></p>
<p>应用层：编排领域服务；同时需要处理消息（例如下单后的邮件通知通过事件驱动实现）</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240119173900690.png" srcset="/img/loading.gif" lazyload alt="image-20240119173900690"></p>
<p>目录结构：</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240119174138306.png" srcset="/img/loading.gif" lazyload alt="image-20240119174138306"></p>
<h2 id="6-0铁三角"><a href="#6-0铁三角" class="headerlink" title="6.0铁三角"></a>6.0铁三角</h2><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240120125313890.png" srcset="/img/loading.gif" lazyload alt="image-20240120125313890"></p>
<h2 id="6-还得是设计模式（扩展-功能扩展）"><a href="#6-还得是设计模式（扩展-功能扩展）" class="headerlink" title="6.还得是设计模式（扩展-功能扩展）"></a>6.还得是设计模式（扩展-功能扩展）</h2><ul>
<li>功能扩展</li>
<li>流量扩展</li>
</ul>
<p>看不懂 改不动 风险高</p>
<p>会写代码的人很多，写好的代码的人少</p>
<img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240120125646682.png" srcset="/img/loading.gif" lazyload alt="image-20240120125646682" style="zoom:67%;" />

<h3 id="case"><a href="#case" class="headerlink" title="case"></a>case</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 转账服务</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> payer 付款方</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> payee 收款方</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> money 转账金额</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> 是否转账成功</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">transfer</span><span class="hljs-params">(String payer, String payee, String money)</span> &#123;<br>    Log.info(<span class="hljs-string">&quot;transfer start, payer=&#123;&#125;, payee=&#123;&#125;, money=&#123;&#125;&quot;</span>, payer, payee, money);<br><br>    <span class="hljs-comment">// 1.检查参数</span><br>    <span class="hljs-keyword">if</span> (!isValidUser(payer) || !isValidUser(payee) || !isValidMoney(money)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 2.调用转账服务</span><br>    <span class="hljs-type">TransferResult</span> <span class="hljs-variable">transferResult</span> <span class="hljs-operator">=</span> transferService.transfer(payer, payee, money);<br>    <span class="hljs-keyword">if</span> (!transferResult.isSuccess()) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 3.查询用户通知方式</span><br>    <span class="hljs-type">UserInfo</span> <span class="hljs-variable">userInfo</span> <span class="hljs-operator">=</span> userInfoService.getUserInfo(payee);<br>    <span class="hljs-keyword">if</span> (userInfo.getNotifyType() == NotifyTypeEnum.SMS) &#123;<br>        <span class="hljs-comment">// smsNotifyService是第三方jar包</span><br>        smsClient.sendSms(payee, NOTIFY_CONTENT);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (userInfo.getNotifyType() == NotifyTypeEnum.MAIL) &#123;<br>        <span class="hljs-comment">// mailNotifyService是第三方jar包</span><br>        mailClient.sendMail(payee, NOTIFY_CONTENT);<br>    &#125;<br><br>    <span class="hljs-comment">// 记录转账账单(发送事件给转账系统)</span><br>    billService.sendBill(transferResult);<br>    <span class="hljs-comment">// 转账监控打点(调用监控jdk)</span><br>    monitorService.sendRecord(transferResult);<br>    <span class="hljs-comment">// 记录转账额度(调用额度中心)</span><br>    quotaService.recordQuota(transferResult);<br><br>    Log.info(<span class="hljs-string">&quot;transfer success&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol>
<li><p>入参出参不具备扩展性，可以考虑使用对象参数</p>
</li>
<li><p>参数的校验可以使用<strong>责任链</strong>优化，所有校验方法都添加到一个list中 <code>context.getBeansOfTypeParamValidator.class)</code></p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240120150550932.png" srcset="/img/loading.gif" lazyload alt="image-20240120150550932"></p>
</li>
<li><p>通知方式，使用<strong>多态替换条件表达式</strong>  策略模式或适配器；和上面最大区别在于只执行一个而不是都执行 所以要一个一个添加</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NotifyServiceManager</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InitializingBean</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SmsNotifyService smsNotifyService;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> MailNotifyService mailNotifyService;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;NotifyTypeEnum, NotifyService&gt; notifyServiceMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 注册通知类型到通知服务的映射关系</span><br>        notifyServiceMap.put(NotifyTypeEnum.SMS, smsNotifyService);<br>        notifyServiceMap.put(NotifyTypeEnum.MAIL, mailNotifyService);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notify</span><span class="hljs-params">(NotifyTypeEnum notifyTypeEnum, String userId, String content)</span> &#123;<br>        <span class="hljs-type">NotifyService</span> <span class="hljs-variable">notifyService</span> <span class="hljs-operator">=</span> notifyServiceMap.get(notifyTypeEnum);<br>        <span class="hljs-keyword">if</span> (notifyService == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Notify service not exist for type: &quot;</span> + notifyTypeEnum);<br>        &#125;<br>        notifyService.notifyMessage(userId, content);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>最后<strong>非主链路</strong>的统计、打点，使用<strong>观察者模式</strong>实现；并结合线<strong>程池加速及错误隔离</strong>；和校验器区别在于这是非主链路</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TransferObserver</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(TransferResult transferResult)</span>;<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BillServiceObserver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TransferObserver</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(TransferResult transferResult)</span> &#123;<br>        billService.sendBill(transferResult);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MonitorServiceObserver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TransferObserver</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(TransferResult transferResult)</span> &#123;<br>        monitorService.sendRecord(transferResult);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransferSubject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InitializingBean</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ApplicationContext applicationContext;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;TransferObserver&gt; transferObserverList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-comment">// 异步线程池</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Map&lt;String, TransferObserver&gt; transferObserverMap = applicationContext.getBeansOfType(TransferObserver.class);<br>        transferObserverMap.values().forEach(<span class="hljs-built_in">this</span>::addObserver);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 触发观察者</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyObservers</span><span class="hljs-params">(TransferResult transferResult)</span> &#123;<br>        transferObserverList.forEach(transferObserver -&gt; &#123;<br>            <span class="hljs-comment">// 异步执行</span><br>            executorService.execute(() -&gt; transferObserver.update(transferResult));<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 添加观察者</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addObserver</span><span class="hljs-params">(TransferObserver transferObserver)</span> &#123;<br>        transferObserverList.add(transferObserver);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<p>至此新增参数校验、通知类型、后处理等，<code>transfer</code>方法不用修改</p>
<h3 id="设计原则"><a href="#设计原则" class="headerlink" title="设计原则"></a>设计原则</h3><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240120153221074.png" srcset="/img/loading.gif" lazyload alt="image-20240120153221074"></p>
<h2 id="7-没有扛不住的流量（扩展-流量扩展）"><a href="#7-没有扛不住的流量（扩展-流量扩展）" class="headerlink" title="7.没有扛不住的流量（扩展-流量扩展）"></a>7.没有扛不住的流量（扩展-流量扩展）</h2><h3 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h3><p>可能存在的问题： </p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240120180511652.png" srcset="/img/loading.gif" lazyload alt="image-20240120180511652"></p>
<p>此外，还需要拦截恶意的流量，并在特殊情况下对部分有效流量进行降级</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240120180655965.png" srcset="/img/loading.gif" lazyload alt="image-20240120180655965"></p>
<h3 id="水平扩展"><a href="#水平扩展" class="headerlink" title="水平扩展"></a>水平扩展</h3><ul>
<li><p>流量的路由（负载均衡，直接平均或者按照机器性能，实际上机器同样，所以直接平均，降低负载均衡时的复杂度）</p>
<ol>
<li>DNS</li>
<li>NGINX  没有自动服务发现的能力</li>
<li>Eueka Nacos Consul</li>
</ol>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240120181702521.png" srcset="/img/loading.gif" lazyload alt="image-20240120181702521"></p>
</li>
<li><p>服务器间的数据共享问题（实现无状态）</p>
<ol>
<li><p>最简单的方式：复制或者拆分；；引入额外的效率 复杂度 一致性问题</p>
</li>
<li><p>数据中心化：缓存以及磁盘都放到中心化的服务上</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240120182017970.png" srcset="/img/loading.gif" lazyload alt="image-20240120182017970"></p>
</li>
</ol>
</li>
</ul>
<h3 id="垂直拆分"><a href="#垂直拆分" class="headerlink" title="垂直拆分"></a>垂直拆分</h3><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240120182133557.png" srcset="/img/loading.gif" lazyload alt="image-20240120182133557" style="zoom:50%;" />

<p>也就是微服务拆分，使得服务间不受到影响，隔离风险；灵活配置合理分配资源</p>
<h3 id="单元化部署"><a href="#单元化部署" class="headerlink" title="单元化部署"></a>单元化部署</h3><p>通常情况下前两种够了，但：</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240120183320165.png" srcset="/img/loading.gif" lazyload alt="image-20240120183320165"></p>
<p>根据用户的id，在服务上以及数据（sharding）上都进行拆分</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240120183309123.png" srcset="/img/loading.gif" lazyload alt="image-20240120183309123"></p>
<img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240120183359206.png" srcset="/img/loading.gif" lazyload alt="image-20240120183359206" style="zoom: 67%;" />

<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240120184018167.png" srcset="/img/loading.gif" lazyload alt="image-20240120184018167"></p>
<h2 id="8-读的慢有妙招（性能）"><a href="#8-读的慢有妙招（性能）" class="headerlink" title="8.读的慢有妙招（性能）"></a>8.读的慢有妙招（性能）</h2><p><a target="_blank" rel="noopener" href="https://www.toutiao.com/article/7094098101773828645">后台服务高性能设计之道</a></p>
<p>性能：</p>
<ul>
<li>读性能</li>
<li>写性能</li>
</ul>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240120192800027.png" srcset="/img/loading.gif" lazyload alt="image-20240120192800027"></p>
<h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><h4 id="使用层面"><a href="#使用层面" class="headerlink" title="使用层面"></a>使用层面</h4><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240120185031580.png" srcset="/img/loading.gif" lazyload alt="image-20240120185031580"></p>
<h4 id="本地-vs-中心"><a href="#本地-vs-中心" class="headerlink" title="本地 vs 中心"></a>本地 vs 中心</h4><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240120185122795.png" srcset="/img/loading.gif" lazyload alt="image-20240120185122795"></p>
<p>甚至于同时使用多级缓存</p>
<h4 id="一致性问题"><a href="#一致性问题" class="headerlink" title="一致性问题"></a>一致性问题</h4><ol>
<li>添加过期时间</li>
<li><strong>先更新DB再删除缓存</strong>cache aside pattern（小概率：B来的时候没有缓存，B读取数据库，A更新数据并删除redis，B写脏数据到redis）<ul>
<li><strong>更新DB再更新缓存、更新缓存再更新db</strong>：<ol>
<li>同时更新时顺序问题  </li>
<li>多次更新时重复无效的更新</li>
<li>此外更新缓存再更新db，如果更新db失败，缓存不好回滚</li>
</ol>
</li>
<li><strong>删除缓存再更新db</strong>：A删完缓存来了查询B，B查询完成后写入脏数据到redis</li>
</ul>
</li>
<li>延时双删：先更新DB再删除缓存，再异步删除   （实际上网上资料都是先删除缓存再更新DB，再异步删除）</li>
<li>缓存永不过期，并且周期性全量刷新</li>
</ol>
<h3 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h3><p>DB的访问做读写分离，写在主，binlog等方式同步到从</p>
<p><strong>一致性问题</strong>：</p>
<ul>
<li><p>大部分时间忽略</p>
</li>
<li><p>前端直接短暂延时</p>
</li>
<li><p>强一致场景强制读主</p>
</li>
<li><p>路由标记，引入了一个标记（过期时间大于同步时间）作为同步标记，会导致多一次读缓存，巧妙但不推荐</p>
<img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240120191525962.png" srcset="/img/loading.gif" lazyload alt="image-20240120191525962" style="zoom:67%;" /></li>
</ul>
<h3 id="并发"><a href="#并发" class="headerlink" title="并发"></a>并发</h3><p>一个通用的思路，针对性能问题通用解决方案</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240120191900959.png" srcset="/img/loading.gif" lazyload alt="image-20240120191900959"></p>
<h3 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h3><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240120192137793.png" srcset="/img/loading.gif" lazyload alt="image-20240120192137793"></p>
<p>其实就是之前提到的转载后的打点使用异步线程池实现，主线程直接返回</p>
<h3 id="产品设计"><a href="#产品设计" class="headerlink" title="产品设计"></a>产品设计</h3><ul>
<li>分页</li>
<li>递进展示</li>
<li>降低极致的准确性要求，允许短暂的不一致</li>
<li>峰值流量降级非重要功能</li>
<li>控制主动（点击重试）或被动（超时重试）重试</li>
</ul>
<p>其他    优化协议、流量拦截、静态缓存、数据压缩等等</p>
<h2 id="9-写性能难提升（性能）"><a href="#9-写性能难提升（性能）" class="headerlink" title="9.写性能难提升（性能）"></a>9.写性能难提升（性能）</h2><p>为什么难？</p>
<ol>
<li>写的<strong>丢失代价</strong>大</li>
<li>写<strong>必须要磁盘</strong>（可靠性场景），而读可以是缓存</li>
<li>写时常需要<strong>加锁</strong></li>
<li><strong>资损</strong></li>
</ol>
<h3 id="选择数据库"><a href="#选择数据库" class="headerlink" title="选择数据库"></a>选择数据库</h3><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240121204714055.png" srcset="/img/loading.gif" lazyload alt="image-20240121204714055"></p>
<h3 id="合理加锁"><a href="#合理加锁" class="headerlink" title="合理加锁"></a>合理加锁</h3><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240121205243774.png" srcset="/img/loading.gif" lazyload alt="image-20240121205243774"></p>
<h3 id="异步-1"><a href="#异步-1" class="headerlink" title="异步"></a>异步</h3><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240121222045378.png" srcset="/img/loading.gif" lazyload alt="image-20240121222045378"></p>
<p>优化方案的轮询是查询缓存的，放置数据库压力过大</p>
<p>TODO：添加一个<strong>缓存标记</strong>，可以用在判题请求中，这样轮询时就不用查询数据库</p>
<h3 id="批量插入"><a href="#批量插入" class="headerlink" title="批量插入"></a>批量插入</h3><ul>
<li><p>db批量操作快、减少加锁释放锁时间</p>
</li>
<li><p>缺点：更新存在延时<img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240121222926648.png" srcset="/img/loading.gif" lazyload alt="image-20240121222926648"></p>
</li>
<li><p>方案二（<strong>缓冲记账</strong>）引入了流水数据库表，实现持久化了数据但不用加锁</p>
</li>
</ul>
<h3 id="文件"><a href="#文件" class="headerlink" title="文件"></a>文件</h3><p><strong>文件系统的写入通常比数据库写入要快</strong>，之后再把文件同步到db，同步时可以使用拆分思想并发处理</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240121223503832.png" srcset="/img/loading.gif" lazyload alt="image-20240121223503832"></p>
<h3 id="缓存-1"><a href="#缓存-1" class="headerlink" title="缓存"></a>缓存</h3><p>并不需要百分百正确，缓存挂了就捞取redis自带的持久化数据，或者自己定时任务捞取缓存持久化到数据库</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240121223646419.png" srcset="/img/loading.gif" lazyload alt="image-20240121223646419"></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240121224327937.png" srcset="/img/loading.gif" lazyload alt="image-20240121224327937"></p>
<h2 id="10-稳定性引入"><a href="#10-稳定性引入" class="headerlink" title="10.稳定性引入"></a>10.稳定性引入</h2><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240121225347286.png" srcset="/img/loading.gif" lazyload alt="image-20240121225347286"></p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240121225544326.png" srcset="/img/loading.gif" lazyload alt="image-20240121225544326"></p>
<p>核心服务4个9：52.6 mins 一年不可用时间</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240121231622560.png" srcset="/img/loading.gif" lazyload alt="image-20240121231622560"></p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240121231642209.png" srcset="/img/loading.gif" lazyload alt="image-20240121231642209"></p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240121231724254.png" srcset="/img/loading.gif" lazyload alt="image-20240121231724254"></p>
<h3 id="总结引入"><a href="#总结引入" class="headerlink" title="总结引入"></a>总结引入</h3><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240121232021199.png" srcset="/img/loading.gif" lazyload alt="image-20240121232021199"></p>
<h2 id="11-稳定性之设计时"><a href="#11-稳定性之设计时" class="headerlink" title="11.稳定性之设计时"></a>11.稳定性之设计时</h2><h3 id="幂等"><a href="#幂等" class="headerlink" title="幂等"></a>幂等</h3><ol>
<li><p>请求携带唯一ID（可以前端生成也可也后端生成返回）</p>
</li>
<li><p>后端流水数据库唯一ID key，业务前需要先落库流水数据库实现幂等</p>
</li>
<li><p>更进一步，添加分布式锁</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240122122058300.png" srcset="/img/loading.gif" lazyload alt="image-20240122122058300"></p>
</li>
</ol>
<h3 id="隔离"><a href="#隔离" class="headerlink" title="隔离"></a>隔离</h3><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240122123053045.png" srcset="/img/loading.gif" lazyload alt="image-20240122123053045"></p>
<h3 id="降级"><a href="#降级" class="headerlink" title="降级"></a>降级</h3><p>避免被下游影响；强依赖变成弱依赖，账单服务失败不能影响查询余额接口；</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240122123255388.png" srcset="/img/loading.gif" lazyload alt="image-20240122123255388"></p>
<ol>
<li>前端直接拆分成两个请求</li>
<li>直接try catch，这里还是会对下游发起请求，如果下游返回时间比较长，还需要等待</li>
<li>通过配置中心（一般会缓存到本地，配置变更再推送），根据配置决定是否请求</li>
</ol>
<h3 id="流控"><a href="#流控" class="headerlink" title="流控"></a>流控</h3><p>避免被上游影响</p>
<ul>
<li>限制流量</li>
<li>控制速度</li>
</ul>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240122123755636.png" srcset="/img/loading.gif" lazyload alt="image-20240122123755636"></p>
<h3 id="一致性"><a href="#一致性" class="headerlink" title="一致性"></a>一致性</h3><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240122124816983.png" srcset="/img/loading.gif" lazyload alt="image-20240122124816983"></p>
<h3 id="兼容性"><a href="#兼容性" class="headerlink" title="兼容性"></a>兼容性</h3><p>旧接口进行了改造，字段发生了变化</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240122124959078.png" srcset="/img/loading.gif" lazyload alt="image-20240122124959078"></p>
<p><strong>标准方法</strong>：后端逻辑需要<strong>兼容旧逻辑</strong>，前端字段冗余，新旧逻辑都要传递；之后定时清理</p>
<p>因此在该变更场景中，实际上是先新增一个字段，再清理时删除原字段</p>
<h3 id="打日志"><a href="#打日志" class="headerlink" title="打日志"></a>打日志</h3><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240122130621494.png" srcset="/img/loading.gif" lazyload alt="image-20240122130621494"></p>
<ul>
<li>可以接受的错误，存在降级策略：warn</li>
<li>预期之外、会终端流程：error</li>
<li>大厂最佳实践通常是异步打印日志：磁盘 -&gt; 发送到队列，由别的线程负责</li>
</ul>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240124152012901.png" srcset="/img/loading.gif" lazyload alt="image-20240124152012901"></p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240124154346120.png" srcset="/img/loading.gif" lazyload alt="image-20240124154346120"></p>
<h4 id="摘要日志"><a href="#摘要日志" class="headerlink" title="摘要日志"></a>摘要日志</h4><p>可以结合工具做统计，可视化等</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240124154157858.png" srcset="/img/loading.gif" lazyload alt="image-20240124154157858"></p>
<h2 id="12-稳定性之变更时"><a href="#12-稳定性之变更时" class="headerlink" title="12.稳定性之变更时"></a>12.稳定性之变更时</h2><p>升级产品功能、修复产品缺陷；80%故障</p>
<ul>
<li>代码发布</li>
<li>配置变更</li>
<li>数据库修改</li>
<li>库表变化</li>
</ul>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240122132115071.png" srcset="/img/loading.gif" lazyload alt="image-20240122132115071"></p>
<p>兼容性和前面说的类似，<strong>下游同时兼容上游新旧代码</strong>  a调用b：a旧-b新、a新-b新、甚至于a新-b旧</p>
<h3 id="对比流量"><a href="#对比流量" class="headerlink" title="对比流量"></a>对比流量</h3><h4 id="流量复制"><a href="#流量复制" class="headerlink" title="流量复制"></a>流量复制</h4><p>预发布环境DB、Cache相同，因此只能针对读服务</p>
<ul>
<li>方法1. 线上在业务执行完成后转发到预发布环境，存在入侵</li>
<li>方法2. 在网关同时转发到两个环境</li>
</ul>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240122133710703.png" srcset="/img/loading.gif" lazyload alt="image-20240122133710703"></p>
<h4 id="线下环境流量回放"><a href="#线下环境流量回放" class="headerlink" title="线下环境流量回放"></a>线下环境流量回放</h4><ul>
<li>将请求、RPC、中间件、DB都录制（框架实现线上录制功能，如果让你设计这个框架，如何实现？）</li>
<li>回放时全部mock掉</li>
</ul>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240122134112992.png" srcset="/img/loading.gif" lazyload alt="image-20240122134112992"></p>
<h3 id="发布顺序"><a href="#发布顺序" class="headerlink" title="发布顺序"></a>发布顺序</h3><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240122134845701.png" srcset="/img/loading.gif" lazyload alt="image-20240122134845701"></p>
<h3 id="容量评估（压测）"><a href="#容量评估（压测）" class="headerlink" title="容量评估（压测）"></a>容量评估（压测）</h3><p>唯一方法：压测</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240122135140022.png" srcset="/img/loading.gif" lazyload alt="image-20240122135140022"></p>
<h3 id="可监控"><a href="#可监控" class="headerlink" title="可监控"></a>可监控</h3><p>埋点、日志、异常、机器指标、成功率、RT</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240122135710503.png" srcset="/img/loading.gif" lazyload alt="image-20240122135710503"></p>
<h3 id="可灰度"><a href="#可灰度" class="headerlink" title="可灰度"></a>可灰度</h3><p>变更逐步生效</p>
<p>实现灰度：用户ID后两位</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240122140351961.png" srcset="/img/loading.gif" lazyload alt="image-20240122140351961"></p>
<h4 id="陷阱"><a href="#陷阱" class="headerlink" title="陷阱"></a>陷阱</h4><p>开关变量实现灰度，多次请求中途变更了开关</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240122140557705.png" srcset="/img/loading.gif" lazyload alt="image-20240122140557705"></p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240122140708294.png" srcset="/img/loading.gif" lazyload alt="image-20240122140708294"></p>
<h3 id="可回滚"><a href="#可回滚" class="headerlink" title="可回滚"></a>可回滚</h3><p>回滚不难，如何快速回滚，并且有时候存在新数据了，旧代码是否能够兼容或者数据回滚</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240122141222095.png" srcset="/img/loading.gif" lazyload alt="image-20240122141222095"></p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240122141402267.png" srcset="/img/loading.gif" lazyload alt="image-20240122141402267"></p>
<h2 id="13-稳定性之运行时"><a href="#13-稳定性之运行时" class="headerlink" title="13.稳定性之运行时"></a>13.稳定性之运行时</h2><p>跑着跑着出错了；真正故障时能做的事情很少，重点需要前期准备好</p>
<h3 id="监控-报警"><a href="#监控-报警" class="headerlink" title="监控+报警"></a>监控+报警</h3><p>包含日志的采集 &amp; 报警</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240122163959159.png" srcset="/img/loading.gif" lazyload alt="image-20240122163959159"></p>
<h3 id="主动探测"><a href="#主动探测" class="headerlink" title="主动探测"></a>主动探测</h3><p>主动模拟请求，周期性执行</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240122164316168.png" srcset="/img/loading.gif" lazyload alt="image-20240122164316168"></p>
<h3 id="对账系统"><a href="#对账系统" class="headerlink" title="对账系统"></a>对账系统</h3><p><a target="_blank" rel="noopener" href="https://tech.meituan.com/2018/03/21/balance-accounts.html">美团配送资金安全治理之对账体系建设 - 美团技术团队 (meituan.com)</a></p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240122164445756.png" srcset="/img/loading.gif" lazyload alt="image-20240122164445756"></p>
<h4 id="实时"><a href="#实时" class="headerlink" title="实时"></a>实时</h4><ul>
<li>植入到链路中，失败立马进行拦截</li>
<li>影响核心链路性能</li>
</ul>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240122164531241.png" srcset="/img/loading.gif" lazyload alt="image-20240122164531241"></p>
<h4 id="准实时"><a href="#准实时" class="headerlink" title="准实时"></a>准实时</h4><ul>
<li>通过异步发送消息或者监听binlog</li>
</ul>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240122164731540.png" srcset="/img/loading.gif" lazyload alt="image-20240122164731540"></p>
<h4 id="离线"><a href="#离线" class="headerlink" title="离线"></a>离线</h4><p>定时拉取数据并做校验</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240122164920770.png" srcset="/img/loading.gif" lazyload alt="image-20240122164920770"></p>
<h3 id="分布式trance"><a href="#分布式trance" class="headerlink" title="分布式trance"></a>分布式trance</h3><p>还原链路的调用关系</p>
<h3 id=""><a href="#" class="headerlink" title=""></a><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240122165049137.png" srcset="/img/loading.gif" lazyload alt="image-20240122165049137"></h3><h2 id="14-错误处理显真功（细节）"><a href="#14-错误处理显真功（细节）" class="headerlink" title="14.错误处理显真功（细节）"></a>14.错误处理显真功（细节）</h2><p>某些因素导致流程没有按照预期执行完成</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240123151905647.png" srcset="/img/loading.gif" lazyload alt="image-20240123151905647"></p>
<h3 id="引入-1"><a href="#引入-1" class="headerlink" title="引入"></a>引入</h3><ul>
<li>入参校验（电话、金额）</li>
<li>中间用户信息结果判断</li>
<li>业务返回判断</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> TransferResponse <span class="hljs-title function_">transfer</span><span class="hljs-params">(Transferparam transferparam)</span> &#123;<br>    <span class="hljs-comment">// 1.查询用户信息并校验</span><br>    <span class="hljs-type">UserInfoResult</span> <span class="hljs-variable">payerUserInfoResult</span> <span class="hljs-operator">=</span> userInfoService.queryUserInfo(transferParam.getPayerPhoneNo());<br>    <span class="hljs-type">UserInfoResult</span> <span class="hljs-variable">payeeUserInfoResult</span> <span class="hljs-operator">=</span> userInfoService.queryUserInfo(transferParam.getPayeePhoneNo());<br><br>    <span class="hljs-comment">// 2.转账</span><br>    <span class="hljs-type">TransferRequest</span> <span class="hljs-variable">transferRequest</span> <span class="hljs-operator">=</span> TransferRequest.builder()<br>        .payerId(payerUserInfoResult.getData().getUserId())<br>        .payeeId(payeeUserInfoResult.getData().getUserId())<br>        .money(transferParam.getMoney())<br>        .build(); <br>    transferService.transfer(transferRequest);<br><br>    <span class="hljs-comment">// 3. 记录额度</span><br>    quatoService.recordQuato(payerUserInfoResult.getData().getUserId(), transferParam.getMoney());<br><br>    <span class="hljs-keyword">return</span> TransferResponse.builder().retCode(SUCCESS_CODE).build();<br>&#125;<br><br><span class="hljs-keyword">public</span> TransferResponse <span class="hljs-title function_">transfer</span><span class="hljs-params">(Transferparam transferparam)</span> &#123;<br>    <span class="hljs-comment">// 输入参数校验</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">payerPhoneNo</span> <span class="hljs-operator">=</span> transferParam.getPayerPhoneNo();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">payeePhoneNo</span> <span class="hljs-operator">=</span> transferParam.getPayeePhoneNo();<br>    <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">money</span> <span class="hljs-operator">=</span> transferParam.getMoney();<br><br>    <span class="hljs-keyword">if</span> (!isValidPhoneNo(payerPhoneNo) || !isValidPhoneNo(payeePhoneNo)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Invalid phone number&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (money == <span class="hljs-literal">null</span> || money.compareTo(BigDecimal.ZERO) &lt;= <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Invalid transfer amount&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 1.查询用户信息并校验</span><br>    <span class="hljs-type">UserInfoResult</span> <span class="hljs-variable">payerUserInfoResult</span> <span class="hljs-operator">=</span> userInfoService.queryUserInfo(payerPhoneNo);<br>    <span class="hljs-type">UserInfoResult</span> <span class="hljs-variable">payeeUserInfoResult</span> <span class="hljs-operator">=</span> userInfoService.queryUserInfo(payeePhoneNo);<br><br>    <span class="hljs-keyword">if</span> (payerUserInfoResult == <span class="hljs-literal">null</span> || payerUserInfoResult.getData() == <span class="hljs-literal">null</span> || payeeUserInfoResult == <span class="hljs-literal">null</span> || payeeUserInfoResult.getData() == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Invalid user information&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 2.转账</span><br>    <span class="hljs-type">TransferRequest</span> <span class="hljs-variable">transferRequest</span> <span class="hljs-operator">=</span> TransferRequest.builder()<br>        .payerId(payerUserInfoResult.getData().getUserId())<br>        .payeeId(payeeUserInfoResult.getData().getUserId())<br>        .money(money)<br>        .build(); <br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">transferResult</span> <span class="hljs-operator">=</span> transferService.transfer(transferRequest);<br><br>    <span class="hljs-keyword">if</span> (!transferResult) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Transfer failed&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 3. 记录额度</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">recordResult</span> <span class="hljs-operator">=</span> quatoService.recordQuato(payerUserInfoResult.getData().getUserId(), money);<br><br>    <span class="hljs-keyword">if</span> (!recordResult) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Failed to record quota&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> TransferResponse.builder().retCode(SUCCESS_CODE).build();<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="错误处理方式"><a href="#错误处理方式" class="headerlink" title="错误处理方式"></a>错误处理方式</h3><ul>
<li>返回<strong>错误码</strong> 可以包含更加复杂的信息；无性能损耗</li>
<li><strong>抛出异常</strong>  写起来简单 （目前主流rpc都支持异常传递）</li>
<li>都无法用于异步场景！</li>
</ul>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240123144451520.png" srcset="/img/loading.gif" lazyload alt="image-20240123144451520"></p>
<p><strong>推荐</strong>：系统内使用中断，PRC接口交互错误码</p>
<h3 id="异步异常"><a href="#异步异常" class="headerlink" title="异步异常"></a>异步异常</h3><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240123145901501.png" srcset="/img/loading.gif" lazyload alt="image-20240123145901501"></p>
<h3 id="错误码设计"><a href="#错误码设计" class="headerlink" title="错误码设计"></a>错误码设计</h3><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240123152917587.png" srcset="/img/loading.gif" lazyload alt="image-20240123152917587"></p>
<p>这里是代码写死，也可也配置中心配置</p>
<h3 id="异常设计方式"><a href="#异常设计方式" class="headerlink" title="异常设计方式"></a>异常设计方式</h3><p>CommonException+枚举</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240123152134856.png" srcset="/img/loading.gif" lazyload alt="image-20240123152134856"></p>
<p>各种不同异常+上面：可以通过异常类型进行不同处理（降级等）</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240123152341699.png" srcset="/img/loading.gif" lazyload alt="image-20240123152341699"></p>
<h3 id="异常映射错误码"><a href="#异常映射错误码" class="headerlink" title="异常映射错误码"></a>异常映射错误码</h3><p>由于内部是使用异常，返回给上游是状态码，最后需要catch将异常转换为外部状态码</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240123153212173.png" srcset="/img/loading.gif" lazyload alt="image-20240123153212173"></p>
<ul>
<li><p>不要吃掉异常，一定要打日志</p>
</li>
<li><p>调用方不要感知错误码，否则沟通更新成本高，需要和全部上游对齐</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240123153725656.png" srcset="/img/loading.gif" lazyload alt="image-20240123153725656"></p>
</li>
</ul>
<h2 id="15-打日志是技术活"><a href="#15-打日志是技术活" class="headerlink" title="15.打日志是技术活"></a>15.打日志是技术活</h2><p><a href="#%E6%89%93%E6%97%A5%E5%BF%97">打日志</a></p>
<h2 id="16-技术文档"><a href="#16-技术文档" class="headerlink" title="16.技术文档"></a>16.技术文档</h2><p>目的：</p>
<ul>
<li>确保方案可行</li>
<li>提早识别风险</li>
<li>对齐系统修改</li>
<li>评估工时投入</li>
</ul>
<h3 id="金币提现场景"><a href="#金币提现场景" class="headerlink" title="金币提现场景"></a>金币提现场景</h3><p><a target="_blank" rel="noopener" href="https://www.yuque.com/codingbetterlife/lession/pka2nhb3yqoiqbhl?singleDoc">https://www.yuque.com/codingbetterlife/lession/pka2nhb3yqoiqbhl?singleDoc</a><br>密码：wsg3</p>
<h4 id="功能描述"><a href="#功能描述" class="headerlink" title="功能描述"></a>功能描述</h4><p>功能点：用户提现金币到银行卡，有每天的限额</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240125134907012.png" srcset="/img/loading.gif" lazyload alt="image-20240125134907012"></p>
<ul>
<li>页面展示：总金币、可提现金币、额度、银行卡</li>
<li>准备提现：输入金额，并调取后端查询收费</li>
<li>确认提现：扣减金币到银行卡</li>
</ul>
<h4 id="核心流程"><a href="#核心流程" class="headerlink" title="核心流程"></a>核心流程</h4><p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240125134931139.png" srcset="/img/loading.gif" lazyload alt="image-20240125134931139"></p>
<p>其中具体的每一个具体服务使用流程引擎实现</p>
<p><img src="https://proxy.bytewaver.top/proxy/raw.githubusercontent.com/Goinggoinggoing/image/main/blogimg/image-20240125135035515.png" srcset="/img/loading.gif" lazyload alt="image-20240125135035515"></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/" class="category-chain-item">系统架构</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/java/" class="print-no-link">#java</a>
      
        <a href="/tags/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/" class="print-no-link">#系统架构</a>
      
        <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="print-no-link">#设计模式</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/03/01/%E8%80%83%E8%AF%95%E5%8E%8B%E6%B5%8B%E5%8F%8A%E7%93%B6%E9%A2%88%E6%8E%92%E6%9F%A5/" title="考试压测及瓶颈排查">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">考试压测及瓶颈排查</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/12/27/TechDigest/%E9%AB%98%E6%80%A7%E8%83%BD%E7%9F%AD%E9%93%BE%E8%AE%BE%E8%AE%A1/" title="高性能短链设计">
                        <span class="hidden-mobile">高性能短链设计</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="waline"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#waline', function() {
      Fluid.utils.createCssLink('https://lib.baomitu.com/waline/2.14.1/waline.css')
      Fluid.utils.createScript('https://lib.baomitu.com/waline/2.14.1/waline.js', function() {
        var options = Object.assign(
          {"serverURL":"https://comment.bytewaver.top/","path":"window.location.pathname","meta":["nick","mail","link"],"requiredMeta":["nick"],"lang":"zh-CN","emoji":["https://cdn.jsdelivr.net/gh/walinejs/emojis/weibo"],"dark":"html[data-user-color-scheme=\"dark\"]","wordLimit":0,"pageSize":10,"reaction":true},
          {
            el: '#waline',
            path: window.location.pathname
          }
        )
        Waline.init(options);
        Fluid.utils.waitElementVisible('#waline .vcontent', () => {
          var imgSelector = '#waline .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>
  </div>
</div>





  



  



  



  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
